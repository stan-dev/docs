<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stan Reference Manual</title>
  <meta name="description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Stan Reference Manual" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://mc-stan.org/users/documentation" />
  <meta property="og:image" content="http://mc-stan.org/users/documentationimg/logo_tm.png" />
  <meta property="og:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  <meta name="github-repo" content="stan-dev/stan" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Stan Reference Manual" />
  <meta name="twitter:site" content="@mc-stan" />
  <meta name="twitter:description" content="Stan reference manual specifying the syntax and semantics of the Stan programming language." />
  <meta name="twitter:image" content="http://mc-stan.org/users/documentationimg/logo_tm.png" />

<meta name="author" content="Stan Development Team">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="analysis-chapter.html">
<link rel="next" href="vi-algorithms-chapter.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="../stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em">Stan Reference Manual</li>

<li class="divider"></li>
<li><a href="index.html#overview"><i style="font-size: 110%; padding:1.5em 0 0 0; color:#990017;">Overview</i></a></li>
<li><a href="language.html#language"><i style="font-size: 110%; color:#990017;">Language</i></a></li>
<li class="chapter" data-level="1" data-path="character-encoding.html"><a href="character-encoding.html"><i class="fa fa-check"></i><b>1</b> Character Encoding</a></li>
<li class="chapter" data-level="2" data-path="includes-section.html"><a href="includes-section.html"><i class="fa fa-check"></i><b>2</b> Includes</a></li>
<li class="chapter" data-level="3" data-path="comments-section.html"><a href="comments-section.html"><i class="fa fa-check"></i><b>3</b> Comments</a></li>
<li class="chapter" data-level="4" data-path="whitespace.html"><a href="whitespace.html"><i class="fa fa-check"></i><b>4</b> Whitespace</a></li>
<li class="chapter" data-level="5" data-path="data-types-chapter.html"><a href="data-types-chapter.html"><i class="fa fa-check"></i><b>5</b> Data Types and Declarations</a></li>
<li class="chapter" data-level="6" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>6</b> Expressions</a></li>
<li class="chapter" data-level="7" data-path="statements.html"><a href="statements.html"><i class="fa fa-check"></i><b>7</b> Statements</a></li>
<li class="chapter" data-level="8" data-path="blocks-chapter.html"><a href="blocks-chapter.html"><i class="fa fa-check"></i><b>8</b> Program Blocks</a></li>
<li class="chapter" data-level="9" data-path="functions-chapter.html"><a href="functions-chapter.html"><i class="fa fa-check"></i><b>9</b> User-Defined Functions</a></li>
<li class="chapter" data-level="10" data-path="variable-transforms-chapter.html"><a href="variable-transforms-chapter.html"><i class="fa fa-check"></i><b>10</b> Constraint Transforms</a></li>
<li class="chapter" data-level="11" data-path="language-syntax.html"><a href="language-syntax.html"><i class="fa fa-check"></i><b>11</b> Language Syntax</a></li>
<li class="chapter" data-level="12" data-path="program-execution.html"><a href="program-execution.html"><i class="fa fa-check"></i><b>12</b> Program Execution</a></li>
<li class="chapter" data-level="13" data-path="deprecated-features-appendix.html"><a href="deprecated-features-appendix.html"><i class="fa fa-check"></i><b>13</b> Deprecated Features</a></li>
<li><a href="algorithms.html#algorithms"><i style="font-size: 110%; color:#990017;">Algorithms</i></a></li>
<li class="chapter" data-level="14" data-path="hmc-chapter.html"><a href="hmc-chapter.html"><i class="fa fa-check"></i><b>14</b> MCMC Sampling</a></li>
<li class="chapter" data-level="15" data-path="analysis-chapter.html"><a href="analysis-chapter.html"><i class="fa fa-check"></i><b>15</b> Posterior Analysis</a></li>
<li class="chapter" data-level="16" data-path="optimization-algorithms-chapter.html"><a href="optimization-algorithms-chapter.html"><i class="fa fa-check"></i><b>16</b> Optimization</a></li>
<li class="chapter" data-level="17" data-path="vi-algorithms-chapter.html"><a href="vi-algorithms-chapter.html"><i class="fa fa-check"></i><b>17</b> Variational Inference</a></li>
<li class="chapter" data-level="18" data-path="diagnostic-algorithms-chapter.html"><a href="diagnostic-algorithms-chapter.html"><i class="fa fa-check"></i><b>18</b> Diagnostic Mode</a></li>
<li><a href="usage.html#usage"><i style="font-size: 110%; color:#990017;">Usage</i></a></li>
<li class="chapter" data-level="19" data-path="reproducibility-chapter.html"><a href="reproducibility-chapter.html"><i class="fa fa-check"></i><b>19</b> Reproducibility</a></li>
<li class="chapter" data-level="20" data-path="licensing-appendix.html"><a href="licensing-appendix.html"><i class="fa fa-check"></i><b>20</b> Licenses and Dependencies</a></li>
<li><a href="references.html#references"><i style="font-size: 110%; color:#990017;">References</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan Reference Manual</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="optimization-algorithms.chapter" class="section level1">
<h1><span class="header-section-number">16</span> Optimization</h1>
<p>Stan provides optimization algorithms which find modes of the density
specified by a Stan program. Such modes may be used as parameter
estimates or as the basis of approximations to a Bayesian posterior.</p>
<p>Stan provides three different optimizers, a Newton optimizer, and two
related quasi-Newton algorithms, BFGS and L-BFGS; see
<span class="citation">Nocedal and Wright (<a href="#ref-NocedalWright:2006">2006</a>)</span> for thorough description and analysis of
all of these algorithms. The L-BFGS algorithm is the default
optimizer. Newton’s method is the least efficient of the three, but
has the advantage of setting its own stepsize.</p>
<div id="general-configuration" class="section level2">
<h2><span class="header-section-number">16.1</span> General Configuration</h2>
<p>All of the optimizers are iterative and allow the maximum number of
iterations to be specified; the default maximum number of iterations
is 2000.</p>
<p>All of the optimizers are able to stream intermediate output reporting
on their progress. Whether or not to save the intermediate iterations
and stream progress is configurable.</p>
</div>
<div id="bfgs-and-l-bfgs-configuration" class="section level2">
<h2><span class="header-section-number">16.2</span> BFGS and L-BFGS Configuration</h2>
<div id="convergence-monitoring" class="section level3 unnumbered">
<h3>Convergence Monitoring</h3>
<p>Convergence monitoring in (L-)BFGS is controlled by a number of
tolerance values, any one of which being satisfied causes the
algorithm to terminate with a solution. Any of the convergence tests
can be disabled by setting its corresponding tolerance parameter to
zero. The tests for convergence are as follows.</p>
<div id="parameter-convergence" class="section level4 unnumbered">
<h4>Parameter Convergence</h4>
<p>The parameters <span class="math inline">\(\theta_i\)</span> in iteration <span class="math inline">\(i\)</span> are considered to have
converged with respect to tolerance <code>tol_param</code> if</p>
<p><span class="math display">\[
|| \theta_{i} - \theta_{i-1} || &lt; \mathtt{tol\_param}.
\]</span></p>
</div>
<div id="density-convergence" class="section level4 unnumbered">
<h4>Density Convergence</h4>
<p>The (unnormalized) log density
<span class="math inline">\(\log p(\theta_{i}|y)\)</span> for the parameters <span class="math inline">\(\theta_i\)</span> in iteration <span class="math inline">\(i\)</span>
given data <span class="math inline">\(y\)</span> is considered to have converged with
respect to tolerance <code>tol_obj</code> if</p>
<p><span class="math display">\[
\left| \log p(\theta_{i}|y) - \log p(\theta_{i-1}|y) \right| &lt;
\mathtt{tol\_obj}.
\]</span></p>
<p>The log density is considered to have converged to within
relative tolerance <code>tol_rel_obj</code> if</p>
<p><span class="math display">\[
\frac{\left| \log p(\theta_{i}|y) - \log p(\theta_{i-1}|y) \right|}{\
  \max\left(\left| \log p(\theta_{i}|y)\right|,\left| \log
      p(\theta_{i-1}|y)\right|,1.0\right)}
 &lt; \mathtt{tol\_rel\_obj} * \epsilon.
\]</span></p>
</div>
<div id="gradient-convergence" class="section level4 unnumbered">
<h4>Gradient Convergence</h4>
<p>The gradient is considered to have converged to 0 relative to a
specified tolerance <code>tol_grad</code> if</p>
<p><span class="math display">\[
|| g_{i} || &lt; \mathtt{tol\_grad},
\]</span>
where <span class="math inline">\(\nabla_{\theta}\)</span> is the gradient operator with respect to
<span class="math inline">\(\theta\)</span> and <span class="math inline">\(g_{i} = \nabla_{\theta} \log p(\theta | y)\)</span> is the gradient at
iteration <span class="math inline">\(i\)</span> evaluated at <span class="math inline">\(\theta^{(i)}\)</span>, the value on the <span class="math inline">\(i\)</span>-th posterior iteration.</p>
<p>The gradient is considered to have converged to 0 relative to a
specified relative tolerance
<code>tol_rel_grad</code> if</p>
<p><span class="math display">\[
\frac{g_{i}^T \hat{H}_{i}^{-1} g_{i} }{ \max\left(\left|\log
p(\theta_{i}|y)\right|,1.0\right) }
\ &lt; \
\mathtt{tol\_rel\_grad} * \epsilon,
\]</span></p>
<p>where <span class="math inline">\(\hat{H}_{i}\)</span> is the estimate of the Hessian at iteration <span class="math inline">\(i\)</span>,
<span class="math inline">\(|u|\)</span> is the absolute value (L1 norm) of <span class="math inline">\(u\)</span>, <span class="math inline">\(||u||\)</span> is the vector
length (L2 norm) of <span class="math inline">\(u\)</span>, and <span class="math inline">\(\epsilon \approx 2e-16\)</span> is machine
precision.</p>
</div>
</div>
<div id="initial-step-size" class="section level3 unnumbered">
<h3>Initial Step Size</h3>
<p>The initial step size parameter <span class="math inline">\(\alpha\)</span> for BFGS-style optimizers may
be specified. If the first iteration takes a long time (and requires a
lot of function evaluations) initialize <span class="math inline">\(\alpha\)</span> to be the roughly
equal to the <span class="math inline">\(\alpha\)</span> used in that first iteration. The default value
is intentionally small, 0.001, which is reasonable for many problems
but might be too large or too small depending on the objective
function and initialization. Being too big or too small just means
that the first iteration will take longer (i.e., require more gradient
evaluations) before the line search finds a good step length. It’s not
a critical parameter, but for optimizing the same model multiple times
(as you tweak things or with different data), being able to tune
<span class="math inline">\(\alpha\)</span> can save some real time.</p>
</div>
<div id="l-bfgs-history-size" class="section level3 unnumbered">
<h3>L-BFGS History Size</h3>
<p>L-BFGS has a command-line argument which controls the size of the
history it uses to approximate the Hessian. The value should be less than
the dimensionality of the parameter space and, in general, relatively
small values (5–10) are sufficient; the default value is 5.</p>
<p>If L-BFGS performs poorly but BFGS performs well, consider increasing
the history size. Increasing history size will increase the
memory usage, although this is unlikely to be an issue for typical
Stan models.</p>
</div>
</div>
<div id="general-configuration-options" class="section level2">
<h2><span class="header-section-number">16.3</span> General Configuration Options</h2>
<p>The general configuration options for optimization are the same as
those for MCMC.</p>
</div>
<div id="writing-models-for-optimization" class="section level2">
<h2><span class="header-section-number">16.4</span> Writing Models for Optimization</h2>
<div id="constrained-vs.unconstrained-parameters" class="section level3 unnumbered">
<h3>Constrained vs. Unconstrained Parameters</h3>
<p>For constrained optimization problems, for instance, with a standard
deviation parameter <span class="math inline">\(\sigma\)</span> constrained so that <span class="math inline">\(\sigma &gt; 0\)</span>, it can
be much more efficient to declare a parameter <code>sigma</code> with no
constraints. This allows the optimizer to easily get close to 0
without having to tend toward <span class="math inline">\(-\infty\)</span> on the <span class="math inline">\(\log \sigma\)</span> scale.</p>
<p>The Jacobian adjustment is not an issue for posterior modes, because
Stan turns off the built-in Jacobian adjustments for optimization.</p>
<p>With unconstrained parameterizations of parameters with constrained
support, it is important to provide a custom initialization that is
within the support. For example, declaring a vector</p>
<pre><code>vector[M] sigma;</code></pre>
<p>and using the default random initialization which is
<span class="math inline">\(\mathsf{Uniform}(-2, 2)\)</span> on the unconstrained scale means that there
is only a <span class="math inline">\(2^{-M}\)</span> chance that the initialization will be within
support.</p>
<p>For any given optimization problem, it is probably worthwhile trying
the program both ways, with and without the constraint, to see which
one is more efficient.</p>

</div>
</div>
</div>
<h3><i style="font-size: 110%; color:#990017;">References</i></h3>
<div id="refs" class="references">
<div id="ref-NocedalWright:2006">
<p>Nocedal, Jorge, and Stephen J. Wright. 2006. <em>Numerical Optimization</em>. Second. Berlin: Springer-Verlag.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="analysis-chapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="vi-algorithms-chapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": false,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
