<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Expressions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../reference-manual/statements.html" rel="next">
<link href="../reference-manual/types.html" rel="prev">
<link href="../img/logo_tm.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 200,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../theming/quarto_styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/logo_tm.png" alt="Stan logo" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../stan-users-guide/index.html"> 
<span class="menu-text">Stan Users Guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../reference-manual/index.html" aria-current="page"> 
<span class="menu-text">Reference Manual</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../functions-reference/index.html"> 
<span class="menu-text">Functions Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-interfaces" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Interfaces</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-interfaces">    
        <li>
    <a class="dropdown-item" href="../cmdstan-guide/index.html">
 <span class="dropdown-text">CmdStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanpy">
 <span class="dropdown-text">CmdStanPy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanr">
 <span class="dropdown-text">CmdStanR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/users/interfaces/pystan.html">
 <span class="dropdown-text">PyStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstan">
 <span class="dropdown-text">RStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="http://stanjulia.github.io/Stan.jl/stable/INTRO/">
 <span class="dropdown-text">Stan.jl</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-other-packages" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Other Packages</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-other-packages">    
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/bayesplot/">
 <span class="dropdown-text">bayesplot</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://roualdes.github.io/bridgestan/latest/">
 <span class="dropdown-text">BridgeStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://paul-buerkner.github.io/brms/">
 <span class="dropdown-text">brms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/loo/">
 <span class="dropdown-text">loo</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/posterior">
 <span class="dropdown-text">posterior</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/projpred">
 <span class="dropdown-text">projpred</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstanarm">
 <span class="dropdown-text">rstanarm</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstantools">
 <span class="dropdown-text">rstantools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/shinystan">
 <span class="dropdown-text">shinystan</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/stan-dev" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://discourse.mc-stan.org" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-chat-text-fill"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../reference-manual/encoding.html">Language</a></li><li class="breadcrumb-item"><a href="../reference-manual/expressions.html">Expressions</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stan Reference Manual</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Version 2.35</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Language</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/encoding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Character Encoding</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/includes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Includes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/comments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/whitespace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Whitespace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Types and Declarations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/expressions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Expressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/statements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/blocks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Blocks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/user-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User-Defined Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Constraint Transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/syntax.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Language Syntax</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Execution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/deprecations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deprecated Features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/removals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Removed Features</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Algorithms</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCMC Sampling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Posterior Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/pathfinder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pathfinder</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/variational.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/laplace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laplace Approximation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagnostic Mode</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Usage</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/reproducibility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducibility</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/licenses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Licenses and Dependencies</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#expressions" id="toc-expressions" class="nav-link active" data-scroll-target="#expressions">Expressions</a>
  <ul class="collapse">
  <li><a href="#numeric-literals" id="toc-numeric-literals" class="nav-link" data-scroll-target="#numeric-literals">Numeric literals</a>
  <ul class="collapse">
  <li><a href="#integer-literals" id="toc-integer-literals" class="nav-link" data-scroll-target="#integer-literals">Integer literals</a></li>
  <li><a href="#real-literals" id="toc-real-literals" class="nav-link" data-scroll-target="#real-literals">Real literals</a></li>
  <li><a href="#imaginary-literals" id="toc-imaginary-literals" class="nav-link" data-scroll-target="#imaginary-literals">Imaginary literals</a></li>
  <li><a href="#complex-literals" id="toc-complex-literals" class="nav-link" data-scroll-target="#complex-literals">Complex literals</a></li>
  </ul></li>
  <li><a href="#variables.section" id="toc-variables.section" class="nav-link" data-scroll-target="#variables.section">Variables</a>
  <ul class="collapse">
  <li><a href="#reserved-names" id="toc-reserved-names" class="nav-link" data-scroll-target="#reserved-names">Reserved names</a></li>
  <li><a href="#legal-characters" id="toc-legal-characters" class="nav-link" data-scroll-target="#legal-characters">Legal characters</a></li>
  </ul></li>
  <li><a href="#vector-matrix-array-expressions.section" id="toc-vector-matrix-array-expressions.section" class="nav-link" data-scroll-target="#vector-matrix-array-expressions.section">Container expressions</a>
  <ul class="collapse">
  <li><a href="#vector-expressions" id="toc-vector-expressions" class="nav-link" data-scroll-target="#vector-expressions">Vector expressions</a></li>
  <li><a href="#matrix-expressions" id="toc-matrix-expressions" class="nav-link" data-scroll-target="#matrix-expressions">Matrix expressions</a></li>
  <li><a href="#complex-vector-and-matrix-expressions" id="toc-complex-vector-and-matrix-expressions" class="nav-link" data-scroll-target="#complex-vector-and-matrix-expressions">Complex vector and matrix expressions</a></li>
  <li><a href="#array-expressions" id="toc-array-expressions" class="nav-link" data-scroll-target="#array-expressions">Array expressions</a></li>
  <li><a href="#array-expression-types" id="toc-array-expression-types" class="nav-link" data-scroll-target="#array-expression-types">Array expression types</a></li>
  <li><a href="#tuple-expressions-and-types" id="toc-tuple-expressions-and-types" class="nav-link" data-scroll-target="#tuple-expressions-and-types">Tuple expressions and types</a></li>
  <li><a href="#restrictions-on-values" id="toc-restrictions-on-values" class="nav-link" data-scroll-target="#restrictions-on-values">Restrictions on values</a></li>
  </ul></li>
  <li><a href="#parentheses-for-grouping" id="toc-parentheses-for-grouping" class="nav-link" data-scroll-target="#parentheses-for-grouping">Parentheses for grouping</a></li>
  <li><a href="#arithmetic-expressions.section" id="toc-arithmetic-expressions.section" class="nav-link" data-scroll-target="#arithmetic-expressions.section">Arithmetic and matrix operations on expressions</a>
  <ul class="collapse">
  <li><a href="#operator-precedence-and-associativity" id="toc-operator-precedence-and-associativity" class="nav-link" data-scroll-target="#operator-precedence-and-associativity">Operator precedence and associativity</a></li>
  </ul></li>
  <li><a href="#conditional-operator.section" id="toc-conditional-operator.section" class="nav-link" data-scroll-target="#conditional-operator.section">Conditional operator</a>
  <ul class="collapse">
  <li><a href="#conditional-operator-syntax" id="toc-conditional-operator-syntax" class="nav-link" data-scroll-target="#conditional-operator-syntax">Conditional operator syntax</a></li>
  <li><a href="#conditional-operator-semantics" id="toc-conditional-operator-semantics" class="nav-link" data-scroll-target="#conditional-operator-semantics">Conditional operator semantics</a></li>
  </ul></li>
  <li><a href="#language-indexing.section" id="toc-language-indexing.section" class="nav-link" data-scroll-target="#language-indexing.section">Indexing</a>
  <ul class="collapse">
  <li><a href="#accessing-subarrays" id="toc-accessing-subarrays" class="nav-link" data-scroll-target="#accessing-subarrays">Accessing subarrays</a></li>
  <li><a href="#accessing-matrix-rows" id="toc-accessing-matrix-rows" class="nav-link" data-scroll-target="#accessing-matrix-rows">Accessing matrix rows</a></li>
  <li><a href="#mixing-array-and-vectormatrix-indexes" id="toc-mixing-array-and-vectormatrix-indexes" class="nav-link" data-scroll-target="#mixing-array-and-vectormatrix-indexes">Mixing array and vector/matrix indexes</a></li>
  </ul></li>
  <li><a href="#language-multi-indexing.section" id="toc-language-multi-indexing.section" class="nav-link" data-scroll-target="#language-multi-indexing.section">Multiple indexing and range indexing</a>
  <ul class="collapse">
  <li><a href="#multiple-index-semantics" id="toc-multiple-index-semantics" class="nav-link" data-scroll-target="#multiple-index-semantics">Multiple index semantics</a></li>
  </ul></li>
  <li><a href="#function-application.section" id="toc-function-application.section" class="nav-link" data-scroll-target="#function-application.section">Function application</a>
  <ul class="collapse">
  <li><a href="#type-signatures-and-result-type-inference" id="toc-type-signatures-and-result-type-inference" class="nav-link" data-scroll-target="#type-signatures-and-result-type-inference">Type signatures and result type inference</a></li>
  <li><a href="#constants" id="toc-constants" class="nav-link" data-scroll-target="#constants">Constants</a></li>
  <li><a href="#type-promotion-and-function-resolution" id="toc-type-promotion-and-function-resolution" class="nav-link" data-scroll-target="#type-promotion-and-function-resolution">Type promotion and function resolution</a></li>
  <li><a href="#random-number-generating-functions" id="toc-random-number-generating-functions" class="nav-link" data-scroll-target="#random-number-generating-functions">Random-number generating functions</a></li>
  </ul></li>
  <li><a href="#type-inference" id="toc-type-inference" class="nav-link" data-scroll-target="#type-inference">Type inference</a>
  <ul class="collapse">
  <li><a href="#implementation-types" id="toc-implementation-types" class="nav-link" data-scroll-target="#implementation-types">Implementation types</a></li>
  <li><a href="#type-inference-rules" id="toc-type-inference-rules" class="nav-link" data-scroll-target="#type-inference-rules">Type inference rules</a></li>
  <li><a href="#promotion" id="toc-promotion" class="nav-link" data-scroll-target="#promotion">Promotion</a></li>
  </ul></li>
  <li><a href="#higher-order-functions" id="toc-higher-order-functions" class="nav-link" data-scroll-target="#higher-order-functions">Higher-order functions</a>
  <ul class="collapse">
  <li><a href="#functions-passed-by-reference" id="toc-functions-passed-by-reference" class="nav-link" data-scroll-target="#functions-passed-by-reference">Functions passed by reference</a></li>
  <li><a href="#data-restricted-arguments" id="toc-data-restricted-arguments" class="nav-link" data-scroll-target="#data-restricted-arguments">Data-restricted arguments</a></li>
  </ul></li>
  <li><a href="#chain-rule-and-derivatives" id="toc-chain-rule-and-derivatives" class="nav-link" data-scroll-target="#chain-rule-and-derivatives">Chain rule and derivatives</a>
  <ul class="collapse">
  <li><a href="#errors-due-to-chain-rule" id="toc-errors-due-to-chain-rule" class="nav-link" data-scroll-target="#errors-due-to-chain-rule">Errors due to chain rule</a></li>
  <li><a href="#diagnosing-problems-with-derivatives" id="toc-diagnosing-problems-with-derivatives" class="nav-link" data-scroll-target="#diagnosing-problems-with-derivatives">Diagnosing problems with derivatives</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/expressions.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="expressions" class="level1">
<h1>Expressions</h1>
<p>An expression is the syntactic unit in a Stan program that denotes a value. Every expression in a well-formed Stan program has a type that is determined statically (at compile time), based only on the type of its variables and the types of the functions used in it. If an expressions type cannot be determined statically, the Stan compiler will report the location of the problem.</p>
<p>This chapter covers the syntax, typing, and usage of the various forms of expressions in Stan.</p>
<section id="numeric-literals" class="level2">
<h2 class="anchored" data-anchor-id="numeric-literals">Numeric literals</h2>
<p>The simplest form of expression is a literal that denotes a primitive numerical value.</p>
<section id="integer-literals" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="integer-literals">Integer literals</h3>
<p>Integer literals represent integers of type <code>int</code>. Integer literals are written in base 10 without any separators. Integer literals may contain a single negative sign. (The expression <code>--1</code> is interpreted as the negation of the literal <code>-1</code>.)</p>
<p>The following list contains well-formed integer literals.</p>
<pre><code>0, 1, -1, 256, -127098, 24567898765</code></pre>
<p>Integer literals must have values that fall within the bounds for integer values (see <a href="../reference-manual/types.html#numerical-data-types.section">the section on numerical data types</a>).</p>
<p>Integer literals may not contain decimal points (<code>.</code>). Thus the expressions <code>1.</code> and <code>1.0</code> are of type <code>real</code> and may not be used where a value of type <code>int</code> is required.</p>
</section>
<section id="real-literals" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="real-literals">Real literals</h3>
<p>A number written with a period or with scientific notation is assigned to a the continuous numeric type <code>real</code>. Real literals are written in base 10 with a period (<code>.</code>) as a separator and optionally an exponent with optional sign. Examples of well-formed real literals include the following.</p>
<pre><code>0.0, 1.0, 3.14, -217.9387, 2.7e3, -2E-5, 1.23e+3.</code></pre>
<p>The notation <code>e</code> or <code>E</code> followed by a positive or negative integer denotes a power of 10 to multiply. For instance, <code>2.7e3</code> and <code>2.7e+3</code> denote <span class="math inline">\(2.7 \times 10^3\)</span>, whereas <code>-2E-5</code> denotes <span class="math inline">\(-2 \times
10^{-5}\)</span>.</p>
</section>
<section id="imaginary-literals" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="imaginary-literals">Imaginary literals</h3>
<p>A number followed by the character <code>i</code> denotes an imaginary number and is assigned to the numeric type <code>complex</code>. The number preceding <code>i</code> may be either a real or integer literal and determines the magnitude of the imaginary number. Examples of well-formed imaginary literals include the following.</p>
<pre><code>1i, 2i, -325.786i, 1e10i, 2.87e-10i.</code></pre>
<p>Note that the character <code>i</code> by itself is <em>not</em> a well-formed imaginary literal. The unit imaginary number must be written as <code>1i</code>.</p>
</section>
<section id="complex-literals" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="complex-literals">Complex literals</h3>
<p>Stan does not include complex literals directly, but a real or integer literal can be added to an imaginary literal to derive an expression that behaves like a complex literal. Examples include the following.</p>
<pre><code>1 + 2i, -3.2e9 + 1e10i</code></pre>
<p>These will be assigned the type <code>complex</code>, which is the result of adding a real or integer and a complex number. They will also function like literals in the sense that the C++ compiler is able to reduce them to a single complex constant at compile time.</p>
</section>
</section>
<section id="variables.section" class="level2">
<h2 class="anchored" data-anchor-id="variables.section">Variables</h2>
<p>A variable by itself is a well-formed expression of the same type as the variable. Variables in Stan consist of ASCII strings containing only the basic lower-case and upper-case Roman letters, digits, and the underscore (<code>_</code>) character. Variables must start with a letter (<code>a--z</code> and <code>A--Z</code>) and may not end with two underscores (<code>__</code>).</p>
<p>Examples of legal variable identifiers are as follows.</p>
<pre><code>a, a3, a_3, Sigma, my_cpp_style_variable, myCamelCaseVariable</code></pre>
<p>Unlike in R and BUGS, variable identifiers in Stan may not contain a period character.</p>
<section id="reserved-names" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="reserved-names">Reserved names</h3>
<p>Stan reserves many strings for internal use and these may not be used as the name of a variable. An attempt to name a variable after an internal string results in the <code>stanc</code> translator halting with an error message indicating which reserved name was used and its location in the model code.</p>
<section id="model-name" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="model-name">Model name</h4>
<p>The name of the model cannot be used as a variable within the model. This is usually not a problem because the default in <code>bin/stanc</code> is to append <code>_model</code> to the name of the file containing the model specification. For example, if the model is in file <code>foo.stan</code>, it would not be legal to have a variable named <code>foo_model</code> when using the default model name through <code>bin/stanc</code>. With user-specified model names, variables cannot match the model.</p>
</section>
<section id="reserved-words-from-stan-language" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="reserved-words-from-stan-language">Reserved words from Stan language</h4>
<p>The following list contains reserved words for Stan’s programming language. Not all of these features are implemented in Stan yet, but the tokens are reserved for future use.</p>
<pre><code>for, in, while, repeat, until, if, then, else,
true, false, target, struct, typedef, export,
auto, extern, var, static, lower, upper, offset,
multiplier</code></pre>
<p>Variables should not be named after types, either, and thus may not be any of the following.</p>
<pre><code>int, real, complex, vector, simplex, unit_vector,
ordered, positive_ordered, row_vector, matrix,
cholesky_factor_corr, cholesky_factor_cov,
corr_matrix, cov_matrix, array</code></pre>
<p>The following built in functions are also reserved and cannot be used as variable names:</p>
<pre><code>print, reject, profile, fatal_error, target</code></pre>
<p>The following block identifiers are reserved and cannot be used as variable names:</p>
<pre><code>functions, model, data, parameters, quantities,
transformed, generated</code></pre>
</section>
<section id="reserved-distribution-names" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="reserved-distribution-names">Reserved distribution names</h4>
<p>Variable names will also conflict with the names of distributions suffixed with <code>_lpdf</code>, <code>_lpmf</code>, <code>_lcdf</code>, and <code>_lccdf</code>, <code>_cdf</code>, and <code>_ccdf</code>, such as <code>normal_lcdf_log</code>. No user-defined variable can take a name ending in <code>_lupdf</code> or <code>_lupmf</code> even if a corresponding <code>_lpdf</code> or <code>_lpmf</code> is not defined.</p>
<p>Using any of these variable names causes the <code>stanc</code> translator to halt and report the name and location of the variable causing the conflict.</p>
</section>
<section id="reserved-names-backend-languages" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="reserved-names-backend-languages">Reserved names backend languages</h4>
<p>Stan primarily generates code in C++, which features its own reserved words. It is legal to name a variable any of the following names, however doing so will lead to it being renamed <code>_stan_NAME</code> (e.g.&nbsp;<code>_stan_public</code>) behind the scenes (in the generated C++ code).</p>
<!-- corresponds to the list in stanc3/src/stan_math_backend/Mangle.ml -->
<pre><code>alignas, alignof, and, and_eq, asm, bitand, bitor, bool,
case, catch, char, char16_t, char32_t, class, compl, const,
constexpr, const_cast, decltype, default, delete, do,
double, dynamic_cast, enum, explicit, float, friend, goto,
inline, long, mutable, namespace, new, noexcept, not, not_eq,
nullptr, operator, or, or_eq, private, protected, public,
register, reinterpret_cast, short, signed, sizeof,
static_assert, static_cast, switch, template, this, thread_local,
throw, try, typeid, typename, union, unsigned, using, virtual,
volatile, wchar_t, xor, xor_eq, fvar, STAN_MAJOR, STAN_MINOR,
STAN_PATCH, STAN_MATH_MAJOR, STAN_MATH_MINOR, STAN_MATH_PATCH</code></pre>
</section>
</section>
<section id="legal-characters" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="legal-characters">Legal characters</h3>
<p>The legal characters for variable identifiers are given in the following table.</p>
<section id="identifier-characters-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="identifier-characters-table">Identifier Characters Table</h5>
<p><em>The alphanumeric characters and underscore in base ASCII are the only legal characters in Stan identifiers.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">characters</th>
<th style="text-align: center;">ASCII code points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>a -- z</code></td>
<td style="text-align: center;">97 – 122</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>A -- Z</code></td>
<td style="text-align: center;">65 – 90</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>0 -- 9</code></td>
<td style="text-align: center;">48 – 57</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>_</code></td>
<td style="text-align: center;">95</td>
</tr>
</tbody>
</table>
<p>Although not the most expressive character set, ASCII is the most portable and least prone to corruption through improper character encodings or decodings. Sticking to this range of ASCII makes Stan compatible with Latin-1 or UTF-8 encodings of these characters, which are byte-for-byte identical to ASCII.</p>
</section>
<section id="comments-allow-ascii-compatible-encoding" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="comments-allow-ascii-compatible-encoding">Comments allow ASCII-compatible encoding</h4>
<p>Within comments, Stan can work with any ASCII-compatible character encoding, such as ASCII itself, UTF-8, or Latin1. It is up to user shells and editors to display them properly.</p>
</section>
</section>
</section>
<section id="vector-matrix-array-expressions.section" class="level2">
<h2 class="anchored" data-anchor-id="vector-matrix-array-expressions.section">Container expressions</h2>
<p>Expressions for the Stan container objects, namely arrays, vectors, row vectors, matrices, and tuples, can all be constructed using expressions.</p>
<section id="vector-expressions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="vector-expressions">Vector expressions</h3>
<p>Square brackets may be wrapped around a sequence of comma separated primitive expressions to produce a row vector expression. For example, the expression <code>[ 1, 10, 100 ]</code> denotes a row vector of three elements with real values 1.0, 10.0, and 100.0. Applying the transpose operator to a row vector expression produces a vector expression. This syntax provides a way declare and define small vectors a single line, as follows.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">row_vector</span>[<span class="dv">2</span>] rv2 =  [ <span class="dv">1</span>, <span class="dv">2</span> ];</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">3</span>] v3 = [ <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span> ]';</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The vector expression values may be compound expressions or variable names, so it is legal to write <code>[ 2 * 3, 1 + 4]</code> or <code>[ x, y ]</code>, providing that <code>x</code> and <code>y</code> are primitive variables.</p>
</section>
<section id="matrix-expressions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="matrix-expressions">Matrix expressions</h3>
<p>A matrix expression consists of square brackets wrapped around a sequence of comma separated row vector expressions. This syntax provides a way declare and define a matrix in a single line, as follows.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">matrix</span>[<span class="dv">3</span>, <span class="dv">2</span>] m1 = [ [ <span class="dv">1</span>, <span class="dv">2</span> ], [ <span class="dv">3</span>, <span class="dv">4</span> ], [<span class="dv">5</span>, <span class="dv">6</span> ] ];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Any expression denoting a row vector can be used in a matrix expression. For example, the following code is valid:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">2</span>] vX = [ <span class="dv">1</span>, <span class="dv">10</span> ]';</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">row_vector</span>[<span class="dv">2</span>] vY = [ <span class="dv">100</span>, <span class="dv">1000</span> ];</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">matrix</span>[<span class="dv">3</span>, <span class="dv">2</span>] m2 = [ vX', vY, [ <span class="dv">1</span>, <span class="dv">2</span> ]  ];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="complex-vector-and-matrix-expressions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="complex-vector-and-matrix-expressions">Complex vector and matrix expressions</h3>
<p>Complex vector expressions work the same way as real vector expressions. For example, the following are all legal Stan expressions and assignments.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">complex_vector</span>[<span class="dv">3</span>] = [<span class="dv">1</span> + <span class="fl">2i</span>, <span class="dv">3</span> - <span class="fl">1.7i</span>, <span class="dv">0</span>]';</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">complex_row_vector</span>[<span class="dv">2</span>] = [<span class="dv">12</span>, -<span class="fl">2i</span>];</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dt">complex_matrix</span>[<span class="dv">2</span>, <span class="dv">3</span>] = [[<span class="dv">1</span> + <span class="fl">2i</span>, <span class="dv">3</span> - <span class="fl">1.7i</span>, <span class="dv">0</span>],</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                        [<span class="fl">3.9</span> - <span class="fl">1.234i</span>, <span class="fl">176i</span>, <span class="dv">1</span> + <span class="fl">1i</span>]];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="no-empty-vector-or-matrix-expressions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="no-empty-vector-or-matrix-expressions">No empty vector or matrix expressions</h4>
<p>The empty expression <code>[ ]</code> is ambiguous and therefore is not allowed and similarly expressions such as <code>[ [ ] ]</code> or <code>[ [ ], [ ] ]</code> are not allowed.</p>
</section>
</section>
<section id="array-expressions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="array-expressions">Array expressions</h3>
<p>Curly braces may be wrapped around a sequence of expressions to produce an array expression. For example, the expression <code>{ 1, 10, 100 }</code> denotes an integer array of three elements with values 1, 10, and 100. This syntax is particularly convenient to define small arrays in a single line, as follows.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">3</span>] <span class="dt">int</span> a = { <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">100</span> };</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The values may be compound expressions, so it is legal to write <code>{ 2 * 3, 1 + 4 }</code>. It is also possible to write two dimensional arrays directly, as in the following example.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>, <span class="dv">3</span>] <span class="dt">int</span> b = { { <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> }, { <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span> } };</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This way, <code>b[1]</code> is <code>{ 1, 2, 3 }</code> and <code>b[2]</code> is <code>{ 4, 5, 6 }</code>.</p>
<p>Whitespace is always interchangeable in Stan, so the above can be laid out as follows to more clearly indicate the row and column structure of the resulting two dimensional array.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>, <span class="dv">3</span>] <span class="dt">int</span> b = { { <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> },</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                { <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span> } };</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="array-expression-types" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="array-expression-types">Array expression types</h3>
<p>Any type of expression may be used within braces to form an array expression. In the simplest case, all of the elements will be of the same type and the result will be an array of elements of that type. For example, the elements of the array can be vectors, in which case the result is an array of vectors.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">3</span>] b;</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">3</span>] c;</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>] <span class="dt">vector</span>[<span class="dv">3</span>] d = { b, c };</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The elements may also be a mixture of <code>int</code> and <code>real</code> typed expressions, in which case the result is an array of real values.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>] <span class="dt">real</span> b = { <span class="dv">1</span>, <span class="fl">1.9</span> };</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tuple-expressions-and-types" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="tuple-expressions-and-types">Tuple expressions and types</h3>
<p>Stan uses parentheses around a comma-separated sequence of expressions to construct a tuple. For example, we can construct a 2-tuple as follows.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">tuple</span>(<span class="dt">int</span>, <span class="dt">vector</span>[<span class="dv">3</span>]) xy = (<span class="dv">42</span>, [<span class="dv">1</span>, <span class="fl">2.9</span>, -<span class="fl">1.3</span>]');</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The expression <code>42</code> is of type <code>int</code> and the expression <code>[1, 2.9, -1.3]</code> is of type <code>row_vector</code> so that <code>[1, 2.9, -1.3]'</code> is of type <code>vector</code> and of size 3. The whole tuple expression <code>(42, [1, 2.9, -1.3]')</code> thus has a sized type of <code>tuple(int, vector[3])</code> and an unsized type (e.g., for a function argument) of <code>tuple(int, vector)</code>.</p>
<p>Stan does <em>not</em> support the Python notation with trailing commas, such as <code>(1, 2, 3, )</code> for a 3-tuple.</p>
</section>
<section id="restrictions-on-values" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="restrictions-on-values">Restrictions on values</h3>
<p>There are some restrictions on how array expressions may be used that arise from their types being calculated bottom up and the basic data type and assignment rules of Stan.</p>
<section id="rectangular-array-expressions-only" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="rectangular-array-expressions-only">Rectangular array expressions only</h4>
<p>Although it is tempting to try to define a ragged array expression, all Stan data types are rectangular (or boxes or other higher-dimensional generalizations). Thus the following nested array expression will cause an error when it tries to create a non-rectangular array.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>{ { <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> }, { <span class="dv">4</span>, <span class="dv">5</span> } }  <span class="co">// compile time error: size mismatch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This may appear to be OK, because it is creating a two-dimensional integer array (<code>array[,] int</code>) out of two one-dimensional array integer arrays (<code>array[] int</code>). But it is not allowed because the two one-dimensional arrays are not the same size. If the elements are array expressions, this can be diagnosed at compile time. If one or both expressions is a variable, then that won’t be caught until runtime.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>{ { <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> }, m }  <span class="co">// runtime error if m not size 3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="no-empty-array-expressions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="no-empty-array-expressions">No empty array expressions</h4>
<p>Because there is no way to infer the type of the result, the empty array expression (<code>{ }</code>) is not allowed. This does not sacrifice expressive power, because a declaration is sufficient to initialize a zero-element array.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">0</span>] <span class="dt">int</span> a;   <span class="co">// a is fully defined as zero element array</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="no-zero-tuples-or-one-tuples" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="no-zero-tuples-or-one-tuples">No zero-tuples or one-tuples</h4>
<p>There is no way to declare or construct a zero-tuple or one-tuple in Stan. Tuples must be at least two elements long. The expression <code>()</code> does not pick out a zero-tuple—it is ill formed. Similarly, the expression <code>(1)</code> is of type <code>int</code> rather than a tuple.</p>
</section>
</section>
</section>
<section id="parentheses-for-grouping" class="level2">
<h2 class="anchored" data-anchor-id="parentheses-for-grouping">Parentheses for grouping</h2>
<p>Any expression wrapped in parentheses is also an expression. Like in C++, but unlike in R, only the round parentheses, <code>(</code> and <code>)</code>, are allowed. The square brackets <code>[</code> and <code>]</code> are reserved for array indexing and the curly braces <code>{</code> and <code>}</code> for grouping statements.</p>
<p>With parentheses it is possible to explicitly group subexpressions with operators. Without parentheses, the expression <code>1 + 2 * 3</code> has a subexpression <code>2 * 3</code> and evaluates to 7. With parentheses, this grouping may be made explicit with the expression <code>1 + (2 * 3)</code>. More importantly, the expression <code>(1 + 2) *   3</code> has <code>1 + 2</code> as a subexpression and evaluates to 9.</p>
</section>
<section id="arithmetic-expressions.section" class="level2">
<h2 class="anchored" data-anchor-id="arithmetic-expressions.section">Arithmetic and matrix operations on expressions</h2>
<p>For integer and real-valued expressions, Stan supports the basic binary arithmetic operations of addition (<code>+</code>), subtraction (<code>-</code>), multiplication (<code>*</code>) and division (<code>/</code>) in the usual ways.</p>
<p>For integer expressions, Stan supports the modulus (<code>%</code>) binary arithmetic operation. Stan also supports the unary operation of negation for integer and real-valued expressions. For example, assuming <code>n</code> and <code>m</code> are integer variables and <code>x</code> and <code>y</code> real variables, the following expressions are legal.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fl">3.0</span> + <span class="fl">0.14</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>-<span class="dv">15</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> * <span class="dv">3</span> + <span class="dv">1</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>(x - y) / <span class="fl">2.0</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>(n * (n + <span class="dv">1</span>)) / <span class="dv">2</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>x / n</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>m % n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The negation, addition, subtraction, and multiplication operations are extended to matrices, vectors, and row vectors. The transpose operation, written using an apostrophe (<code>'</code>) is also supported for vectors, row vectors, and matrices. Return types for matrix operations are the smallest types that can be statically guaranteed to contain the result. The full set of allowable input types and corresponding return types is detailed in the list of functions.</p>
<p>For example, if <code>y</code> and <code>mu</code> are variables of type <code>vector</code> and <code>Sigma</code> is a variable of type <code>matrix</code>, then <code>(y - mu)' * Sigma * (y - mu)</code> is a well-formed expression of type <code>real</code>. The type of the complete expression is inferred working outward from the subexpressions. The subexpression(s) <code>y - mu</code> are of type <code>vector</code> because the variables <code>y</code> and <code>mu</code> are of type <code>vector</code>. The transpose of this expression, the subexpression <code>(y - mu)'</code> is of type <code>row_vector</code>. Multiplication is left associative and transpose has higher precedence than multiplication, so the above expression is equivalent to the following fully specified form <code>(((y - mu)') * Sigma) * (y - mu)</code>.</p>
<p>The type of subexpression <code>(y - mu)' * Sigma</code> is inferred to be <code>row_vector</code>, being the result of multiplying a row vector by a matrix. The whole expression’s type is thus the type of a row vector multiplied by a (column) vector, which produces a <code>real</code> value.</p>
<p>Stan provides elementwise matrix multiplication (e.g., <code>a .* b</code>) and division (e.g., <code>a ./ b</code>) operations. These provide a shorthand to replace loops, but are not intrinsically more efficient than a version programmed with an elementwise calculations and assignments in a loop. For example, given declarations,</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] a;</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] b;</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] c;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the assignment,</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>c = a .* b;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>produces the same result with roughly the same efficiency as the loop</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  c[n] = a[n] * b[n];</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Stan supports exponentiation (<code>^</code>) of integer and real-valued expressions. The return type of exponentiation is always a real-value. For example, assuming <code>n</code> and <code>m</code> are integer variables and <code>x</code> and <code>y</code> real variables, the following expressions are legal.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> ^ <span class="dv">2</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fl">3.0</span> ^ -<span class="dv">2</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fl">3.0</span> ^ <span class="fl">0.14</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>x ^ n</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>n ^ x</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>n ^ m</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>x ^ y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Exponentiation is right associative, so the expression <code>2 ^ 3 ^ 4</code> is equivalent to the fully specified form <code>2 ^ (3 ^ 4)</code>.</p>
<section id="operator-precedence-and-associativity" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="operator-precedence-and-associativity">Operator precedence and associativity</h3>
<p>The precedence and associativity of operators, as well as built-in syntax such as array indexing and function application is given in tabular form in the following table.</p>
<section id="operator-precedence-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="operator-precedence-table">Operator Precedence Table</h5>
<p><em>Stan’s unary, binary, and ternary operators, with their precedences, associativities, place in an expression, and a description. The last two lines list the precedence of function application and array, matrix, and vector indexing. The operators are listed in order of precedence, from least tightly binding to most tightly binding. The full set of legal arguments and corresponding result types are provided in the function documentation for the operators (i.e.,</em> <code>operator*(int, int):int</code> <em>indicates the application of the multiplication operator to two integers, which returns an integer). Parentheses may be used to group expressions explicitly rather than relying on precedence and associativity.</em></p>
<table class="table">
<colgroup>
<col style="width: 12%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 22%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Op.</th>
<th style="text-align: right;">Prec.</th>
<th style="text-align: center;">Assoc.</th>
<th style="text-align: left;">Placement</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>? ~ :</code></td>
<td style="text-align: right;">10</td>
<td style="text-align: center;">right</td>
<td style="text-align: left;">ternary infix</td>
<td style="text-align: left;">conditional</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>||</code></td>
<td style="text-align: right;">9</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">logical or</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>&amp;&amp;</code></td>
<td style="text-align: right;">8</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">logical and</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>==</code></td>
<td style="text-align: right;">7</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">equality</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>!=</code></td>
<td style="text-align: right;">7</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">inequality</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>&lt;</code></td>
<td style="text-align: right;">6</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">less than</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>&lt;=</code></td>
<td style="text-align: right;">6</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">less than or equal</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>&gt;</code></td>
<td style="text-align: right;">6</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">greater than</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>&gt;=</code></td>
<td style="text-align: right;">6</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">greater than or equal</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: right;">5</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">addition</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>-</code></td>
<td style="text-align: right;">5</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">subtraction</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: right;">4</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">multiplication</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>.*</code></td>
<td style="text-align: right;">4</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">elementwise multiplication</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>/</code></td>
<td style="text-align: right;">4</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">(right) division</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>./</code></td>
<td style="text-align: right;">4</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">elementwise division</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>%</code></td>
<td style="text-align: right;">4</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">modulus</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\</code></td>
<td style="text-align: right;">3</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">left division</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>%/%</code></td>
<td style="text-align: right;">3</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">integer division</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>!</code></td>
<td style="text-align: right;">2</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: left;">unary prefix</td>
<td style="text-align: left;">logical negation</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>-</code></td>
<td style="text-align: right;">2</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: left;">unary prefix</td>
<td style="text-align: left;">negation</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: right;">2</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: left;">unary prefix</td>
<td style="text-align: left;">promotion (no-op in Stan)</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>^</code></td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">right</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">exponentiation</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>.^</code></td>
<td style="text-align: right;">1</td>
<td style="text-align: center;">right</td>
<td style="text-align: left;">binary infix</td>
<td style="text-align: left;">elementwise exponentiation</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'</code></td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: left;">unary postfix</td>
<td style="text-align: left;">transposition</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>()</code></td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: left;">prefix, wrap</td>
<td style="text-align: left;">function application</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>[]</code></td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">left</td>
<td style="text-align: left;">prefix, wrap</td>
<td style="text-align: left;">array, matrix indexing</td>
</tr>
</tbody>
</table>
<p>Other expression-forming operations, such as function application and subscripting bind more tightly than any of the arithmetic operations.</p>
<p>The precedence and associativity determine how expressions are interpreted. Because addition is left associative, the expression <code>a + b + c</code> is interpreted as <code>(a + b) + c</code>. Similarly, <code>a / b * c</code> is interpreted as <code>(a / b) * c</code>.</p>
<p>Because multiplication has higher precedence than addition, the expression <code>a * b + c</code> is interpreted as <code>(a * b) + c</code> and the expression <code>a + b * c</code> is interpreted as <code>a + (b * c)</code>. Similarly, <code>2 * x + 3 * - y</code> is interpreted as <code>(2 * x) + (3 * (-y))</code>.</p>
<p>Transposition and exponentiation bind more tightly than any other arithmetic or logical operation. For vectors, row vectors, and matrices, <code>-u'</code> is interpreted as <code>-(u')</code>, <code>u * v'</code> as <code>u* (v')</code>, and <code>u' * v</code> as <code>(u') * v</code>. For integer and reals, <code>-n ^ 3</code> is interpreted as <code>-(n ^ 3)</code>.</p>
</section>
</section>
</section>
<section id="conditional-operator.section" class="level2">
<h2 class="anchored" data-anchor-id="conditional-operator.section">Conditional operator</h2>
<section id="conditional-operator-syntax" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="conditional-operator-syntax">Conditional operator syntax</h3>
<p>The ternary conditional operator is unique in that it takes three arguments and uses a mixed syntax. If <code>a</code> is an expression of type <code>int</code> and <code>b</code> and <code>c</code> are expressions that can be converted to one another (e.g., compared with <code>==</code>), then</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>a ? b : c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is an expression of the promoted type of <code>b</code> and <code>c</code>. The only promotion allowed in Stan is integer -&gt; real -&gt; complex; e.g.&nbsp;if one argument is of type <code>int</code> and the other of type <code>real</code>, the conditional expression as a whole is of type <code>real</code>. In other cases, the arguments have to be of the same underlying Stan type (i.e., constraints don’t count, only the shape) and the conditional expression is of that type.</p>
<section id="conditional-operator-precedence" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="conditional-operator-precedence">Conditional operator precedence</h4>
<p>The conditional operator is the most loosely binding operator, so its arguments rarely require parentheses for disambiguation. For example,</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>a &gt; <span class="dv">0</span> || b &lt; <span class="dv">0</span> ? c + d : e - f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is equivalent to the explicitly grouped version</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(a &gt; <span class="dv">0</span> || b &lt; <span class="dv">0</span>) ? (c + d) : (e - f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The latter is easier to read even if the parentheses are not strictly necessary.</p>
</section>
<section id="conditional-operator-associativity" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="conditional-operator-associativity">Conditional operator associativity</h4>
<p>The conditional operator is right associative, so that</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>a ? b : c ? d : e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>parses as if explicitly grouped as</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>a ? b : (c ? d : e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Again, the explicitly grouped version is easier to read.</p>
</section>
</section>
<section id="conditional-operator-semantics" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="conditional-operator-semantics">Conditional operator semantics</h3>
<p>Stan’s conditional operator works very much like its C++ analogue. The first argument must be an expression denoting an integer. Typically this is a variable or a relation operator, as in the variable <code>a</code> in the example above. Then there are two resulting arguments, the first being the result returned if the condition evaluates to true (i.e., non-zero) and the second if the condition evaluates to false (i.e., zero). In the example above, the value <code>b</code> is returned if the condition evaluates to a non-zero value and <code>c</code> is returned if the condition evaluates to zero.</p>
<section id="lazy-evaluation-of-results" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="lazy-evaluation-of-results">Lazy evaluation of results</h4>
<p>The key property of the conditional operator that makes it so useful in high-performance computing is that it only evaluates the returned subexpression, not the alternative expression. In other words, it is not like a typical function that evaluates its argument expressions eagerly in order to pass their values to the function. As usual, the saving is mostly in the derivatives that do not get computed rather than the unnecessary function evaluation itself.</p>
</section>
<section id="promotion-to-parameter" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="promotion-to-parameter">Promotion to parameter</h4>
<p>If one return expression is a data value (an expression involving only constants and variables defined in the data or transformed data block), and the other is not, then the ternary operator will promote the data value to a parameter value. This can cause needless work calculating derivatives in some cases and be less efficient than a full <code>if</code>-<code>then</code> conditional statement. For example,</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[<span class="dv">10</span>] <span class="dt">real</span> x;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[<span class="dv">10</span>] <span class="dt">real</span> z;</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  y ~ normal(cond ? x : z, sigma);</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>would be more efficiently (if not more transparently) coded as</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (cond) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  y ~ normal(x, sigma);</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  y ~ normal(z, sigma);</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The conditional statement, like the conditional operator, only evaluates one of the result statements. In this case, the variable <code>x</code> will not be promoted to a parameter and thus not cause any needless work to be carried out when propagating the chain rule during derivative calculations.</p>
</section>
</section>
</section>
<section id="language-indexing.section" class="level2">
<h2 class="anchored" data-anchor-id="language-indexing.section">Indexing</h2>
<p>Stan arrays, matrices, vectors, and row vectors are all accessed using the same array-like notation. For instance, if <code>x</code> is a variable of type <code>array [] real</code> (a one-dimensional array of reals) then <code>x[1]</code> is the value of the first element of the array.</p>
<p>Subscripting has higher precedence than any of the arithmetic operations. For example, <code>alpha * x[1]</code> is equivalent to <code>alpha * (x[1])</code>.</p>
<p>Multiple subscripts may be provided within a single pair of square brackets. If <code>x</code> is of type <code>array[,] real</code>, a two-dimensional array, then <code>x[2, 501]</code> is of type <code>real</code>.</p>
<section id="accessing-subarrays" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="accessing-subarrays">Accessing subarrays</h3>
<p>The subscripting operator also returns subarrays of arrays. For example, if <code>x</code> is of type <code>array[,,] real</code>, then <code>x[2]</code> is of type <code>array[,] real</code>, and <code>x[2, 3]</code> is of type <code>array[] real</code>. As a result, the expressions <code>x[2, 3]</code> and <code>x[2][3]</code> have the same meaning.</p>
</section>
<section id="accessing-matrix-rows" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="accessing-matrix-rows">Accessing matrix rows</h3>
<p>If <code>Sigma</code> is a variable of type <code>matrix</code>, then <code>Sigma[1]</code> denotes the first row of <code>Sigma</code> and has the type <code>row_vector</code>.</p>
</section>
<section id="mixing-array-and-vectormatrix-indexes" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="mixing-array-and-vectormatrix-indexes">Mixing array and vector/matrix indexes</h3>
<p>Stan supports mixed indexing of arrays and their vector, row vector or matrix values. For example, if <code>m</code> is of type <code>matrix[ , ]</code>, a two-dimensional array of matrices, then <code>m[1]</code> refers to the first row of the array, which is a one-dimensional array of matrices. More than one index may be used, so that <code>m[1, 2]</code> is of type <code>matrix</code> and denotes the matrix in the first row and second column of the array. Continuing to add indices, <code>m[1, 2, 3]</code> is of type <code>row_vector</code> and denotes the third row of the matrix denoted by <code>m[1, 2]</code>. Finally, <code>m[1, 2, 3, 4]</code> is of type <code>real</code> and denotes the value in the third row and fourth column of the matrix that is found at the first row and second column of the array <code>m</code>.</p>
</section>
</section>
<section id="language-multi-indexing.section" class="level2">
<h2 class="anchored" data-anchor-id="language-multi-indexing.section">Multiple indexing and range indexing</h2>
<p>In addition to single integer indexes, as described in <a href="#language-indexing.section">the language indexing section</a>, Stan supports multiple indexing. Multiple indexes can be integer arrays of indexes, lower bounds, upper bounds, lower and upper bounds, or simply shorthand for all of the indexes. A complete table of index types is given in the following table.</p>
<section id="index-types-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="index-types-table">Indexing Options Table</h5>
<p><em>Types of indexes and examples with one-dimensional containers of size <code>N</code> and an integer array <code>ii</code> of type <code>array [] real</code> size <code>K</code>.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">index type</th>
<th style="text-align: center;">example</th>
<th style="text-align: center;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">integer</td>
<td style="text-align: center;"><code>a[11]</code></td>
<td style="text-align: center;">value of <code>a</code> at index 11</td>
</tr>
<tr class="even">
<td style="text-align: center;">integer array</td>
<td style="text-align: center;"><code>a[ii]</code></td>
<td style="text-align: center;"><code>a[ii[1]]</code>, …, <code>a[ii[K]]</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">lower bound</td>
<td style="text-align: center;"><code>a[3:]</code></td>
<td style="text-align: center;"><code>a[3]</code>, …, <code>a[N]</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">upper bound</td>
<td style="text-align: center;"><code>a[:5]</code></td>
<td style="text-align: center;"><code>a[1]</code>, …, <code>a[5]</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">range</td>
<td style="text-align: center;"><code>a[2:7]</code></td>
<td style="text-align: center;"><code>a[2]</code>, …, <code>a[7]</code></td>
</tr>
<tr class="even">
<td style="text-align: center;">all</td>
<td style="text-align: center;"><code>a[:]</code></td>
<td style="text-align: center;"><code>a[1]</code>, …, <code>a[N]</code></td>
</tr>
<tr class="odd">
<td style="text-align: center;">all</td>
<td style="text-align: center;"><code>a[]</code></td>
<td style="text-align: center;"><code>a[1]</code>, …, <code>a[N]</code></td>
</tr>
</tbody>
</table>
</section>
<section id="multiple-index-semantics" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="multiple-index-semantics">Multiple index semantics</h3>
<p>The fundamental semantic rule for dealing with multiple indexes is the following. If <code>idxs</code> is a multiple index, then it produces an indexable position in the result. To evaluate that index position in the result, the index is first passed to the multiple index, and the resulting index used.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>a[idxs, ...][i, ...] = a[idxs[i], ...][...]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the other hand, if <code>idx</code> is a single index, it reduces the dimensionality of the output, so that</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>a[idx, ...] = a[idx][...]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The only issue is what happens with matrices and vectors. Vectors work just like arrays. Matrices with multiple row indexes and multiple column indexes produce matrices. Matrices with multiple row indexes and a single column index become (column) vectors. Matrices with a single row index and multiple column indexes become row vectors. The types are summarized in the following table.</p>
<section id="matrix-indexing-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="matrix-indexing-table">Matrix Indexing Table</h5>
<p><em>Special rules for reducing matrices based on whether the argument is a single or multiple index. Examples are for a matrix <code>a</code>, with integer single indexes <code>i</code> and <code>j</code> and integer array multiple indexes <code>is</code> and <code>js</code>. The same typing rules apply for all multiple indexes.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">example</th>
<th style="text-align: center;">row index</th>
<th style="text-align: center;">column index</th>
<th style="text-align: center;">result type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>a[i]</code></td>
<td style="text-align: center;">single</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: center;">row vector</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>a[is]</code></td>
<td style="text-align: center;">multiple</td>
<td style="text-align: center;">n/a</td>
<td style="text-align: center;">matrix</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>a[i, j]</code></td>
<td style="text-align: center;">single</td>
<td style="text-align: center;">single</td>
<td style="text-align: center;">real</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>a[i, js]</code></td>
<td style="text-align: center;">single</td>
<td style="text-align: center;">multiple</td>
<td style="text-align: center;">row vector</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>a[is, j]</code></td>
<td style="text-align: center;">multiple</td>
<td style="text-align: center;">single</td>
<td style="text-align: center;">vector</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>a[is, js]</code></td>
<td style="text-align: center;">multiple</td>
<td style="text-align: center;">multiple</td>
<td style="text-align: center;">matrix</td>
</tr>
</tbody>
</table>
<p>Evaluation of matrices with multiple indexes is defined to respect the following distributivity conditions.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>m[idxs1, idxs2][i, j] = m[idxs1[i], idxs2[j]]</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>m[idxs, idx][j] = m[idxs[j], idx]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>m[idx, idxs][j] = m[idx, idxs[j]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Evaluation of arrays of matrices and arrays of vectors or row vectors is defined recursively, beginning with the array dimensions.</p>
</section>
</section>
</section>
<section id="function-application.section" class="level2">
<h2 class="anchored" data-anchor-id="function-application.section">Function application</h2>
<p>Stan provides a range of built in mathematical and statistical functions, which are documented in the built-in function documentation.</p>
<p>Expressions in Stan may consist of the name of function followed by a sequence of zero or more argument expressions. For instance, <code>log(2.0)</code> is the expression of type <code>real</code> denoting the result of applying the natural logarithm to the value of the real literal <code>2.0</code>.</p>
<p>Syntactically, function application has higher precedence than any of the other operators, so that <code>y + log(x)</code> is interpreted as <code>y + (log(x))</code>.</p>
<section id="type-signatures-and-result-type-inference" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="type-signatures-and-result-type-inference">Type signatures and result type inference</h3>
<p>Each function has a type signature which determines the allowable type of its arguments and its return type. For instance, the function signature for the logarithm function can be expressed as</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> log(<span class="dt">real</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and the signature for the <code>lmultiply</code> function is</p>
<p><code>real lmultiply(real, real);</code></p>
<p>A function is uniquely determined by its name and its sequence of argument types. For instance, the following two functions are different functions.</p>
<p><code>real mean(array [] real);</code></p>
<p><code>real mean(vector);</code></p>
<p>The first applies to a one-dimensional array of real values and the second to a vector.</p>
<p>The identity conditions for functions explicitly forbids having two functions with the same name and argument types but different return types. This restriction also makes it possible to infer the type of a function expression compositionally by only examining the type of its subexpressions.</p>
</section>
<section id="constants" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="constants">Constants</h3>
<p>Constants in Stan are nothing more than nullary (no-argument) functions. For instance, the mathematical constants <span class="math inline">\(\pi\)</span> and <span class="math inline">\(e\)</span> are represented as nullary functions named <code>pi()</code> and <code>e()</code>. See the <a href="https://mc-stan.org/docs/functions-reference/real-valued_basic_functions.html#built-in-constants">Stan Functions Reference built-in constants section</a> for a list of built-in constants.</p>
</section>
<section id="type-promotion-and-function-resolution" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="type-promotion-and-function-resolution">Type promotion and function resolution</h3>
<p>Because of integer to real type promotion, rules must be established for which function is called given a sequence of argument types. The scheme employed by Stan is the same as that used by C++, which resolves a function call to the function requiring the minimum number of type promotions.</p>
<p>For example, consider a situation in which the following two function signatures have been registered for <code>foo</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> foo(<span class="dt">real</span>, <span class="dt">real</span>);</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> foo(<span class="dt">int</span>, <span class="dt">int</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The use of <code>foo</code> in the expression <code>foo(1.0, 1.0)</code> resolves to <code>foo(real, real)</code>, and thus the expression <code>foo(1.0, 1.0)</code> itself is assigned a type of <code>real</code>.</p>
<p>Because integers may be promoted to real values, the expression <code>foo(1, 1)</code> could potentially match either <code>foo(real, real)</code> or <code>foo(int, int)</code>. The former requires two type promotions and the latter requires none, so <code>foo(1, 1)</code> is resolved to function <code>foo(int, int)</code> and is thus assigned the type <code>int</code>.</p>
<p>The expression <code>foo(1, 1.0)</code> has argument types <code>(int, real)</code> and thus does not explicitly match either function signature. By promoting the integer expression <code>1</code> to type <code>real</code>, it is able to match <code>foo(real, real)</code>, and hence the type of the function expression <code>foo(1, 1.0)</code> is <code>real</code>.</p>
<p>In some cases (though not for any built-in Stan functions), a situation may arise in which the function referred to by an expression remains ambiguous. For example, consider a situation in which there are exactly two functions named <code>bar</code> with the following signatures.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> bar(<span class="dt">real</span>, <span class="dt">int</span>);</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> bar(<span class="dt">int</span>, <span class="dt">real</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With these signatures, the expression <code>bar(1.0, 1)</code> and <code>bar(1, 1.0)</code> resolve to the first and second of the above functions, respectively. The expression <code>bar(1.0, 1.0)</code> is illegal because real values may not be demoted to integers. The expression <code>bar(1, 1)</code> is illegal for a different reason. If the first argument is promoted to a real value, it matches the first signature, whereas if the second argument is promoted to a real value, it matches the second signature. The problem is that these both require one promotion, so the function name <code>bar</code> is ambiguous. If there is not a unique function requiring fewer promotions than all others, as with <code>bar(1, 1)</code> given the two declarations above, the Stan compiler will flag the expression as illegal.</p>
</section>
<section id="random-number-generating-functions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="random-number-generating-functions">Random-number generating functions</h3>
<p>For most of the distributions supported by Stan, there is a corresponding random-number generating function. These random number generators are named by the distribution with the suffix <code>_rng</code>. For example, a univariate normal random number can be generated by <code>normal_rng(0, 1)</code>; only the parameters of the distribution, here a location (0) and scale (1) are specified because the variate is generated.</p>
<section id="random-number-generators-locations" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="random-number-generators-locations">Random-number generators locations</h4>
<p>The use of random-number generating functions is restricted to the transformed data and generated quantities blocks; attempts to use them elsewhere will result in a parsing error with a diagnostic message. They may also be used in the bodies of user-defined functions whose names end in <code>_rng</code>.</p>
<p>This allows the random number generating functions to be used for simulation in general, and for Bayesian posterior predictive checking in particular.</p>
</section>
<section id="posterior-predictive-checking" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="posterior-predictive-checking">Posterior predictive checking</h4>
<p>Posterior predictive checks typically use the parameters of the model to generate simulated data (at the individual and optionally at the group level for hierarchical models), which can then be compared informally using plots and formally by means of test statistics, to the actual data in order to assess the suitability of the model; see Chapter 6 of <span class="citation" data-cites="GelmanEtAl:2013">(<a href="#ref-GelmanEtAl:2013" role="doc-biblioref">Gelman et al. 2013</a>)</span> for more information on posterior predictive checks.</p>
</section>
</section>
</section>
<section id="type-inference" class="level2">
<h2 class="anchored" data-anchor-id="type-inference">Type inference</h2>
<p>Stan is strongly statically typed, meaning that the implementation type of an expression can be resolved at compile time.</p>
<section id="implementation-types" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="implementation-types">Implementation types</h3>
<p>The primitive implementation types for Stan are</p>
<pre><code>int, real, complex, vector, row_vector,  matrix, complex_vector,
complex_row_vector, complex_matrix</code></pre>
<p>Every basic declared type corresponds to a primitive type; the following table shows the mapping from types to their primitive types.</p>
<section id="primitive-type-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="primitive-type-table">Primitive Type Table</h5>
<p><em>The table shows the variable declaration types of Stan and their corresponding primitive implementation type. Stan functions, operators, and probability functions have argument and result types declared in terms of primitive types plus array dimensionality.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">type</th>
<th style="text-align: left;">primitive type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>int</code></td>
<td style="text-align: left;"><code>int</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>real</code></td>
<td style="text-align: left;"><code>real</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>vector</code></td>
<td style="text-align: left;"><code>vector</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>simplex</code></td>
<td style="text-align: left;"><code>vector</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>unit_vector</code></td>
<td style="text-align: left;"><code>vector</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ordered</code></td>
<td style="text-align: left;"><code>vector</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>positive_ordered</code></td>
<td style="text-align: left;"><code>vector</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>row_vector</code></td>
<td style="text-align: left;"><code>row_vector</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>matrix</code></td>
<td style="text-align: left;"><code>matrix</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cov_matrix</code></td>
<td style="text-align: left;"><code>matrix</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>corr_matrix</code></td>
<td style="text-align: left;"><code>matrix</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cholesky_factor_cov</code></td>
<td style="text-align: left;"><code>matrix</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>cholesky_factor_corr</code></td>
<td style="text-align: left;"><code>matrix</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>complex_vector</code></td>
<td style="text-align: left;"><code>complex_vector</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>complex_row_vector</code></td>
<td style="text-align: left;"><code>complex_row_vector</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>complex_matrix</code></td>
<td style="text-align: left;"><code>complex_matrix</code></td>
</tr>
</tbody>
</table>
<p>A full implementation type consists of a primitive implementation type and an integer array dimensionality greater than or equal to zero. These will be written to emphasize their array-like nature. For example, <code>array [] real</code> has an array dimensionality of 1, <code>int</code> an array dimensionality of 0, and <code>array [,,] int</code> an array dimensionality of 3. The implementation type <code>matrix[ , , ]</code> has a total of five dimensions and takes up to five indices, three from the array and two from the matrix.</p>
<p>Recall that the array dimensions come before the matrix or vector dimensions in an expression such as the following declaration of a three-dimensional array of matrices.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[I, J, K] <span class="dt">matrix</span>[M, N] a;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The matrix <code>a</code> is indexed as <code>a[i, j, k, m, n]</code> with the array indices first, followed by the matrix indices, with <code>a[i, j, k]</code> being a matrix and <code>a[i, j, k, m]</code> being a row vector.</p>
</section>
</section>
<section id="type-inference-rules" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="type-inference-rules">Type inference rules</h3>
<p>Stan’s type inference rules define the implementation type of an expression based on a background set of variable declarations. The rules work bottom up from primitive literal and variable expressions to complex expressions.</p>
</section>
<section id="promotion" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="promotion">Promotion</h3>
<p>There are two basic promotion rules,</p>
<ol type="1">
<li><code>int</code> types may be promoted to <code>real</code>, and</li>
<li><code>real</code> types may be promoted to <code>complex</code>.</li>
</ol>
<p>Plus, promotion is transitive, so that</p>
<ol start="3" type="1">
<li>if type <code>U</code> can be promoted to type <code>V</code> and type <code>V</code> can be promoted to type <code>T</code>, then <code>U</code> can be promoted to <code>T</code>.</li>
</ol>
<p>The first rule means that expressions of type <code>int</code> may be used anywhere an expression of type <code>real</code> is specified, namely in assignment or function argument passing. An integer is promoted to real by casting it in the underlying C++ code.</p>
<p>The remaining rules have to do with covariant typing rules, which say that a container of type <code>U</code> may be promoted to a container of the same shape of type <code>T</code> if <code>U</code> can be promoted to <code>T</code>. For vector and matrix types, this induces three rules,</p>
<ol start="4" type="1">
<li><code>vector</code> may be promoted to <code>complex_vector</code>,</li>
<li><code>row_vector</code> may be promoted to <code>complex_row_vector</code></li>
<li><code>matrix</code> may be promoted to <code>complex_matrix</code>.</li>
</ol>
<p>For array types, there’s a single rule</p>
<ol start="7" type="1">
<li><code>array[...] U</code> may be promoted to <code>array[...] T</code> if <code>U</code> can be promoted to <code>T</code>.</li>
</ol>
<p>For example, this means <code>array[,] int</code> may be used where <code>array [,] real</code> or <code>array [,] complex</code> is required; as another example, <code>array[] real</code> may be used anywhere <code>array[] complex</code> is required.</p>
<p>Tuples have the natural extension of the above rules, applied to all sub-types at once</p>
<ol start="8" type="1">
<li>A <code>tuple(U1, ..., UN)</code> may be promoted to a <code>tuple(T1, ..., TN)</code> if every <code>Un</code> can be promoted to <code>Tn</code> for <code>n</code> in <code>1:N</code></li>
</ol>
<section id="literals" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="literals">Literals</h4>
<p>An integer literal expression such as <code>42</code> is of type <code>int</code>. Real literals such as <code>42.0</code> are of type <code>real</code>. Imaginary literals such as <code>-17i</code> are of type <code>complex</code>. the expression <code>7 - 2i</code> acts like a complex literal, but technically it combines a real literal <code>7</code> and an imaginary literal <code>2i</code> through subtraction.</p>
</section>
<section id="variables" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="variables">Variables</h4>
<p>The type of a variable declared locally or in a previous block is determined by its declaration. The type of a loop variable is <code>int</code>.</p>
<p>There is always a unique declaration for each variable in each scope because Stan prohibits the redeclaration of an already-declared variables.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
<section id="indexing" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="indexing">Indexing</h4>
<p>If <code>x</code> is an expression of total dimensionality greater than or equal to <span class="math inline">\(N\)</span>, then the type of expression <code>e[i1, i2, ..., iN]</code> is the same as that of <code>e[i1][i2]...[iN]</code>, so it suffices to define the type of a singly-indexed function. Suppose <code>e</code> is an expression and <code>i</code> is an expression of primitive type <code>int</code>. Then</p>
<ul>
<li>if <code>e</code> is an expression of type <code>array[i1, i2, ..., iN] T</code> and <code>k,</code> <code>i1</code>, …, <code>iN</code> are expressions of type <code>int</code>, then <code>e[k]</code> is an expression of type <code>array[i2, ..., iN] T</code>,</li>
<li>if <code>e</code> is an expression of type <code>array[i] T</code> with <code>i</code> and <code>k</code> expressions of type <code>int</code>, then <code>e[k]</code> is of type <code>T</code>,</li>
<li>if <code>e</code> has implementation type <code>vector</code> or <code>row_vector</code>, dimensionality 0, then <code>e[i]</code> has implementation type <code>real</code>,</li>
<li>if <code>e</code> has implementation type <code>matrix</code>, then <code>e[i]</code> has type <code>row_vector</code>,</li>
<li>if <code>e</code> has implementation type <code>complex_vector</code> or <code>complex_row_vector</code> and <code>i</code> is an expression of type <code>int</code>, then <code>e[i]</code> is an expression of type <code>complex</code>, and</li>
<li>if <code>e</code> has implementation type <code>complex_matrix</code>, and <code>i</code> is an expression of type <code>int</code>, then <code>e[i]</code> is an expression of type <code>complex_row_vector</code>.</li>
</ul>
</section>
<section id="function-application" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="function-application">Function application</h4>
<p>If <code>f</code> is the name of a function and <code>e1,...,eN</code> are expressions for <span class="math inline">\(N \geq 0\)</span>, then <code>f(e1,...,eN)</code> is an expression whose type is determined by the return type in the function signature for <code>f</code> given <code>e1</code> through <code>eN</code>. Recall that a function signature is a declaration of the argument types and the result type.</p>
<p>In looking up functions, binary operators like <code>real * real</code> are defined as <code>operator*(real, real)</code> in the documentation and index.</p>
<p>In matching a function definition, all of the promotion rules are in play (integers may be promoted to reals, reals to complex, and containers may be promoted if their types are promoted). For example, arguments of type <code>int</code> may be promoted to type <code>real</code> or <code>complex</code> if necessary (see the subsection on type promotion in <a href="#function-application">the function application section</a>, a <code>real</code> argument will be promoted to <code>complex</code> if necessary, a <code>vector</code> will be promoted to <code>complex_vector</code> if necessary, and so on.</p>
<p>In general, matrix operations return the lowest inferable type. For example, <code>row_vector * vector</code> returns a value of type <code>real</code>, which is declared in the function documentation and index as <code>real operator*(row_vector, vector)</code>.</p>
</section>
</section>
</section>
<section id="higher-order-functions" class="level2">
<h2 class="anchored" data-anchor-id="higher-order-functions">Higher-order functions</h2>
<p>There are several expression constructions in Stan that act as higher-order functions.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>The higher-order functions and the signature of their argument functions are listed in the following pair of tables.</p>
<section id="higher-order-functions-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="higher-order-functions-table">Higher-order Functions Table</h5>
<p><em>Higher-order functions in Stan with their argument function types. The first group of arguments can be a function of parameters or data. The second group of arguments, consisting of a real and integer array in all cases, must be expressions involving only data and literals.</em></p>
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 34%">
<col style="width: 28%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">function</th>
<th style="text-align: center;">parameter or data args</th>
<th style="text-align: center;">data args</th>
<th style="text-align: center;">return type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>algebra_solver</code></td>
<td style="text-align: center;"><code>vector, vector</code></td>
<td style="text-align: center;"><code>array [] real, array [] real</code></td>
<td style="text-align: center;"><code>vector</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>algebra_solver_newton</code></td>
<td style="text-align: center;"><code>vector, vector</code></td>
<td style="text-align: center;"><code>array [] real, array [] real</code></td>
<td style="text-align: center;"><code>vector</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>integrate_1d</code>,</td>
<td style="text-align: center;"><code>real, real, array [] real</code></td>
<td style="text-align: center;"><code>array [] real, array [] real</code></td>
<td style="text-align: center;"><code>real</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>integrate_ode_X</code>,</td>
<td style="text-align: center;"><code>real, array [] real, array [] real</code></td>
<td style="text-align: center;"><code>array [] real, array [] real</code></td>
<td style="text-align: center;"><code>array [] real</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>map_rect</code></td>
<td style="text-align: center;"><code>vector, vector</code></td>
<td style="text-align: center;"><code>array [] real, array [] real</code></td>
<td style="text-align: center;"><code>vector</code></td>
</tr>
</tbody>
</table>
<p>For example, the <code>integrate_ode_rk45</code> function can be used to integrate differential equations in Stan:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span> [] <span class="dt">real</span> foo(<span class="dt">real</span> t,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">array</span> [] <span class="dt">real</span> y,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">array</span> [] <span class="dt">real</span> theta,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">array</span> [] <span class="dt">real</span> x_r,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">array</span> [] <span class="dt">real</span> x_i) {</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; T;</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>] <span class="dt">real</span> y0;</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> t0;</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[T] <span class="dt">real</span> ts;</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">1</span>] <span class="dt">real</span> theta;</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">0</span>] <span class="dt">real</span> x_r;</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">0</span>] <span class="dt">int</span> x_i;</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[T, <span class="dv">2</span>] <span class="dt">real</span> y_hat = <span class="kw">integrate_ode_rk45</span>(foo, y0, t0,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>                                              ts, theta, x_r, x_i);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function argument is <code>foo</code>, the name of the user-defined function; as shown in the <a href="#higher-order-functions">higher-order functions table</a>, <code>integrate_ode_rk45</code> takes a real array, a real, three more real arrays, and an integer array as arguments and returns 2D real array.</p>
</section>
<section id="variadic-higher-order-functions-table" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="variadic-higher-order-functions-table">Variadic Higher-order Functions Table</h5>
<p><em>Variadic Higher-order functions in Stan with their argument function types. The first group of arguments are restricted in type. The sequence of trailing arguments can be of any length with any types.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">function</th>
<th style="text-align: center;">restricted args</th>
<th style="text-align: center;">return type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>solve_X</code></td>
<td style="text-align: center;"><code>vector</code></td>
<td style="text-align: center;"><code>vector</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>ode_X</code>,</td>
<td style="text-align: center;"><code>vector, real, array [] real</code></td>
<td style="text-align: center;"><code>vector[]</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>reduce_sum</code></td>
<td style="text-align: center;"><code>array[] T, T1, T2</code></td>
<td style="text-align: center;"><code>real</code></td>
</tr>
</tbody>
</table>
<p><code>T</code>, <code>T1</code>, and <code>T2</code> can be any Stan type.</p>
<p>For example, the <code>ode_rk45</code> function can be used to integrate differential equations in Stan:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span> foo(<span class="dt">real</span> t, <span class="dt">vector</span> y, <span class="dt">real</span> theta, <span class="dt">vector</span> beta,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">array</span> [] <span class="dt">real</span> x_i, <span class="dt">int</span> index) {</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; T;</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">2</span>] y0;</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> t0;</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[T] <span class="dt">real</span> ts;</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> theta;</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">7</span>] beta;</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">10</span>] <span class="dt">int</span> x_i;</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> index;</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">2</span>] y_hat[T] = ode_rk45(foo, y0, t0, ts, theta,</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                              beta, x_i, index);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function argument is <code>foo</code>, the name of the user-defined function. As shown in the <a href="#variadic-higher-order-functions-table">variadic higher-order functions table</a>, <code>ode_rk45</code> takes a real, a vector, a real, a real array, and a sequence of arguments whose types match those at the end of <code>foo</code> and returns an array of vectors.</p>
</section>
<section id="functions-passed-by-reference" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="functions-passed-by-reference">Functions passed by reference</h3>
<p>The function argument to higher-order functions is always passed as the first argument. This function argument must be provided as the name of a user-defined or built-in function. No quotes are necessary.</p>
</section>
<section id="data-restricted-arguments" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="data-restricted-arguments">Data-restricted arguments</h3>
<p>Some of the arguments to higher-order functions are restricted to data. This means they must be expressions containing only data variables, transformed data variables, or literals; the may contain arbitrary functions applied to data variables or literals, but must not contain parameters, transformed parameters, or local variables from any block other than transformed data.</p>
<p>For user-defined functions the qualifier <code>data</code> may be prepended to the type to restrict the argument to data-only variables.</p>
</section>
</section>
<section id="chain-rule-and-derivatives" class="level2">
<h2 class="anchored" data-anchor-id="chain-rule-and-derivatives">Chain rule and derivatives</h2>
<p>Derivatives of the log probability function defined by a model are used in several ways by Stan. The Hamiltonian Monte Carlo samplers, including NUTS, use gradients to guide updates. The BFGS optimizers also use gradients to guide search for posterior modes.</p>
<section id="errors-due-to-chain-rule" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="errors-due-to-chain-rule">Errors due to chain rule</h3>
<p>Unlike evaluations in pure mathematics, evaluation of derivatives in Stan is done by applying the chain rule on an expression-by-expression basis, evaluating using floating-point arithmetic. As a result, models such as the following are problematic for inference involving derivatives.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> x;</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  x ~ normal(sqrt(x - x), <span class="dv">1</span>);</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Algebraically, <a href="the distribution statement">statements.qmd#distribution-statements.section</a> in the model could be reduced to</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>  x ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and it would seem the model should produce unit normal draws for <code>x</code>. But rather than canceling, the expression <code>sqrt(x -   x)</code> causes a problem for derivatives. The cause is the mechanistic evaluation of the chain rule,</p>
<p><span class="math display">\[
\begin{array}{rcl}
\frac{d}{dx} \sqrt{x - x}
&amp; = &amp;
\frac{1}{2 \sqrt{x - x}} \times \frac{d}{dx} (x - x)
\\[4pt]
&amp; = &amp;
\frac{1}{0} \times (1 - 1)
\\[4pt]
&amp; = &amp;
\infty \times 0
\\[4pt]
&amp; = &amp; \mathrm{NaN}.
\end{array}
\]</span></p>
<p>Rather than the <span class="math inline">\(x - x\)</span> canceling out, it introduces a 0 into the numerator and denominator of the chain-rule evaluation.</p>
<p>The only way to avoid this kind problem is to be careful to do the necessary algebraic reductions as part of the model and not introduce expressions like <code>sqrt(x - x)</code> for which the chain rule produces not-a-number values.</p>
</section>
<section id="diagnosing-problems-with-derivatives" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="diagnosing-problems-with-derivatives">Diagnosing problems with derivatives</h3>
<p>The best way to diagnose whether something is going wrong with the derivatives is to use the test-gradient option to the sampler or optimizer inputs; this option is available in both Stan and RStan (though it may be slow, because it relies on finite differences to make a comparison to the built-in automatic differentiation).</p>
<p>For example, compiling the above model to an executable <code>sqrt-x-minus-x</code> in CmdStan, the test can be run as</p>
<pre><code>&gt; ./sqrt-x-minus-x diagnose test=gradient</code></pre>
<p>which produces</p>
<pre><code>...
TEST GRADIENT MODE

 Log probability=-0.393734

 param idx           value           model     finite diff           error
         0       -0.887393             nan               0             nan</code></pre>
<p>Even though finite differences calculates the right gradient of 0, automatic differentiation follows the chain rule and produces a not-a-number output.</p>



</section>
</section>
</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-GelmanEtAl:2013" class="csl-entry" role="listitem">
Gelman, Andrew, J. B. Carlin, Hal S. Stern, David B. Dunson, Aki Vehtari, and Donald B. Rubin. 2013. <em>Bayesian Data Analysis</em>. Third Edition. London: Chapman &amp; Hall / CRC Press.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Languages such as C++ and R allow the declaration of a variable of a given name in a narrower scope to hide (take precedence over for evaluation) a variable defined in a containing scope.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Internally, they are implemented as their own expression types because Stan doesn’t have object-level functional types (yet).<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../reference-manual/types.html" class="pagination-link" aria-label="Data Types and Declarations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Data Types and Declarations</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../reference-manual/statements.html" class="pagination-link" aria-label="Statements">
        <span class="nav-page-text">Statements</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/expressions.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>