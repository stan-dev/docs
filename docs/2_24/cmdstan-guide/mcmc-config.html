<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9 MCMC Sampling using Hamiltonian Monte Carlo | CmdStan User’s Guide</title>
  <meta name="description" content="CmdStan user’s guide." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="9 MCMC Sampling using Hamiltonian Monte Carlo | CmdStan User’s Guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="img/logo-tm.pdf" />
  <meta property="og:description" content="CmdStan user’s guide." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9 MCMC Sampling using Hamiltonian Monte Carlo | CmdStan User’s Guide" />
  
  <meta name="twitter:description" content="CmdStan user’s guide." />
  <meta name="twitter:image" content="img/logo-tm.pdf" />

<meta name="author" content="Stan Development Team" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="command-line-interface-overview.html"/>
<link rel="next" href="maximum-likelihood-estimation.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>



<link rel="stylesheet" href="stan-manual.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li style="font-size:110%; font-weight:400; font-family: Verdana, Helvetica, sans; line-height:1.4; margin: 0.5em 0 0 1em"><a href="https://mc-stan.org/docs/cmdstan-guide/index.html" style="color:#4183C4">CmdStan User's Guide</a></li>

<li class="divider"></li>
<li><a href="index.html#introduction"><i style='font-size: 110%; color:#990017;'>Introduction</i></a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Stan Home Page</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#licensing"><i class="fa fa-check"></i>Licensing</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#stan-documentation-users-guide-and-reference-manuals"><i class="fa fa-check"></i>Stan Documentation: User’s Guide and Reference Manuals</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#benefits-of-cmdstan"><i class="fa fa-check"></i>Benefits of CmdStan</a></li>
</ul></li>
<li><a href="quickstart-guide.html#quickstart-guide"><i style='font-size: 110%; color:#990017;'>QuickStart Guide</i></a></li>
<li class="chapter" data-level="1" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html"><i class="fa fa-check"></i><b>1</b> CmdStan Installation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#installing-the-c-toolchain"><i class="fa fa-check"></i><b>1.1</b> Installing the C++ Toolchain</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#linux-g-and-make"><i class="fa fa-check"></i><b>1.1.1</b> Linux: <code>g++</code> and <code>make</code></a></li>
<li class="chapter" data-level="1.1.2" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#macos-clang-and-make"><i class="fa fa-check"></i><b>1.1.2</b> MacOS: <code>clang++</code> and <code>make</code></a></li>
<li class="chapter" data-level="1.1.3" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#windows-g-and-mingw32-make"><i class="fa fa-check"></i><b>1.1.3</b> Windows: <code>g++</code> and <code>mingw32-make</code></a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#gnu-make"><i class="fa fa-check"></i><b>1.2</b> GNU-Make Utility</a></li>
<li class="chapter" data-level="1.3" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#git-clone.section"><i class="fa fa-check"></i><b>1.3</b> Clone the GitHub CmdStan Repository</a></li>
<li class="chapter" data-level="1.4" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#building-cmdstan"><i class="fa fa-check"></i><b>1.4</b> Building CmdStan</a></li>
<li class="chapter" data-level="1.5" data-path="cmdstan-installation.html"><a href="cmdstan-installation.html#trouble-shooting-the-installation"><i class="fa fa-check"></i><b>1.5</b> Trouble-shooting the installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="example-model-and-data.html"><a href="example-model-and-data.html"><i class="fa fa-check"></i><b>2</b> Example Model and Data</a></li>
<li class="chapter" data-level="3" data-path="compiling-a-stan-program.html"><a href="compiling-a-stan-program.html"><i class="fa fa-check"></i><b>3</b> Compiling a Stan Program</a>
<ul>
<li class="chapter" data-level="3.1" data-path="compiling-a-stan-program.html"><a href="compiling-a-stan-program.html#invoking-the-make-utility"><i class="fa fa-check"></i><b>3.1</b> Invoking the Make Utility</a></li>
<li class="chapter" data-level="3.2" data-path="compiling-a-stan-program.html"><a href="compiling-a-stan-program.html#dependencies"><i class="fa fa-check"></i><b>3.2</b> Dependencies</a></li>
<li class="chapter" data-level="3.3" data-path="compiling-a-stan-program.html"><a href="compiling-a-stan-program.html#compiler-errors"><i class="fa fa-check"></i><b>3.3</b> Compiler Errors</a></li>
<li class="chapter" data-level="3.4" data-path="compiling-a-stan-program.html"><a href="compiling-a-stan-program.html#troubleshooting-c-compiler-or-linker-errors"><i class="fa fa-check"></i><b>3.4</b> Troubleshooting C++ Compiler or Linker Errors</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mcmc-intro.html"><a href="mcmc-intro.html"><i class="fa fa-check"></i><b>4</b> MCMC Sampling</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mcmc-intro.html"><a href="mcmc-intro.html#running-the-sampler"><i class="fa fa-check"></i><b>4.1</b> Running the Sampler</a></li>
<li class="chapter" data-level="4.2" data-path="mcmc-intro.html"><a href="mcmc-intro.html#running-multiple-chains"><i class="fa fa-check"></i><b>4.2</b> Running Multiple Chains</a></li>
<li class="chapter" data-level="4.3" data-path="mcmc-intro.html"><a href="mcmc-intro.html#mcmc_output_csv"><i class="fa fa-check"></i><b>4.3</b> Stan CSV Output File</a></li>
<li class="chapter" data-level="4.4" data-path="mcmc-intro.html"><a href="mcmc-intro.html#summarizing-sampler-outputs-with-stansummary"><i class="fa fa-check"></i><b>4.4</b> Summarizing Sampler Output(s) with <code>stansummary</code></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="optimization.html"><a href="optimization.html"><i class="fa fa-check"></i><b>5</b> Optimization</a></li>
<li class="chapter" data-level="6" data-path="variational-inference.html"><a href="variational-inference.html"><i class="fa fa-check"></i><b>6</b> Variational Inference</a></li>
<li class="chapter" data-level="7" data-path="gc-intro.html"><a href="gc-intro.html"><i class="fa fa-check"></i><b>7</b> Generating Quantities of Interest from a Fitted Model</a></li>
<li><a href="reference-manual.html#reference-manual"><i style='font-size: 110%; color:#990017;'>Reference Manual</i></a></li>
<li class="chapter" data-level="8" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html"><i class="fa fa-check"></i><b>8</b> Command-Line Interface Overview</a>
<ul>
<li class="chapter" data-level="8.1" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#input-data-argument"><i class="fa fa-check"></i><b>8.1</b> Input Data Argument</a></li>
<li class="chapter" data-level="8.2" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#output-control-arguments"><i class="fa fa-check"></i><b>8.2</b> Output Control Arguments</a></li>
<li class="chapter" data-level="8.3" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#initialize-model-parameters-argument"><i class="fa fa-check"></i><b>8.3</b> Initialize Model Parameters Argument</a></li>
<li class="chapter" data-level="8.4" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#random-number-generator-arguments"><i class="fa fa-check"></i><b>8.4</b> Random Number Generator Arguments</a></li>
<li class="chapter" data-level="8.5" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#chain-identifier-argument-id"><i class="fa fa-check"></i><b>8.5</b> Chain Identifier Argument: <code>id</code></a></li>
<li class="chapter" data-level="8.6" data-path="command-line-interface-overview.html"><a href="command-line-interface-overview.html#command-line-help"><i class="fa fa-check"></i><b>8.6</b> Command Line Help</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="mcmc-config.html"><a href="mcmc-config.html"><i class="fa fa-check"></i><b>9</b> MCMC Sampling using Hamiltonian Monte Carlo</a>
<ul>
<li class="chapter" data-level="9.1" data-path="mcmc-config.html"><a href="mcmc-config.html#iterations"><i class="fa fa-check"></i><b>9.1</b> Iterations</a></li>
<li class="chapter" data-level="9.2" data-path="mcmc-config.html"><a href="mcmc-config.html#adaptation"><i class="fa fa-check"></i><b>9.2</b> Adaptation</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="mcmc-config.html"><a href="mcmc-config.html#step-size-optimization-configuration"><i class="fa fa-check"></i><b>9.2.1</b> Step size optimization configuration</a></li>
<li class="chapter" data-level="9.2.2" data-path="mcmc-config.html"><a href="mcmc-config.html#warmup-schedule-configuration"><i class="fa fa-check"></i><b>9.2.2</b> Warmup schedule configuration</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="mcmc-config.html"><a href="mcmc-config.html#algorithm"><i class="fa fa-check"></i><b>9.3</b> Algorithm</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="mcmc-config.html"><a href="mcmc-config.html#samples-from-a-set-of-fixed-parameters"><i class="fa fa-check"></i><b>9.3.1</b> Samples from a set of fixed parameters</a></li>
<li class="chapter" data-level="9.3.2" data-path="mcmc-config.html"><a href="mcmc-config.html#hmc-samplers"><i class="fa fa-check"></i><b>9.3.2</b> HMC samplers</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="mcmc-config.html"><a href="mcmc-config.html#sampler-diag-file"><i class="fa fa-check"></i><b>9.4</b> Sampler Diagnostic File</a></li>
<li class="chapter" data-level="9.5" data-path="mcmc-config.html"><a href="mcmc-config.html#examples"><i class="fa fa-check"></i><b>9.5</b> Examples</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="mcmc-config.html"><a href="mcmc-config.html#running-multiple-chains-with-a-specified-rng-seed"><i class="fa fa-check"></i><b>9.5.1</b> Running multiple chains with a specified RNG seed</a></li>
<li class="chapter" data-level="9.5.2" data-path="mcmc-config.html"><a href="mcmc-config.html#changing-the-default-warmup-and-sampling-iterations"><i class="fa fa-check"></i><b>9.5.2</b> Changing the default warmup and sampling iterations</a></li>
<li class="chapter" data-level="9.5.3" data-path="mcmc-config.html"><a href="mcmc-config.html#saving-warmup-draws"><i class="fa fa-check"></i><b>9.5.3</b> Saving warmup draws</a></li>
<li class="chapter" data-level="9.5.4" data-path="mcmc-config.html"><a href="mcmc-config.html#initializing-parameters"><i class="fa fa-check"></i><b>9.5.4</b> Initializing parameters</a></li>
<li class="chapter" data-level="9.5.5" data-path="mcmc-config.html"><a href="mcmc-config.html#specifying-the-metric-and-stepsize"><i class="fa fa-check"></i><b>9.5.5</b> Specifying the metric and stepsize</a></li>
<li class="chapter" data-level="9.5.6" data-path="mcmc-config.html"><a href="mcmc-config.html#changing-the-nuts-hmc-adaptation-parameters"><i class="fa fa-check"></i><b>9.5.6</b> Changing the NUTS-HMC adaptation parameters</a></li>
<li class="chapter" data-level="9.5.7" data-path="mcmc-config.html"><a href="mcmc-config.html#increasing-the-tree-depth"><i class="fa fa-check"></i><b>9.5.7</b> Increasing the tree-depth</a></li>
<li class="chapter" data-level="9.5.8" data-path="mcmc-config.html"><a href="mcmc-config.html#capturing-hamiltonian-diagnostics-and-gradients"><i class="fa fa-check"></i><b>9.5.8</b> Capturing Hamiltonian diagnostics and gradients</a></li>
<li class="chapter" data-level="9.5.9" data-path="mcmc-config.html"><a href="mcmc-config.html#suppressing-progress-updates-to-the-console"><i class="fa fa-check"></i><b>9.5.9</b> Suppressing progress updates to the console</a></li>
<li class="chapter" data-level="9.5.10" data-path="mcmc-config.html"><a href="mcmc-config.html#everything-example"><i class="fa fa-check"></i><b>9.5.10</b> Everything Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="maximum-likelihood-estimation.html"><a href="maximum-likelihood-estimation.html"><i class="fa fa-check"></i><b>10</b> Maximum Likelihood Estimation</a>
<ul>
<li class="chapter" data-level="10.1" data-path="maximum-likelihood-estimation.html"><a href="maximum-likelihood-estimation.html#optimization-algorithms"><i class="fa fa-check"></i><b>10.1</b> Optimization Algorithms</a></li>
<li class="chapter" data-level="10.2" data-path="maximum-likelihood-estimation.html"><a href="maximum-likelihood-estimation.html#the-quasi-newton-optimizers"><i class="fa fa-check"></i><b>10.2</b> The quasi-Newton optimizers</a></li>
<li class="chapter" data-level="10.3" data-path="maximum-likelihood-estimation.html"><a href="maximum-likelihood-estimation.html#the-newton-optimizer"><i class="fa fa-check"></i><b>10.3</b> The Newton optimizer</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="variational-inference-algorithm-advi.html"><a href="variational-inference-algorithm-advi.html"><i class="fa fa-check"></i><b>11</b> Variational Inference Algorithm: ADVI</a>
<ul>
<li class="chapter" data-level="11.1" data-path="variational-inference-algorithm-advi.html"><a href="variational-inference-algorithm-advi.html#variational-algorithms"><i class="fa fa-check"></i><b>11.1</b> Variational Algorithms</a></li>
<li class="chapter" data-level="11.2" data-path="variational-inference-algorithm-advi.html"><a href="variational-inference-algorithm-advi.html#configuration"><i class="fa fa-check"></i><b>11.2</b> Configuration</a></li>
<li class="chapter" data-level="11.3" data-path="variational-inference-algorithm-advi.html"><a href="variational-inference-algorithm-advi.html#csv-output"><i class="fa fa-check"></i><b>11.3</b> CSV Output</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="standalone-generate-quantities.html"><a href="standalone-generate-quantities.html"><i class="fa fa-check"></i><b>12</b> Standalone Generate Quantities</a></li>
<li class="chapter" data-level="13" data-path="diagnosing-hmc-by-comparison-of-gradients.html"><a href="diagnosing-hmc-by-comparison-of-gradients.html"><i class="fa fa-check"></i><b>13</b> Diagnosing HMC by Comparison of Gradients</a></li>
<li class="chapter" data-level="14" data-path="parallelization.html"><a href="parallelization.html"><i class="fa fa-check"></i><b>14</b> Parallelization</a></li>
<li><a href="cmdstan-tools.html#cmdstan-tools"><i style='font-size: 110%; color:#990017;'>CmdStan Tools</i></a></li>
<li class="chapter" data-level="15" data-path="stanc.html"><a href="stanc.html"><i class="fa fa-check"></i><b>15</b> <code>stanc</code>: Translating Stan to C++</a>
<ul>
<li class="chapter" data-level="15.1" data-path="stanc.html"><a href="stanc.html#instantiating-the-stanc-binary"><i class="fa fa-check"></i><b>15.1</b> Instantiating the <code>stanc</code> Binary</a></li>
<li class="chapter" data-level="15.2" data-path="stanc.html"><a href="stanc.html#the-stan-compiler-program"><i class="fa fa-check"></i><b>15.2</b> The Stan Compiler Program</a></li>
<li class="chapter" data-level="15.3" data-path="stanc.html"><a href="stanc.html#command-line-options-for-stanc3"><i class="fa fa-check"></i><b>15.3</b> Command-Line Options for stanc3</a></li>
<li class="chapter" data-level="15.4" data-path="stanc.html"><a href="stanc.html#command-line-options-for-stanc2"><i class="fa fa-check"></i><b>15.4</b> Command-Line Options for stanc2</a></li>
<li class="chapter" data-level="15.5" data-path="stanc.html"><a href="stanc.html#using-external-c-code"><i class="fa fa-check"></i><b>15.5</b> Using External C++ Code</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="stansummary.html"><a href="stansummary.html"><i class="fa fa-check"></i><b>16</b> <code>stansummary</code>: MCMC Output Analysis</a>
<ul>
<li class="chapter" data-level="16.1" data-path="stansummary.html"><a href="stansummary.html#building-the-stansummary-command"><i class="fa fa-check"></i><b>16.1</b> Building the stansummary Command</a></li>
<li class="chapter" data-level="16.2" data-path="stansummary.html"><a href="stansummary.html#running-the-stansummary-program"><i class="fa fa-check"></i><b>16.2</b> Running the <code>stansummary</code> Program</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="stansummary.html"><a href="stansummary.html#sampler-parameters"><i class="fa fa-check"></i><b>16.2.1</b> Sampler Parameters</a></li>
<li class="chapter" data-level="16.2.2" data-path="stansummary.html"><a href="stansummary.html#model-parameters-and-quantities-of-interest"><i class="fa fa-check"></i><b>16.2.2</b> Model Parameters and Quantities of Interest</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="stansummary.html"><a href="stansummary.html#command-line-options"><i class="fa fa-check"></i><b>16.3</b> Command-line Options</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="diagnose.html"><a href="diagnose.html"><i class="fa fa-check"></i><b>17</b> <code>diagnose</code>: Diagnosing Biased Hamiltonian Monte Carlo Inferences</a>
<ul>
<li class="chapter" data-level="17.1" data-path="diagnose.html"><a href="diagnose.html#building-the-diagnose-command"><i class="fa fa-check"></i><b>17.1</b> Building the diagnose Command</a></li>
<li class="chapter" data-level="17.2" data-path="diagnose.html"><a href="diagnose.html#running-the-diagnose-command"><i class="fa fa-check"></i><b>17.2</b> Running the diagnose Command</a></li>
<li class="chapter" data-level="17.3" data-path="diagnose.html"><a href="diagnose.html#diagnose-warnings-and-recommendations"><i class="fa fa-check"></i><b>17.3</b> <code>diagnose</code> Warnings and Recommendations</a>
<ul>
<li class="chapter" data-level="17.3.1" data-path="diagnose.html"><a href="diagnose.html#divergent-transitions-after-warmup"><i class="fa fa-check"></i><b>17.3.1</b> Divergent transitions after warmup</a></li>
<li class="chapter" data-level="17.3.2" data-path="diagnose.html"><a href="diagnose.html#maximum-treedepth-exceeded"><i class="fa fa-check"></i><b>17.3.2</b> Maximum treedepth exceeded</a></li>
<li class="chapter" data-level="17.3.3" data-path="diagnose.html"><a href="diagnose.html#low-e-bfmi-values---sampler-transitions-hmc-potential-energy."><i class="fa fa-check"></i><b>17.3.3</b> Low E-BFMI values - sampler transitions HMC potential energy.</a></li>
<li class="chapter" data-level="17.3.4" data-path="diagnose.html"><a href="diagnose.html#low-effective-sample-sizes"><i class="fa fa-check"></i><b>17.3.4</b> Low effective sample sizes</a></li>
<li class="chapter" data-level="17.3.5" data-path="diagnose.html"><a href="diagnose.html#high-hatr"><i class="fa fa-check"></i><b>17.3.5</b> High <span class="math inline">\(\hat{R}\)</span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="print-deprecated-mcmc-output-analysis.html"><a href="print-deprecated-mcmc-output-analysis.html"><i class="fa fa-check"></i><b>18</b> <code>print</code> (deprecated): MCMC Output Analysis</a></li>
<li><a href="appendices.html#appendices"><i style='font-size: 110%; color:#990017;'>Appendices</i></a></li>
<li class="chapter" data-level="19" data-path="stan-csv.html"><a href="stan-csv.html"><i class="fa fa-check"></i><b>19</b> Stan CSV File Format</a>
<ul>
<li class="chapter" data-level="19.1" data-path="stan-csv.html"><a href="stan-csv.html#csv-column-names-and-order"><i class="fa fa-check"></i><b>19.1</b> CSV Column Names and Order</a></li>
<li class="chapter" data-level="19.2" data-path="stan-csv.html"><a href="stan-csv.html#mcmc-sampler-csv-output"><i class="fa fa-check"></i><b>19.2</b> MCMC Sampler CSV Output</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="stan-csv.html"><a href="stan-csv.html#sampler-stan-csv-output-file"><i class="fa fa-check"></i><b>19.2.1</b> Sampler Stan CSV output file</a></li>
<li class="chapter" data-level="19.2.2" data-path="stan-csv.html"><a href="stan-csv.html#diagnostic-csv-output-file"><i class="fa fa-check"></i><b>19.2.2</b> Diagnostic CSV output file</a></li>
</ul></li>
<li class="chapter" data-level="19.3" data-path="stan-csv.html"><a href="stan-csv.html#optimization-output"><i class="fa fa-check"></i><b>19.3</b> Optimization Output</a></li>
<li class="chapter" data-level="19.4" data-path="stan-csv.html"><a href="stan-csv.html#variational-inference-output"><i class="fa fa-check"></i><b>19.4</b> Variational Inference Output</a></li>
<li class="chapter" data-level="19.5" data-path="stan-csv.html"><a href="stan-csv.html#generate-quantities-outputs"><i class="fa fa-check"></i><b>19.5</b> Generate Quantities Outputs</a></li>
<li class="chapter" data-level="19.6" data-path="stan-csv.html"><a href="stan-csv.html#diagnose-method-outputs"><i class="fa fa-check"></i><b>19.6</b> Diagnose Method Outputs</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="json.html"><a href="json.html"><i class="fa fa-check"></i><b>20</b> JSON Format for CmdStan</a>
<ul>
<li class="chapter" data-level="20.1" data-path="json.html"><a href="json.html#creating-json-files"><i class="fa fa-check"></i><b>20.1</b> Creating JSON Files</a></li>
<li class="chapter" data-level="20.2" data-path="json.html"><a href="json.html#json-syntax-summary"><i class="fa fa-check"></i><b>20.2</b> JSON Syntax Summary</a></li>
<li class="chapter" data-level="20.3" data-path="json.html"><a href="json.html#stan-data-types-in-json-notation"><i class="fa fa-check"></i><b>20.3</b> Stan Data Types in JSON Notation</a>
<ul>
<li class="chapter" data-level="20.3.1" data-path="json.html"><a href="json.html#empty-arrays-in-json"><i class="fa fa-check"></i><b>20.3.1</b> Empty arrays in JSON</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="rdump.html"><a href="rdump.html"><i class="fa fa-check"></i><b>21</b> RDump Format for CmdStan</a>
<ul>
<li class="chapter" data-level="21.1" data-path="rdump.html"><a href="rdump.html#creating-dump-files"><i class="fa fa-check"></i><b>21.1</b> Creating Dump Files</a></li>
<li class="chapter" data-level="21.2" data-path="rdump.html"><a href="rdump.html#scalar-variables"><i class="fa fa-check"></i><b>21.2</b> Scalar Variables</a></li>
<li class="chapter" data-level="21.3" data-path="rdump.html"><a href="rdump.html#sequence-variables"><i class="fa fa-check"></i><b>21.3</b> Sequence Variables</a></li>
<li class="chapter" data-level="21.4" data-path="rdump.html"><a href="rdump.html#array-variables"><i class="fa fa-check"></i><b>21.4</b> Array Variables</a></li>
<li class="chapter" data-level="21.5" data-path="rdump.html"><a href="rdump.html#matrix--and-vector-valued-variables"><i class="fa fa-check"></i><b>21.5</b> Matrix- and Vector-Valued Variables</a>
<ul>
<li class="chapter" data-level="21.5.1" data-path="rdump.html"><a href="rdump.html#vector-dump-format"><i class="fa fa-check"></i><b>21.5.1</b> Vector Dump Format</a></li>
<li class="chapter" data-level="21.5.2" data-path="rdump.html"><a href="rdump.html#matrix-dump-format"><i class="fa fa-check"></i><b>21.5.2</b> Matrix Dump Format</a></li>
<li class="chapter" data-level="21.5.3" data-path="rdump.html"><a href="rdump.html#arrays-of-vectors-and-matrices"><i class="fa fa-check"></i><b>21.5.3</b> Arrays of Vectors and Matrices</a></li>
</ul></li>
<li class="chapter" data-level="21.6" data-path="rdump.html"><a href="rdump.html#integer--and-real-valued-variables"><i class="fa fa-check"></i><b>21.6</b> Integer- and Real-Valued Variables</a>
<ul>
<li class="chapter" data-level="21.6.1" data-path="rdump.html"><a href="rdump.html#scientific-notation"><i class="fa fa-check"></i><b>21.6.1</b> Scientific Notation</a></li>
<li class="chapter" data-level="21.6.2" data-path="rdump.html"><a href="rdump.html#infinite-and-not-a-number-values"><i class="fa fa-check"></i><b>21.6.2</b> Infinite and Not-a-Number Values</a></li>
</ul></li>
<li class="chapter" data-level="21.7" data-path="rdump.html"><a href="rdump.html#quoted-variable-names"><i class="fa fa-check"></i><b>21.7</b> Quoted Variable Names</a></li>
<li class="chapter" data-level="21.8" data-path="rdump.html"><a href="rdump.html#line-breaks"><i class="fa fa-check"></i><b>21.8</b> Line Breaks</a></li>
<li class="chapter" data-level="21.9" data-path="rdump.html"><a href="rdump.html#bnf-grammar-for-dump-data"><i class="fa fa-check"></i><b>21.9</b> BNF Grammar for Dump Data</a></li>
</ul></li>
<li><a href="bibliography.html#bibliography"><i style='font-size: 110%; color:#990017;'>Bibliography</i></a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CmdStan User’s Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">

<div>
This is an old version, <a href="https://mc-stan.org/docs/cmdstan-guide/mcmc-config.html">view current version</a>.
</div>
<div id="mcmc-config" class="section level1">
<h1><span class="header-section-number">9</span> MCMC Sampling using Hamiltonian Monte Carlo</h1>
<p>The <code>sample</code> method provides Bayesian inference over the model conditioned on data
using Hamiltonian Monte Carlo (HMC) sampling. By default, the inference engine used is
the No-U-Turn sampler (NUTS), an adaptive form of Hamiltonian Monte Carlo sampling.
For details on HMC and NUTS, see the Stan Reference Manual chapter on
<a href="https://mc-stan.org/docs/reference-manual/hmc-chapter.html">MCMC Sampling</a>.</p>
<p>The full set of configuration options available for the <code>sample</code> method is
reported at the beginning of the sampler output file as CSV comments.
When the example model <code>bernoulli.stan</code> is run via the command line
with all default arguments,
the resulting Stan CSV file header comments show the complete set
of default configuration options:</p>
<pre><code># model = bernoulli_model
# method = sample (Default)
#   sample
#     num_samples = 1000 (Default)
#     num_warmup = 1000 (Default)
#     save_warmup = 0 (Default)
#     thin = 1 (Default)
#     adapt
#       engaged = 1 (Default)
#       gamma = 0.05 (Default)
#       delta = 0.8 (Default)
#       kappa = 0.75 (Default)
#       t0 = 10 (Default)
#       init_buffer = 75 (Default)
#       term_buffer = 50 (Default)
#       window = 25 (Default)
#     algorithm = hmc (Default)
#       hmc
#         engine = nuts (Default)
#           nuts
#             max_depth = 10 (Default)
#         metric = diag_e (Default)
#         metric_file =  (Default)
#         stepsize = 1 (Default)
#         stepsize_jitter = 0 (Default)</code></pre>
<div id="iterations" class="section level2">
<h2><span class="header-section-number">9.1</span> Iterations</h2>
<p>At every sampler iteration, the sampler returns a set of estimates
for all parameters and quantities of interest in the model.
During warmup, the NUTS algorithm adjusts the HMC algorithm parameters
<code>metric</code> and <code>stepsize</code> in order to efficiently sample from
<em>typical set</em>, the neighborhood substantial posterior probability mass
through which the Markov chain will travel in equilibrium.
After warmup, the fixed metric and stepsize are used to produce
a set of draws.</p>
<p>The following keyword-value arguments control the total number of iterations:</p>
<ul>
<li><code>num_samples</code></li>
<li><code>num_warmup</code></li>
<li><code>save_warmup</code></li>
<li><code>thin</code></li>
</ul>
<p>The values for arguments <code>num_samples</code> and <code>num_warmup</code> must be a non-negative integer.
The default value for both is <span class="math inline">\(1000\)</span>.</p>
<p>For well-specified models and data, the sampler may converge faster and this many
warmup iterations may be overkill. Conversely, complex models which have difficult
posterior geometries may require more warmup iterations in order to arrive at good
values for the step size and metric.</p>
<p>The number of sampling iterations to runs depends on the effective sample size (EFF)
reported for each parameter and the desired precision of your estimates.
An EFF of at least 100 is required to make a viable estimate. The precision of your
estimate is <span class="math inline">\(\sqrt{N}\)</span>; therefore every additional decimal place of accuracy increases
this by a factor of 10.</p>
<p>Argument <code>save_warmup</code> takes values <span class="math inline">\(0\)</span> or <span class="math inline">\(1\)</span>, corresponding to <code>False</code> and <code>True</code> respectively.
The default value is <span class="math inline">\(0\)</span>, i.e., warmup draws are not saved to the output file.
When the value is <span class="math inline">\(1\)</span>, the warmup draws are written to the CSV output file
directly after the CSV header line.</p>
<p>Argument <code>thin</code> controls the number of draws from the posterior written to the output file.
Some users familiar with older approaches to MCMC sampling might be used to thinning
to eliminate an expected autocorrelation in the samples.
HMC is not nearly as susceptible to this autocorrelation problem and thus
thinning is generally not required nor advised,
as HMC can produce <em>anticorrelated</em> draws, which increase the
effective sample size beyond the number of draws from the posterior.
Thinning should only be used in circumstances where storage of the samples
is limited and/or RAM for later processing the samples is limited.</p>
<p>The value of argument <code>thin</code> must be a positive integer. When thin is set to value <span class="math inline">\(N\)</span>,
every <span class="math inline">\(N^{th}\)</span> iteration is written to the output file.
Should the value of <code>thin</code> exceed the specified number of iterations, the first iteration is
saved to the output. This is because the iteration counter starts from zero and whenever
the counter modulo the value of <code>thin</code> equals zero, the iteration is saved to the output file.
Since zero modulo any positive integer is zero, the first iteration is always saved.
When <code>num_sampling=M</code> and <code>thin=N</code>, the number of iterations written to the
output CSV file will be <code>ceiling(M/N)</code>.
If <code>save_warmup=1</code>, thinning is applied to the warmup iterations as well.</p>
</div>
<div id="adaptation" class="section level2">
<h2><span class="header-section-number">9.2</span> Adaptation</h2>
<p>The <code>adapt</code> keyword is used to specify non-default options for
the sampler adaptation schedule and settings.</p>
<p>Adaptation can be turned off by setting sub-argument <code>engaged</code> to value <span class="math inline">\(0\)</span>.
If <code>engaged=0</code>, no adaptation will be done, and all other adaptation sub-arguments will be ignored.
Since the default argument is <code>engaged=1</code>, this keyword-value pair can be omitted from the command.</p>
<p>There are two sets of adaptation sub-arguments: step size optimization parameters and the warmup schedule.
These are described in detail in the Reference Manual section
<a href="https://mc-stan.org/docs/2_23/reference-manual/hmc-algorithm-parameters.html">Automatic Parameter Tuning</a>.</p>
<div id="step-size-optimization-configuration" class="section level3">
<h3><span class="header-section-number">9.2.1</span> Step size optimization configuration</h3>
<p>The Stan User’s Guide section on
<a href="https://mc-stan.org/docs/stan-users-guide/model-conditioning-and-curvature.html">model conditioning and curvature</a>
provides a discussion of adaptation and stepsize issues.
The Stan Reference Manual section on
<a href="https://mc-stan.org/docs/reference-manual/hmc-algorithm-parameters.html">HMC algorithm parameters</a>
explains the NUTS-HMC adaptation schedule and the tuning parameters for setting the step size.</p>
<p>The following keyword-value arguments control the settings used to optimize the step size:</p>
<ul>
<li><p><code>delta</code> - The target Metropolis acceptance rate. The default value is <span class="math inline">\(0.8\)</span>.
Its value must be strictly between <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span>.
Increasing the default value
forces the algorithm to use smaller step sizes. This can
improve sampling efficiency (effective sample size per iteration) at
the cost of increased iteration times. Raising the value of <code>delta</code>
will also allow some models that would otherwise get stuck to overcome
their blockages. <br>
Models with difficult posterior geometries may required increasing the <code>delta</code> argument
closer to <span class="math inline">\(1\)</span>; we recommend first trying to raise it to <span class="math inline">\(0.9\)</span> or at most <span class="math inline">\(0.95\)</span>.
Values about <span class="math inline">\(0.95\)</span> are strong indication of bad geometry;
the better solution is to change the model geometry through
<a href="https://mc-stan.org/docs/stan-users-guide/reparameterization-section.html">reparameterization</a>
which could yield both more efficient and faster sampling.</p></li>
<li><p><code>gamma</code> - Adaptation regularization scale.
Must be a positive real number, default value is <span class="math inline">\(0.05\)</span>.
This is a parameter of the Nesterov dual-averaging algorithm.
We recommend always using the default value.</p></li>
<li><p><code>kappa</code> - Adaptation relaxation exponent.
Must be a positive real number, default value is <span class="math inline">\(0.75\)</span>.
This is a parameter of the Nesterov dual-averaging algorithm.
We recommend always using the default value.</p></li>
<li><p><code>t_0</code> - Adaptation iteration offset.
Must be a positive real number, default value is <span class="math inline">\(10\)</span>.
This is a parameter of the Nesterov dual-averaging algorithm.
We recommend always using the default value.</p></li>
</ul>
</div>
<div id="warmup-schedule-configuration" class="section level3">
<h3><span class="header-section-number">9.2.2</span> Warmup schedule configuration</h3>
<p>When adaptation is engaged, the warmup schedule is specified by sub-arguments,
all of which take positive integers as values:</p>
<ul>
<li><code>init_buffer</code> - The number of iterations spent tuning the step size at the outset of adaptation.</li>
<li><code>window</code> - The initial number of iterations devoted to tune the metric, will be doubled successively.</li>
<li><code>term_buffer</code> - The number of iterations used to re-tune the step size once the metric has been tuned.</li>
</ul>
<p>The specified values may be modified slightly in order to ensure alignment
between the warmup schedule and total number of warmup iterations.</p>
<p>The following figure is taken from the Stan Reference Manual,
where label “I” correspond to <code>init_buffer</code>, the initial “II” corresponds to <code>window</code>,
and the final “III” corresponds to <code>term_buffer</code>:</p>
<p><strong>Warmup Epochs Figure.</strong> <a id="adaptation.figure"></a>
<em>Adaptation during warmup occurs in three stages: an initial fast
adaptation interval (I), a series of expanding slow adaptation
intervals (II), and a final fast adaptation interval (III). For HMC,
both the fast and slow intervals are used for adapting the step size,
while the slow intervals are used for learning the (co)variance
necessitated by the metric. Iteration numbering starts at 1 on the
left side of the figure and increases to the right.</em></p>
<p><img src="img/warmup-epochs.png" /></p>
</div>
</div>
<div id="algorithm" class="section level2">
<h2><span class="header-section-number">9.3</span> Algorithm</h2>
<p>The <code>algorithm</code> keyword-value pair specifies the algorithm used to generate the sample.
There are two possible values: <code>hmc</code>, which generates from an HMC-driven Markov chain;
and <code>fixed_param</code> which generates a new sample without changing the state of the Markov chain.
The default argument is <code>algorithm=hmc</code>.</p>
<div id="samples-from-a-set-of-fixed-parameters" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Samples from a set of fixed parameters</h3>
<p>If a model doesn’t specify any parameters, then argument <code>algorithm=fixed_param</code> is mandatory.</p>
<p>The fixed parameter sampler generates a new sample without changing the current state of the Markov chain.
This can be used to write models which generate pseudo-data via calls to RNG functions
in the transformed data and generated quantities blocks.</p>
</div>
<div id="hmc-samplers" class="section level3">
<h3><span class="header-section-number">9.3.2</span> HMC samplers</h3>
<p>All HMC algorithms have three parameters:</p>
<ul>
<li>step size</li>
<li>metric</li>
<li>integration time - the number of steps taken along the Hamiltonian trajectory</li>
</ul>
<p>See the Stan Reference Manual section on
<a href="https://mc-stan.org/docs/reference-manual/hmc-algorithm-parameters.html">HMC algorithm parameters</a>
for further details.</p>
<div id="step-size" class="section level4">
<h4><span class="header-section-number">9.3.2.1</span> Step size</h4>
<p>The HMC algorithm simulates the evolution of a Hamiltonian system.
The step size parameter controls the resolution of the sampler.
Low step sizes can get HMC samplers unstuck that would otherwise get stuck with higher step sizes.</p>
<p>The following keyword-value arguments control the step size:</p>
<ul>
<li><p><code>stepsize</code> - How far to move each time the Hamiltonian system evolves forward.
Must be a positive real number, default value is <span class="math inline">\(1\)</span>.</p></li>
<li><p><code>stepsize_jitter</code> - Allows step size to be “jittered” randomly during sampling
to avoid any poor interactions with a fixed step size and regions of high curvature.
Must be a real value between <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span>. The default value is <span class="math inline">\(0\)</span>.
Setting <code>stepsize_jitter</code> to <span class="math inline">\(1\)</span> causes step sizes to be selected in the range of <span class="math inline">\(0\)</span>
to twice the adapted step size.
Jittering below the adapted value will increase the number of steps required and will
slow down sampling, while jittering above the adapted value can cause premature rejection
due to simulation error in the Hamiltonian dynamics calculation.
We strongly recommend always using the default value.</p></li>
</ul>
</div>
<div id="metric" class="section level4">
<h4><span class="header-section-number">9.3.2.2</span> Metric</h4>
<p>All HMC implementations in Stan utilize quadratic kinetic energy
functions which are specified up to the choice of a symmetric,
positive-definite matrix known as a <em>mass matrix</em> or, more
formally, a <em>metric</em> <span class="citation">Betancourt (<a href="#ref-Betancourt:2017" role="doc-biblioref">2017</a>)</span>.</p>
<p>The <code>metric</code> argument specifies the choice of Euclidean HMC implementations:</p>
<ul>
<li><code>metric=unit</code> specifies unit metric (diagonal matrix of ones).</li>
<li><code>metric=diag_e</code> specifies a diagonal metric (diagonal matrix with positive diagonal entries).
This is the default value.</li>
<li><code>metric=dense_e</code> specifies a dense metric (a dense, symmetric positive definite matrix).</li>
</ul>
<p>By default, the metric is estimated during warmup.
However, when <code>metric=diag_e</code> or <code>metric=dense_e</code>, an initial guess for the metric can be specified
with the <code>metric_file</code> argument whose value is the filepath to a JSON or Rdump file which
contains a single variable <code>inv_metric</code>.
For a <code>diag_e</code> metric the <code>inv_metric</code> value must be a vector of positive values, one for each parameter in the system.
For a <code>dense_e</code> metric, <code>inv_metric</code> value must be a positive-definite square matrix
with number of rows and columns equal to the number of parameters in the model.</p>
<p>The <code>metric_file</code> option can be used with and without adaptation enabled.
If adaptation is enabled, the provided metric will be used as the initial guess in the adaptation process.
If the initial guess is good, then adaptation should not change it much.
If the metric is no good, then the adaptation will override the initial guess.</p>
<p>If adaptation is disabled, both the <code>metric_file</code> and <code>stepsize</code> arguments should be specified.</p>
</div>
<div id="integration-time" class="section level4">
<h4><span class="header-section-number">9.3.2.3</span> Integration Time</h4>
<p>The total integration time is determined by the argument <code>engine</code>
which take possible values:</p>
<ul>
<li><code>nuts</code> - the No-U-Turn Sampler which dynamically determines the optimal integration time.</li>
<li><code>static</code> - an HMC sampler which uses a user-specified integration time.</li>
</ul>
<p>The default argument is <code>engine=nuts</code>.</p>
<p>The NUTS sampler generates a proposal by starting at an initial position determined
by the parameters drawn in the last iteration. It then evolves the initial system both
forwards and backwards in time to form a balanced binary tree. The algorithm is iterative;
at each iteration the tree depth is increased by one, doubling the number of leapfrog steps
thus effectively doubling the computation time.
The algorithm terminates in one of two ways: either
the NUTS criterion (i.e., a U-turn in Euclidean space on a subtree)
is satisfied for a new subtree or the completed tree;
or the depth of the completed tree hits the maximum depth allowed.</p>
<p>When <code>engine=nuts</code>, the subargument <code>max_depth</code> can be used to control the depth of the tree.
The default argument is <code>max_depth=10</code>.
In the case where a model has a difficult posterior from which to sample,
<code>max_depth</code> should be increased to ensure that that the NUTS tree can grow as large as necessary.</p>
<p>When the argument <code>engine=static</code> is specified,
the user must specify the integration time via keyword <code>int_time</code>
which takes as a value a positive number.
The default value is <span class="math inline">\(2\pi\)</span>.</p>
</div>
</div>
</div>
<div id="sampler-diag-file" class="section level2">
<h2><span class="header-section-number">9.4</span> Sampler Diagnostic File</h2>
<p>The <code>output</code> keyword sub-argument <code>diagnostic_file=&lt;filepath&gt;</code>
specifies the location of the auxiliary output file which contains sampler information for each draw,
and the gradients on the unconstrained scale and log probabilities for all parameters in the model.
By default, no auxiliary output file is produced.</p>
</div>
<div id="examples" class="section level2">
<h2><span class="header-section-number">9.5</span> Examples</h2>
<p>The Quickstart Guide <a href="mcmc-intro.html#mcmc-intro">MCMC Sampling chapter</a> section on multiple chains
showed how to run multiple chains given a model and data, using the minimal required
command line options: the method, the name of the data file, and a chain-specific name for the output file.</p>
<p>To run 4 chains in parallel on Mac OS and Linux, the syntax in both bash and zsh is the same:</p>
<pre><code>&gt; for i in {1..4}
    do
      ./bernoulli sample data file=my_model.data.json \
                  output file=output_${i}.csv &amp;
    done</code></pre>
<p>The backslash (<code>\</code>) indicates a line continuation in Unix.
The expression <code>${i}</code> substitutes in the value of loop index variable <code>i</code>.
The ampersand (<code>&amp;</code>) pushes each process into the background which allows the loop to continue
without waiting for the current chain to finish.</p>
<p>On Windows the corresponding loop is:</p>
<pre><code>&gt;for /l %i in (1, 1, 4) do start /b bernoulli.exe sample ^
                                    data file=my_model.data.json my_data ^
                                    output file=output_%i.csv</code></pre>
<p>The caret (<code>^</code>) indicates a line continuation in DOS.
The expression <code>%i</code> is the loop index.</p>
<p>In the following examples, we focus on just the nested sampler command for Unix.</p>
<div id="running-multiple-chains-with-a-specified-rng-seed" class="section level3">
<h3><span class="header-section-number">9.5.1</span> Running multiple chains with a specified RNG seed</h3>
<p>For reproducibility, we specify the same RNG seed across all chains and use
the chain id argument to specify the RNG offset.</p>
<p>The RNG seed is specified by <code>random seed=&lt;int&gt;</code> and the offset is specified
by <code>id=&lt;loop index&gt;</code>, so the call to the sampler is:</p>
<pre><code>./my_model sample data file=my_model.data.json \
            output file=output_${i}.csv \
            random seed=12345 id=${i}</code></pre>
</div>
<div id="changing-the-default-warmup-and-sampling-iterations" class="section level3">
<h3><span class="header-section-number">9.5.2</span> Changing the default warmup and sampling iterations</h3>
<p>The warmup and sampling iteration keyword-value arguments must follow the <code>sample</code> keyword.
The call to the sampler which overrides the default warmup and sampling iterations is:</p>
<pre><code>./my_model sample num_warmup=500 num_sampling=500 \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
</div>
<div id="saving-warmup-draws" class="section level3">
<h3><span class="header-section-number">9.5.3</span> Saving warmup draws</h3>
<p>To save warmup draws as part of the Stan CSV output file,
use the keyword-value argument <code>save_warmup=1</code>.
This must be grouped with the other <code>sample</code> keyword sub-arguments.</p>
<pre><code>./my_model sample num_warmup=500 num_sampling=500 save_warmup=1 \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
</div>
<div id="initializing-parameters" class="section level3">
<h3><span class="header-section-number">9.5.4</span> Initializing parameters</h3>
<p>By default, all parameters are initialized on an unconstrained scale
to random draws from a uniform distribution over the range <span class="math inline">\([{-2}, 2]\)</span>.
To initialize some or all parameters to good starting points on the constrained scale from
a data file in JSON or Rdump format, use the keyword-value argument <code>init=&lt;filepath&gt;</code>:</p>
<pre><code>./my_model sample init=my_param_inits.json data file=my_model.data.json \
           output file=output_${i}.csv</code></pre>
<p>To verify that the specified values will be used by the sampler, you can
run the sampler with option <code>algorithm=fixed_param</code>, so that the initial values
are used to generate the sample. Since this generates a set of idential draws,
setting <code>num_warmp=0</code> and <code>num_samples=1</code> will save unnecessary iterations.
As the output values are also on the constrained scale, the set of reported values
will match the set of specified initial values.</p>
<p>For example, if we run the example Bernoulli model with specified initial value
for parameter “theta”:</p>
<pre><code>{ &quot;theta&quot; : 0.5 }</code></pre>
<p>via command:</p>
<pre><code>./bernoulli sample algorithm=fixed_param num_warmup=0 num_samples=1 \
            init=bernoulli.init.json data file=bernoulli.data.json</code></pre>
<p>The resulting output CSV file contains a single draw:</p>
<pre><code>lp__,accept_stat__,theta
0,0,0.5
# 
#  Elapsed Time: 0 seconds (Warm-up)
#                0 seconds (Sampling)
#                0 seconds (Total)
# </code></pre>
</div>
<div id="specifying-the-metric-and-stepsize" class="section level3">
<h3><span class="header-section-number">9.5.5</span> Specifying the metric and stepsize</h3>
<p>An initial guess for the metric can be specified with the <code>metric_file</code> argument
whose value is the filepath to a JSON or Rdump file which contains a single variable <code>inv_metric</code>.
The <code>metric_file</code> option can be used with and without adaptation enabled.</p>
<p>By default, the metric is estimated during warmup adaptation.
If the initial guess is good, then adaptation should not change it much.
If the metric is no good, then the adaptation will override the initial guess.
For example, the JSON file <code>bernoulli.diag_e.json</code>, contents</p>
<pre><code>{ &quot;inv_metric&quot; : [0.296291] }</code></pre>
<p>can be used as the initial metric as follows:</p>
<pre><code>../my_model sample algorithm=hmc metric_file=bernoulli.diag_e.json \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
<p>If adaptation is disabled, both the <code>metric_file</code> and <code>stepsize</code> arguments should be specified.</p>
<pre><code>../my_model sample adapt engaged=0 \
            algorithm=hmc stepsize=0.9 \
            metric_file=bernoulli.diag_e.json \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
<p>The resulting output CSV file will contain the following set of comment lines:</p>
<pre><code># Adaptation terminated
# Step size = 0.9
# Diagonal elements of inverse mass matrix:
# 0.296291</code></pre>
</div>
<div id="changing-the-nuts-hmc-adaptation-parameters" class="section level3">
<h3><span class="header-section-number">9.5.6</span> Changing the NUTS-HMC adaptation parameters</h3>
<p>The keyword-value arguments for these settings are grouped together under the <code>adapt</code> keyword
which itself is a sub-argument of the <code>sample</code> keyword.</p>
<p>Models with difficult posterior geometries may required increasing the <code>delta</code> argument
closer to <span class="math inline">\(1\)</span>.</p>
<pre><code>./my_model sample adapt delta=0.95 \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
<p>To skip adaptation altogether, use the keyword-value argument <code>engaged=0</code>.
Disabling adaptation disables both metric and stepsize adaptation, so a stepsize should be
provided along with a metric to enable efficient sampling.</p>
<pre><code>../my_model sample adapt engaged=0 \
            algorithm=hmc stepsize=0.9 \
            metric_file=bernoulli.diag_e.json \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
<p>Even with adaptation disabled, it is still advisable to run warmup iterations in order to
allow the initial parameter values to be adjusted to estimates which fall within the
<a href="https://mc-stan.org/docs/stan-users-guide/model-conditioning-and-curvature.html">typical set</a>.</p>
<p>To skip warmup altogether requires specifying both <code>num_warmup=0</code> and <code>adapt engaged=0</code>.</p>
<pre><code>../my_model sample num_warmup=0 adapt engaged=0 \
            algorithm=hmc stepsize=0.9 \
            metric_file=bernoulli.diag_e.json \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
</div>
<div id="increasing-the-tree-depth" class="section level3">
<h3><span class="header-section-number">9.5.7</span> Increasing the tree-depth</h3>
<p>Models with difficult posterior geometries may required increasing the <code>max_depth</code> argument from its default value <span class="math inline">\(10\)</span>.
This requires specifying a series of keyword-argument pairs:</p>
<pre><code>./my_model sample adapt delta=0.95 \
            algorithm=hmc engine=nuts max_depth=15 \
            data file=my_model.data.json \
            output file=output_${i}.csv</code></pre>
</div>
<div id="capturing-hamiltonian-diagnostics-and-gradients" class="section level3">
<h3><span class="header-section-number">9.5.8</span> Capturing Hamiltonian diagnostics and gradients</h3>
<p>The <code>output</code> keyword sub-argument <code>diagnostic_file=&lt;filepath&gt;</code>
write the sampler parameters and gradients of all model parameters
for each draw to a CSV file:</p>
<pre><code>./my_model sample data file=my_model.data.json \
            output file=output_${i}.csv \
            diagnostic_file=diagnostics_${i}.csv</code></pre>
</div>
<div id="suppressing-progress-updates-to-the-console" class="section level3">
<h3><span class="header-section-number">9.5.9</span> Suppressing progress updates to the console</h3>
<p>The <code>output</code> keyword sub-argument <code>refresh=&lt;int&gt;</code> specifies the
number of iterations between progress messages written to the terminal window.
The default value is <span class="math inline">\(100\)</span> iterations.
The progress updates look like:</p>
<pre><code>Iteration:    1 / 2000 [  0%]  (Warmup)
Iteration:  100 / 2000 [  5%]  (Warmup)
Iteration:  200 / 2000 [ 10%]  (Warmup)
Iteration:  300 / 2000 [ 15%]  (Warmup)</code></pre>
<p>For simple models which fit quickly, such updates can be annoying;
to suppress them altogether, set <code>refresh=0</code>.
This only turns off the <code>Iteration:</code> messages; the configuration
and timing information are still written to the terminal.</p>
<pre><code>./my_model sample data file=my_model.data.json \
            output file=output_${i}.csv \
            refresh=0</code></pre>
<p>For complicated models which take a long time to fit, setting
the refresh rate to a low number, e.g. <span class="math inline">\(10\)</span> or even <span class="math inline">\(1\)</span>, provides a
way to more closely monitor the sampler.</p>
</div>
<div id="everything-example" class="section level3">
<h3><span class="header-section-number">9.5.10</span> Everything Example</h3>
<p>The CmdStan argument parser requires keeping sampler config sub-arguments together;
interleaving sampler config with the inputs, outputs, inits, RNG seed and chain id config
results in an error message such as the following:</p>
<pre><code>./bernoulli sample data file=bernoulli.data.json adapt delta=0.95
adapt is either mistyped or misplaced.
Perhaps you meant one of the following valid configurations?
  method=sample sample adapt
  method=variational variational adapt
Failed to parse arguments, terminating Stan</code></pre>
<p>The following example provides a template for a call to the sampler
which specifies input data, initial parameters, initial step-size and metric,
adaptation, output, and RNG initialization.</p>
<pre><code>./my_model sample num_warmup=2000 \
           init=my_param_inits.json \
           adapt delta=0.95 init_buffer=100 \
           window=50 term_buffer=100 \
           algorithm=hmc engine=nuts max_depth=15 \
           metric=dense_e metric_file=my_metric.json \
           stepsize=0.6555 \
           data file=my_model.data.json \
           output file=output_${i}.csv refresh=10 \
           random seed=12345 id=${i}</code></pre>
<p>The keywords <code>sample</code>, <code>data</code>, <code>output</code>, and <code>random</code> are the top-level argument groups.
Within the <code>sample</code> config arguments, the keyword <code>adapt</code> groups the adaptation algorithm parameters and
the keyword-value <code>algorithm=hmc</code> groups the NUTS-HMC parameters.</p>
<p>The top-level groups can be freely ordered with respect to one another.
The following is also a valid command:</p>
<pre><code>./my_model random seed=12345 id=${i} \
           data file=my_model.data.json \
           output file=output_${i}.csv refresh=10 \
           sample num_warmup=2000 \
           init=my_param_inits.json \
           algorithm=hmc engine=nuts max_depth=15 \
           metric=dense_e metric_file=my_metric.json \
           stepsize=0.6555 \
           adapt delta=0.95 init_buffer=100 \
           window=50 term_buffer=100</code></pre>

</div>
</div>
</div>
<h3><i style='font-size: 110%; color:#990017;'>Bibliography</i></h3>
<div id="refs" class="references">
<div id="ref-Betancourt:2017">
<p>Betancourt, Michael. 2017. “A Conceptual Introduction to Hamiltonian Monte Carlo.” <em>arXiv</em> 1701.02434. <a href="https://arxiv.org/abs/1701.02434">https://arxiv.org/abs/1701.02434</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="command-line-interface-overview.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="maximum-likelihood-estimation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "serif",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"search": true,
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
