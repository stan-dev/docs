<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Constraint Transforms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../reference-manual/syntax.html" rel="next">
<link href="../reference-manual/user-functions.html" rel="prev">
<link href="../img/logo_tm.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 200,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../quarto_styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/logo_tm.png" alt="Stan logo" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../stan-users-guide/index.html"> 
<span class="menu-text">Stan Users Guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../reference-manual/index.html" aria-current="page"> 
<span class="menu-text">Reference Manual</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../functions-reference/index.html"> 
<span class="menu-text">Functions Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-interfaces" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Interfaces</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-interfaces">    
        <li>
    <a class="dropdown-item" href="../cmdstan-guide/index.html">
 <span class="dropdown-text">CmdStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanpy">
 <span class="dropdown-text">CmdStanPy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanr">
 <span class="dropdown-text">CmdStanR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/users/interfaces/pystan.html">
 <span class="dropdown-text">PyStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstan">
 <span class="dropdown-text">RStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="http://stanjulia.github.io/Stan.jl/stable/INTRO/">
 <span class="dropdown-text">Stan.jl</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-other-packages" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Other Packages</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-other-packages">    
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/bayesplot/">
 <span class="dropdown-text">bayesplot</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://roualdes.github.io/bridgestan/latest/">
 <span class="dropdown-text">BridgeStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://paul-buerkner.github.io/brms/">
 <span class="dropdown-text">brms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/loo/">
 <span class="dropdown-text">loo</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/posterior">
 <span class="dropdown-text">posterior</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/projpred">
 <span class="dropdown-text">projpred</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstanarm">
 <span class="dropdown-text">rstanarm</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstantools">
 <span class="dropdown-text">rstantools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/shinystan">
 <span class="dropdown-text">shinystan</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/stan-dev" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://discourse.mc-stan.org" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-chat-text-fill"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../reference-manual/encoding.html">Language</a></li><li class="breadcrumb-item"><a href="../reference-manual/transforms.html">Constraint Transforms</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stan Reference Manual</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Version 2.43</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Language</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/encoding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Character Encoding</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/includes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Includes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/comments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/whitespace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Whitespace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Types and Declarations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/expressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Expressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/statements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/blocks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Blocks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/user-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User-Defined Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/transforms.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Constraint Transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/syntax.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Language Syntax</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Execution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/deprecations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deprecated Features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/removals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Removed Features</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Algorithms</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCMC Sampling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Posterior Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/pathfinder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pathfinder</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/variational.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/laplace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laplace Approximation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagnostic Mode</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Usage</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/reproducibility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducibility</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/licenses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Licenses and Dependencies</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#variable-transforms.chapter" id="toc-variable-transforms.chapter" class="nav-link active" data-scroll-target="#variable-transforms.chapter">Constraint Transforms</a>
  <ul class="collapse">
  <li><a href="#change-of-variables.section" id="toc-change-of-variables.section" class="nav-link" data-scroll-target="#change-of-variables.section">Changes of variables</a>
  <ul class="collapse">
  <li><a href="#univariate-changes-of-variables" id="toc-univariate-changes-of-variables" class="nav-link" data-scroll-target="#univariate-changes-of-variables">Univariate changes of variables</a></li>
  <li><a href="#multivariate-changes-of-variables" id="toc-multivariate-changes-of-variables" class="nav-link" data-scroll-target="#multivariate-changes-of-variables">Multivariate changes of variables</a></li>
  </ul></li>
  <li><a href="#lower-bound-transform.section" id="toc-lower-bound-transform.section" class="nav-link" data-scroll-target="#lower-bound-transform.section">Lower bounded scalar</a>
  <ul class="collapse">
  <li><a href="#lower-bound-transform" id="toc-lower-bound-transform" class="nav-link" data-scroll-target="#lower-bound-transform">Lower bound transform</a></li>
  <li><a href="#lower-bound-inverse-transform" id="toc-lower-bound-inverse-transform" class="nav-link" data-scroll-target="#lower-bound-inverse-transform">Lower bound inverse transform</a></li>
  <li><a href="#absolute-derivative-of-the-lower-bound-inverse-transform" id="toc-absolute-derivative-of-the-lower-bound-inverse-transform" class="nav-link" data-scroll-target="#absolute-derivative-of-the-lower-bound-inverse-transform">Absolute derivative of the lower bound inverse transform</a></li>
  </ul></li>
  <li><a href="#upper-bounded-scalar" id="toc-upper-bounded-scalar" class="nav-link" data-scroll-target="#upper-bounded-scalar">Upper bounded scalar</a>
  <ul class="collapse">
  <li><a href="#upper-bound-transform" id="toc-upper-bound-transform" class="nav-link" data-scroll-target="#upper-bound-transform">Upper bound transform</a></li>
  <li><a href="#upper-bound-inverse-transform" id="toc-upper-bound-inverse-transform" class="nav-link" data-scroll-target="#upper-bound-inverse-transform">Upper bound inverse transform</a></li>
  <li><a href="#absolute-derivative-of-the-upper-bound-inverse-transform" id="toc-absolute-derivative-of-the-upper-bound-inverse-transform" class="nav-link" data-scroll-target="#absolute-derivative-of-the-upper-bound-inverse-transform">Absolute derivative of the upper bound inverse transform</a></li>
  </ul></li>
  <li><a href="#logit-transform-jacobian.section" id="toc-logit-transform-jacobian.section" class="nav-link" data-scroll-target="#logit-transform-jacobian.section">Lower and upper bounded scalar</a>
  <ul class="collapse">
  <li><a href="#log-odds-and-the-logistic-sigmoid" id="toc-log-odds-and-the-logistic-sigmoid" class="nav-link" data-scroll-target="#log-odds-and-the-logistic-sigmoid">Log odds and the logistic sigmoid</a></li>
  <li><a href="#lower-and-upper-bounds-transform" id="toc-lower-and-upper-bounds-transform" class="nav-link" data-scroll-target="#lower-and-upper-bounds-transform">Lower and upper bounds transform</a></li>
  <li><a href="#lower-and-upper-bounds-inverse-transform" id="toc-lower-and-upper-bounds-inverse-transform" class="nav-link" data-scroll-target="#lower-and-upper-bounds-inverse-transform">Lower and upper bounds inverse transform</a></li>
  <li><a href="#absolute-derivative-of-the-lower-and-upper-bounds-inverse-transform" id="toc-absolute-derivative-of-the-lower-and-upper-bounds-inverse-transform" class="nav-link" data-scroll-target="#absolute-derivative-of-the-lower-and-upper-bounds-inverse-transform">Absolute derivative of the lower and upper bounds inverse transform</a></li>
  </ul></li>
  <li><a href="#affinely-transformed-scalar" id="toc-affinely-transformed-scalar" class="nav-link" data-scroll-target="#affinely-transformed-scalar">Affinely transformed scalar</a>
  <ul class="collapse">
  <li><a href="#affine-transform" id="toc-affine-transform" class="nav-link" data-scroll-target="#affine-transform">Affine transform</a></li>
  <li><a href="#affine-inverse-transform" id="toc-affine-inverse-transform" class="nav-link" data-scroll-target="#affine-inverse-transform">Affine inverse transform</a></li>
  <li><a href="#absolute-derivative-of-the-affine-inverse-transform" id="toc-absolute-derivative-of-the-affine-inverse-transform" class="nav-link" data-scroll-target="#absolute-derivative-of-the-affine-inverse-transform">Absolute derivative of the affine inverse transform</a></li>
  </ul></li>
  <li><a href="#ordered-vector" id="toc-ordered-vector" class="nav-link" data-scroll-target="#ordered-vector">Ordered vector</a>
  <ul class="collapse">
  <li><a href="#ordered-transform" id="toc-ordered-transform" class="nav-link" data-scroll-target="#ordered-transform">Ordered transform</a></li>
  <li><a href="#ordered-inverse-transform" id="toc-ordered-inverse-transform" class="nav-link" data-scroll-target="#ordered-inverse-transform">Ordered inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-the-ordered-inverse-transform" id="toc-absolute-jacobian-determinant-of-the-ordered-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-the-ordered-inverse-transform">Absolute Jacobian determinant of the ordered inverse transform</a></li>
  </ul></li>
  <li><a href="#simplex-transform.section" id="toc-simplex-transform.section" class="nav-link" data-scroll-target="#simplex-transform.section">Unit simplex</a>
  <ul class="collapse">
  <li><a href="#unit-simplex-inverse-transform" id="toc-unit-simplex-inverse-transform" class="nav-link" data-scroll-target="#unit-simplex-inverse-transform">Unit simplex inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-the-unit-simplex-inverse-transform" id="toc-absolute-jacobian-determinant-of-the-unit-simplex-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-the-unit-simplex-inverse-transform">Absolute Jacobian determinant of the unit-simplex inverse transform</a></li>
  <li><a href="#unit-simplex-transform" id="toc-unit-simplex-transform" class="nav-link" data-scroll-target="#unit-simplex-transform">Unit simplex transform</a></li>
  </ul></li>
  <li><a href="#unit-vector.section" id="toc-unit-vector.section" class="nav-link" data-scroll-target="#unit-vector.section">Unit vector</a>
  <ul class="collapse">
  <li><a href="#unit-vector-inverse-transform" id="toc-unit-vector-inverse-transform" class="nav-link" data-scroll-target="#unit-vector-inverse-transform">Unit vector inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-the-unit-vector-inverse-transform" id="toc-absolute-jacobian-determinant-of-the-unit-vector-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-the-unit-vector-inverse-transform">Absolute Jacobian determinant of the unit vector inverse transform</a></li>
  </ul></li>
  <li><a href="#correlation-matrix-transform.section" id="toc-correlation-matrix-transform.section" class="nav-link" data-scroll-target="#correlation-matrix-transform.section">Correlation matrices</a>
  <ul class="collapse">
  <li><a href="#correlation-matrix-inverse-transform" id="toc-correlation-matrix-inverse-transform" class="nav-link" data-scroll-target="#correlation-matrix-inverse-transform">Correlation matrix inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-the-correlation-matrix-inverse-transform" id="toc-absolute-jacobian-determinant-of-the-correlation-matrix-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-the-correlation-matrix-inverse-transform">Absolute Jacobian determinant of the correlation matrix inverse transform</a></li>
  <li><a href="#correlation-matrix-transform" id="toc-correlation-matrix-transform" class="nav-link" data-scroll-target="#correlation-matrix-transform">Correlation matrix transform</a></li>
  </ul></li>
  <li><a href="#covariance-matrices" id="toc-covariance-matrices" class="nav-link" data-scroll-target="#covariance-matrices">Covariance matrices</a>
  <ul class="collapse">
  <li><a href="#covariance-matrix-transform" id="toc-covariance-matrix-transform" class="nav-link" data-scroll-target="#covariance-matrix-transform">Covariance matrix transform</a></li>
  <li><a href="#covariance-matrix-inverse-transform" id="toc-covariance-matrix-inverse-transform" class="nav-link" data-scroll-target="#covariance-matrix-inverse-transform">Covariance matrix inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-the-covariance-matrix-inverse-transform" id="toc-absolute-jacobian-determinant-of-the-covariance-matrix-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-the-covariance-matrix-inverse-transform">Absolute Jacobian determinant of the covariance matrix inverse transform</a></li>
  </ul></li>
  <li><a href="#cholesky-factors-of-covariance-matrices" id="toc-cholesky-factors-of-covariance-matrices" class="nav-link" data-scroll-target="#cholesky-factors-of-covariance-matrices">Cholesky factors of covariance matrices</a>
  <ul class="collapse">
  <li><a href="#cholesky-factor-of-covariance-matrix-transform" id="toc-cholesky-factor-of-covariance-matrix-transform" class="nav-link" data-scroll-target="#cholesky-factor-of-covariance-matrix-transform">Cholesky factor of covariance matrix transform</a></li>
  <li><a href="#cholesky-factor-of-covariance-matrix-inverse-transform" id="toc-cholesky-factor-of-covariance-matrix-inverse-transform" class="nav-link" data-scroll-target="#cholesky-factor-of-covariance-matrix-inverse-transform">Cholesky factor of covariance matrix inverse transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-cholesky-factor-inverse-transform" id="toc-absolute-jacobian-determinant-of-cholesky-factor-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-cholesky-factor-inverse-transform">Absolute Jacobian determinant of Cholesky factor inverse transform</a></li>
  </ul></li>
  <li><a href="#cholesky-factors-of-correlation-matrices" id="toc-cholesky-factors-of-correlation-matrices" class="nav-link" data-scroll-target="#cholesky-factors-of-correlation-matrices">Cholesky factors of correlation matrices</a>
  <ul class="collapse">
  <li><a href="#cholesky-factor-of-correlation-matrix-inverse-transform" id="toc-cholesky-factor-of-correlation-matrix-inverse-transform" class="nav-link" data-scroll-target="#cholesky-factor-of-correlation-matrix-inverse-transform">Cholesky factor of correlation matrix inverse transform</a></li>
  <li><a href="#cholesky-factor-of-correlation-matrix-transform" id="toc-cholesky-factor-of-correlation-matrix-transform" class="nav-link" data-scroll-target="#cholesky-factor-of-correlation-matrix-transform">Cholesky factor of correlation matrix transform</a></li>
  <li><a href="#absolute-jacobian-determinant-of-inverse-transform" id="toc-absolute-jacobian-determinant-of-inverse-transform" class="nav-link" data-scroll-target="#absolute-jacobian-determinant-of-inverse-transform">Absolute Jacobian determinant of inverse transform</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/transforms.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="variable-transforms.chapter" class="level1">
<h1>Constraint Transforms</h1>
<p>To avoid having to deal with constraints while simulating the Hamiltonian dynamics during sampling, every (multivariate) parameter in a Stan model is transformed to an unconstrained variable behind the scenes by the model compiler. The transform is based on the constraints, if any, in the parameter’s definition. Scalars or the scalar values in vectors, row vectors or matrices may be constrained with lower and/or upper bounds. Vectors may alternatively be constrained to be ordered, positive ordered, or simplexes. Matrices may be constrained to be correlation matrices or covariance matrices. This chapter provides a definition of the transforms used for each type of variable.</p>
<p>Stan converts models to C++ classes which define probability functions with support on all of <span class="math inline">\(\mathbb{R}^K\)</span>, where <span class="math inline">\(K\)</span> is the number of unconstrained parameters needed to define the constrained parameters defined in the program. The C++ classes also include code to transform the parameters from unconstrained to constrained and apply the appropriate Jacobians.</p>
<section id="change-of-variables.section" class="level2">
<h2 class="anchored" data-anchor-id="change-of-variables.section">Changes of variables</h2>
<p>The support of a random variable <span class="math inline">\(X\)</span> with density <span class="math inline">\(p_X(x)\)</span> is that subset of values for which it has non-zero density,</p>
<p><span class="math display">\[
\mathrm{supp}(X) = \{ x | p_X(x) &gt; 0 \}.
\]</span></p>
<p>If <span class="math inline">\(f\)</span> is a total function defined on the support of <span class="math inline">\(X\)</span>, then <span class="math inline">\(Y =
f(X)\)</span> is a new random variable. This section shows how to compute the probability density function of <span class="math inline">\(Y\)</span> for well-behaved transforms <span class="math inline">\(f\)</span>. The rest of the chapter details the transforms used by Stan.</p>
<section id="univariate-changes-of-variables" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="univariate-changes-of-variables">Univariate changes of variables</h3>
<p>Suppose <span class="math inline">\(X\)</span> is one dimensional and <span class="math inline">\(f: \mathrm{supp}(X) \rightarrow
\mathbb{R}\)</span> is a one-to-one, monotonic function with a differentiable inverse <span class="math inline">\(f^{-1}\)</span>. Then the density of <span class="math inline">\(Y\)</span> is given by</p>
<p><span class="math display">\[
p_Y(y) = p_X(f^{-1}(y))
         \,
         \left| \, \frac{d}{dy} f^{-1}(y)\, \right|.
\]</span></p>
<p>The absolute derivative of the inverse transform measures how the scale of the transformed variable changes with respect to the underlying variable.</p>
</section>
<section id="multivariate-changes-of-variables" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="multivariate-changes-of-variables">Multivariate changes of variables</h3>
<p>The multivariate generalization of an absolute derivative is a Jacobian, or more fully the absolute value of the determinant of the Jacobian matrix of the transform. The Jacobian matrix measures the change of each output variable relative to every input variable and the absolute determinant uses that to determine the differential change in volume at a given point in the parameter space.</p>
<p>Suppose <span class="math inline">\(X\)</span> is a <span class="math inline">\(K\)</span>-dimensional random variable with probability density function <span class="math inline">\(p_X(x)\)</span>. A new random variable <span class="math inline">\(Y = f(X)\)</span> may be defined by transforming <span class="math inline">\(X\)</span> with a suitably well-behaved function <span class="math inline">\(f\)</span>. It suffices for what follows to note that if <span class="math inline">\(f\)</span> is one-to-one and its inverse <span class="math inline">\(f^{-1}\)</span> has a well-defined Jacobian, then the density of <span class="math inline">\(Y\)</span> is</p>
<p><span class="math display">\[
p_Y(y) = p_X(f^{-1}(y)) \, \left| \, \det \, J_{f^{-1}}(y) \, \right|,
\]</span></p>
<p>where <span class="math inline">\(\det{}\)</span> is the matrix determinant operation and <span class="math inline">\(J_{f^{-1}}(y)\)</span> is the Jacobian matrix of <span class="math inline">\(f^{-1}\)</span> evaluated at <span class="math inline">\(y\)</span>. Taking <span class="math inline">\(x =
f^{-1}(y)\)</span>, the Jacobian matrix is defined by</p>
<p><span class="math display">\[
J_{f^{-1}}(y) =
\left[
\begin{array}{ccc}\displaystyle
\frac{\partial x_1}{\partial y_1}
&amp; \cdots
&amp; \displaystyle \frac{\partial x_1}{\partial y_{K}}
\\
\vdots &amp; \vdots &amp; \vdots
\\
\displaystyle\frac{\partial x_{K}}{\partial y_1}
&amp; \cdots
&amp; \displaystyle\frac{\partial x_{K}}{\partial y_{K}}
\end{array}
\right].
\]</span></p>
<p>If the Jacobian matrix is triangular, the determinant reduces to the product of the diagonal entries,</p>
<p><span class="math display">\[
\det \, J_{f^{-1}}(y)
= \prod_{k=1}^K \frac{\partial x_k}{\partial y_k}.
\]</span></p>
<p>Triangular matrices naturally arise in situations where the variables are ordered, for instance by dimension, and each variable’s transformed value depends on the previous variable’s transformed values. Diagonal matrices, a simple form of triangular matrix, arise if each transformed variable only depends on a single untransformed variable.</p>
</section>
</section>
<section id="lower-bound-transform.section" class="level2">
<h2 class="anchored" data-anchor-id="lower-bound-transform.section">Lower bounded scalar</h2>
<p>Stan uses a logarithmic transform for lower and upper bounds.</p>
<section id="lower-bound-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="lower-bound-transform">Lower bound transform</h3>
<p>If a variable <span class="math inline">\(X\)</span> is declared to have lower bound <span class="math inline">\(a\)</span>, it is transformed to an unbounded variable <span class="math inline">\(Y\)</span>, where</p>
<p><span class="math display">\[
Y = \log(X - a).
\]</span></p>
</section>
<section id="lower-bound-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="lower-bound-inverse-transform">Lower bound inverse transform</h3>
<p>The inverse of the lower-bound transform maps an unbounded variable <span class="math inline">\(Y\)</span> to a variable <span class="math inline">\(X\)</span> that is bounded below by <span class="math inline">\(a\)</span> by</p>
<p><span class="math display">\[
X = \exp(Y) + a.
\]</span></p>
</section>
<section id="absolute-derivative-of-the-lower-bound-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-derivative-of-the-lower-bound-inverse-transform">Absolute derivative of the lower bound inverse transform</h3>
<p>The absolute derivative of the inverse transform is</p>
<p><span class="math display">\[
\left| \,
\frac{d}{dy} \left( \exp(y) + a \right)
\, \right|
= \exp(y).
\]</span></p>
<p>Therefore, given the density <span class="math inline">\(p_X\)</span> of <span class="math inline">\(X\)</span>, the density of <span class="math inline">\(Y\)</span> is</p>
<p><span class="math display">\[
p_Y(y)
= p_X\!\left( \exp(y) + a \right) \cdot \exp(y).
\]</span></p>
</section>
</section>
<section id="upper-bounded-scalar" class="level2">
<h2 class="anchored" data-anchor-id="upper-bounded-scalar">Upper bounded scalar</h2>
<p>Stan uses a negated logarithmic transform for upper bounds.</p>
<section id="upper-bound-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="upper-bound-transform">Upper bound transform</h3>
<p>If a variable <span class="math inline">\(X\)</span> is declared to have an upper bound <span class="math inline">\(b\)</span>, it is transformed to the unbounded variable <span class="math inline">\(Y\)</span> by</p>
<p><span class="math display">\[
Y = \log(b - X).
\]</span></p>
</section>
<section id="upper-bound-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="upper-bound-inverse-transform">Upper bound inverse transform</h3>
<p>The inverse of the upper bound transform converts the unbounded variable <span class="math inline">\(Y\)</span> to the variable <span class="math inline">\(X\)</span> bounded above by <span class="math inline">\(b\)</span> through</p>
<p><span class="math display">\[
X = b - \exp(Y).
\]</span></p>
</section>
<section id="absolute-derivative-of-the-upper-bound-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-derivative-of-the-upper-bound-inverse-transform">Absolute derivative of the upper bound inverse transform</h3>
<p>The absolute derivative of the inverse of the upper bound transform is</p>
<p><span class="math display">\[
\left| \,
\frac{d}{dy} \left( b - \exp(y) \right)
\, \right|
= \exp(y).
\]</span></p>
<p>Therefore, the density of the unconstrained variable <span class="math inline">\(Y\)</span> is defined in terms of the density of the variable <span class="math inline">\(X\)</span> with an upper bound of <span class="math inline">\(b\)</span> by</p>
<p><span class="math display">\[
p_Y(y)
=   p_X \!\left( b - \exp(y) \right) \cdot \exp(y).
\]</span></p>
</section>
</section>
<section id="logit-transform-jacobian.section" class="level2">
<h2 class="anchored" data-anchor-id="logit-transform-jacobian.section">Lower and upper bounded scalar</h2>
<p>For lower and upper-bounded variables, Stan uses a scaled and translated log-odds transform.</p>
<section id="log-odds-and-the-logistic-sigmoid" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="log-odds-and-the-logistic-sigmoid">Log odds and the logistic sigmoid</h3>
<p>The log-odds function is defined for <span class="math inline">\(u \in (0,1)\)</span> by</p>
<p><span class="math display">\[
\mathrm{logit}(u) = \log \frac{u}{1 - u}.
\]</span></p>
<p>The inverse of the log odds function is the logistic sigmoid, defined for <span class="math inline">\(v \in (-\infty,\infty)\)</span> by</p>
<p><span class="math display">\[
\mathrm{logit}^{-1}(v) = \frac{1}{1 + \exp(-v)}.
\]</span></p>
<p>The derivative of the logistic sigmoid is</p>
<p><span class="math display">\[
\frac{d}{dy} \mathrm{logit}^{-1}(y)
= \mathrm{logit}^{-1}(y) \cdot \left( 1 - \mathrm{logit}^{-1}(y) \right).
\]</span></p>
</section>
<section id="lower-and-upper-bounds-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="lower-and-upper-bounds-transform">Lower and upper bounds transform</h3>
<p>For variables constrained to be in the open interval <span class="math inline">\((a, b)\)</span>, Stan uses a scaled and translated log-odds transform. If variable <span class="math inline">\(X\)</span> is declared to have lower bound <span class="math inline">\(a\)</span> and upper bound <span class="math inline">\(b\)</span>, then it is transformed to a new variable <span class="math inline">\(Y\)</span>, where</p>
<p><span class="math display">\[
Y = \mathrm{logit} \left( \frac{X - a}{b - a} \right).
\]</span></p>
</section>
<section id="lower-and-upper-bounds-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="lower-and-upper-bounds-inverse-transform">Lower and upper bounds inverse transform</h3>
<p>The inverse of this transform is</p>
<p><span class="math display">\[
X = a + (b - a) \cdot \mathrm{logit}^{-1}(Y).
\]</span></p>
</section>
<section id="absolute-derivative-of-the-lower-and-upper-bounds-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-derivative-of-the-lower-and-upper-bounds-inverse-transform">Absolute derivative of the lower and upper bounds inverse transform</h3>
<p>The absolute derivative of the inverse transform is given by</p>
<p><span class="math display">\[
\left|
  \frac{d}{dy}
    \left(
      a + (b - a) \cdot \mathrm{logit}^{-1}(y)
    \right)
  \right|
= (b - a)
    \cdot \mathrm{logit}^{-1}(y)
    \cdot \left( 1 - \mathrm{logit}^{-1}(y) \right).
\]</span></p>
<p>Therefore, the density of the transformed variable <span class="math inline">\(Y\)</span> is</p>
<p><span class="math display">\[
p_Y(y)
=
p_X \! \left( a + (b - a) \cdot \mathrm{logit}^{-1}(y) \right)
    \cdot (b - a)
    \cdot \mathrm{logit}^{-1}(y)
    \cdot \left( 1 - \mathrm{logit}^{-1}(y) \right).
\]</span></p>
<p>Despite the apparent complexity of this expression, most of the terms are repeated and thus only need to be evaluated once. Most importantly, <span class="math inline">\(\mathrm{logit}^{-1}(y)\)</span> only needs to be evaluated once, so there is only one call to <span class="math inline">\(\exp(-y)\)</span>.</p>
</section>
</section>
<section id="affinely-transformed-scalar" class="level2">
<h2 class="anchored" data-anchor-id="affinely-transformed-scalar">Affinely transformed scalar</h2>
<p>Stan uses an affine transform to be able to specify parameters with a given offset and multiplier.</p>
<section id="affine-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="affine-transform">Affine transform</h3>
<p>For variables with expected offset <span class="math inline">\(\mu\)</span> and/or (positive) multiplier <span class="math inline">\(\sigma\)</span>, Stan uses an affine transform. Such a variable <span class="math inline">\(X\)</span> is transformed to a new variable <span class="math inline">\(Y\)</span>, where</p>
<p><span class="math display">\[
Y = \frac{X - \mu}{\sigma}.
\]</span></p>
<p>The default value for the offset <span class="math inline">\(\mu\)</span> is <span class="math inline">\(0\)</span> and for the multiplier <span class="math inline">\(\sigma\)</span> is <span class="math inline">\(1\)</span> in case not both are specified.</p>
</section>
<section id="affine-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="affine-inverse-transform">Affine inverse transform</h3>
<p>The inverse of this transform is</p>
<p><span class="math display">\[
X =  \mu + \sigma \cdot Y.
\]</span></p>
</section>
<section id="absolute-derivative-of-the-affine-inverse-transform" class="level3">
<h3 class="anchored" data-anchor-id="absolute-derivative-of-the-affine-inverse-transform">Absolute derivative of the affine inverse transform</h3>
<p>The absolute derivative of the affine inverse transform is</p>
<p><span class="math display">\[
\left|
  \frac{d}{dy}
    \left(
      \mu + \sigma \cdot y
    \right)
  \right|
= \sigma.
\]</span></p>
<p>Therefore, the density of the transformed variable <span class="math inline">\(Y\)</span> is</p>
<p><span class="math display">\[
p_Y(y)
=
p_X \! \left( \mu + \sigma \cdot y \right)
    \cdot \sigma.
\]</span></p>
</section>
</section>
<section id="ordered-vector" class="level2">
<h2 class="anchored" data-anchor-id="ordered-vector">Ordered vector</h2>
<p>For some modeling tasks, a vector-valued random variable <span class="math inline">\(X\)</span> is required with support on ordered sequences. One example is the set of cut points in ordered logistic regression.</p>
<p>In constraint terms, an ordered <span class="math inline">\(K\)</span>-vector <span class="math inline">\(x \in \mathbb{R}^K\)</span> satisfies</p>
<p><span class="math display">\[
x_k &lt; x_{k+1}
\]</span></p>
<p>for <span class="math inline">\(k \in \{ 1, \ldots, K-1 \}\)</span>.</p>
<section id="ordered-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ordered-transform">Ordered transform</h3>
<p>Stan’s transform follows the constraint directly. It maps an increasing vector <span class="math inline">\(x \in \mathbb{R}^{K}\)</span> to an unconstrained vector <span class="math inline">\(y \in
\mathbb{R}^K\)</span> by setting</p>
<p><span class="math display">\[
y_k
=
\left\{
\begin{array}{ll}
x_1 &amp; \mbox{if } k = 1, \mbox{ and}
\\
\log \left( x_{k} - x_{k-1} \right) &amp; \mbox{if } 1 &lt; k \leq K.
\end{array}
\right.
\]</span></p>
</section>
<section id="ordered-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ordered-inverse-transform">Ordered inverse transform</h3>
<p>The inverse transform for an unconstrained <span class="math inline">\(y \in \mathbb{R}^K\)</span> to an ordered sequence <span class="math inline">\(x \in \mathbb{R}^K\)</span> is defined by the recursion</p>
<p><span class="math display">\[
x_k
=
\left\{
\begin{array}{ll}
y_1 &amp; \mbox{if } k = 1, \mbox{ and}
\\
x_{k-1} + \exp(y_k) &amp; \mbox{if } 1 &lt; k \leq K.
\end{array}
\right.
\]</span></p>
<p><span class="math inline">\(x_k\)</span> can also be expressed iteratively as</p>
<p><span class="math display">\[
x_k = y_1 + \sum_{k'=2}^k \exp(y_{k'}).
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-the-ordered-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-the-ordered-inverse-transform">Absolute Jacobian determinant of the ordered inverse transform</h3>
<p>The Jacobian of the inverse transform <span class="math inline">\(f^{-1}\)</span> is lower triangular, with diagonal elements for <span class="math inline">\(1 \leq k \leq K\)</span> of</p>
<p><span class="math display">\[
J_{k,k} =
\left\{
\begin{array}{ll}
1 &amp; \mbox{if } k = 1, \mbox{ and}
\\
\exp(y_k) &amp; \mbox{if } 1 &lt; k \leq K.
\end{array}
\right.
\]</span></p>
<p>Because <span class="math inline">\(J\)</span> is triangular, the absolute Jacobian determinant is</p>
<p><span class="math display">\[
\left| \, \det \, J \, \right|
\ = \
\left| \, \prod_{k=1}^K J_{k,k} \, \right|
\ = \
\prod_{k=2}^K \exp(y_k).
\]</span></p>
<p>Putting this all together, if <span class="math inline">\(p_X\)</span> is the density of <span class="math inline">\(X\)</span>, then the transformed variable <span class="math inline">\(Y\)</span> has density <span class="math inline">\(p_Y\)</span> given by</p>
<p><span class="math display">\[
p_Y(y)
= p_X(f^{-1}(y))
\
\prod_{k=2}^K \exp(y_k).
\]</span></p>
</section>
</section>
<section id="simplex-transform.section" class="level2">
<h2 class="anchored" data-anchor-id="simplex-transform.section">Unit simplex</h2>
<p>Variables constrained to the unit simplex show up in multivariate discrete models as both parameters (categorical and multinomial) and as variates generated by their priors (Dirichlet and multivariate logistic).</p>
<p>The unit <span class="math inline">\(K\)</span>-simplex is the set of points <span class="math inline">\(x \in \mathbb{R}^K\)</span> such that for <span class="math inline">\(1 \leq k \leq K\)</span>,</p>
<p><span class="math display">\[
x_k &gt; 0,
\]</span></p>
<p>and</p>
<p><span class="math display">\[
\sum_{k=1}^K x_k = 1.
\]</span></p>
<p>An alternative definition is to take the convex closure of the vertices. For instance, in 2-dimensions, the simplex vertices are the extreme values <span class="math inline">\((0,1)\)</span>, and <span class="math inline">\((1,0)\)</span> and the unit 2-simplex is the line connecting these two points; values such as <span class="math inline">\((0.3,0.7)\)</span> and <span class="math inline">\((0.99,0.01)\)</span> lie on the line. In 3-dimensions, the basis is <span class="math inline">\((0,0,1)\)</span>, <span class="math inline">\((0,1,0)\)</span> and <span class="math inline">\((1,0,0)\)</span> and the unit 3-simplex is the boundary and interior of the triangle with these vertices. Points in the 3-simplex include <span class="math inline">\((0.5,0.5,0)\)</span>, <span class="math inline">\((0.2,0.7,0.1)\)</span> and all other triplets of non-negative values summing to 1.</p>
<p>As these examples illustrate, the simplex always picks out a subspace of <span class="math inline">\(K-1\)</span> dimensions from <span class="math inline">\(\mathbb{R}^K\)</span>. Therefore a point <span class="math inline">\(x\)</span> in the <span class="math inline">\(K\)</span>-simplex is fully determined by its first <span class="math inline">\(K-1\)</span> elements <span class="math inline">\(x_1, x_2,
\ldots, x_{K-1}\)</span>, with</p>
<p><span class="math display">\[
x_K = 1 - \sum_{k=1}^{K-1} x_k.
\]</span></p>
<section id="unit-simplex-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="unit-simplex-inverse-transform">Unit simplex inverse transform</h3>
<p>Stan’s unit simplex inverse transform may be understood using the following stick-breaking metaphor.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<ol type="1">
<li>Take a stick of unit length (i.e., length 1).</li>
<li>Break a piece off and label it as <span class="math inline">\(x_1\)</span>, and set it aside, keeping what’s left.</li>
<li>Next, break a piece off what’s left, label it <span class="math inline">\(x_2\)</span>, and set it aside, keeping what’s left.</li>
<li>Continue breaking off pieces of what’s left, labeling them, and setting them aside for pieces <span class="math inline">\(x_3,\ldots,x_{K-1}\)</span>.</li>
<li>Label what’s left <span class="math inline">\(x_K\)</span>.</li>
</ol>
<p>The resulting vector <span class="math inline">\(x = [x_1,\ldots,x_{K}]^{\top}\)</span> is a unit simplex because each piece has non-negative length and the sum of the stick lengths is one by construction.</p>
<p>This full inverse mapping requires the breaks to be represented as the fraction in <span class="math inline">\((0,1)\)</span> of the original stick that is broken off. These break ratios are themselves derived from unconstrained values in <span class="math inline">\((-\infty,\infty)\)</span> using the inverse logit transform as described above for unidimensional variables with lower and upper bounds.</p>
<p>More formally, an intermediate vector <span class="math inline">\(z \in \mathbb{R}^{K-1}\)</span>, whose coordinates <span class="math inline">\(z_k\)</span> represent the proportion of the stick broken off in step <span class="math inline">\(k\)</span>, is defined elementwise for <span class="math inline">\(1 \leq k &lt; K\)</span> by</p>
<p><span class="math display">\[
z_k = \mathrm{logit}^{-1} \left( y_k
                             + \log \left( \frac{1}{K - k}
                                            \right)
                       \right).
\]</span></p>
<p>The logit term <span class="math inline">\(\log\left(\frac{1}{K-k}\right) (i.e., \mathrm{logit}\left(\frac{1}{K-k+1}\right)\)</span>) in the above definition adjusts the transform so that a zero vector <span class="math inline">\(y\)</span> is mapped to the simplex <span class="math inline">\(x = (1/K,\ldots,1/K)\)</span>. For instance, if <span class="math inline">\(y_1 = 0\)</span>, then <span class="math inline">\(z_1 = 1/K\)</span>; if <span class="math inline">\(y_2 = 0\)</span>, then <span class="math inline">\(z_2 = 1/(K-1)\)</span>; and if <span class="math inline">\(y_{K-1} = 0\)</span>, then <span class="math inline">\(z_{K-1} = 1/2\)</span>.</p>
<p>The break proportions <span class="math inline">\(z\)</span> are applied to determine the stick sizes and resulting value of <span class="math inline">\(x_k\)</span> for <span class="math inline">\(1 \leq k &lt; K\)</span> by</p>
<p><span class="math display">\[
x_k =
\left( 1 - \sum_{k'=1}^{k-1} x_{k'} \right) z_k.
\]</span></p>
<p>The summation term represents the length of the original stick left at stage <span class="math inline">\(k\)</span>. This is multiplied by the break proportion <span class="math inline">\(z_k\)</span> to yield <span class="math inline">\(x_k\)</span>. Only <span class="math inline">\(K-1\)</span> unconstrained parameters are required, with the last dimension’s value <span class="math inline">\(x_K\)</span> set to the length of the remaining piece of the original stick,</p>
<p><span class="math display">\[
x_K = 1 - \sum_{k=1}^{K-1} x_k.
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-the-unit-simplex-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-the-unit-simplex-inverse-transform">Absolute Jacobian determinant of the unit-simplex inverse transform</h3>
<p>The Jacobian <span class="math inline">\(J\)</span> of the inverse transform <span class="math inline">\(f^{-1}\)</span> is lower-triangular, with diagonal entries</p>
<p><span class="math display">\[
J_{k,k}
=
\frac{\partial x_k}{\partial y_k}
=
\frac{\partial x_k}{\partial z_k} \,
\frac{\partial z_k}{\partial y_k},
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\frac{\partial z_k}{\partial y_k}
= \frac{\partial}{\partial y_k}
   \mathrm{logit}^{-1} \left(
                       y_k + \log \left( \frac{1}{K-k}
                                          \right)
                    \right)
= z_k (1 - z_k),
\]</span></p>
<p>and</p>
<p><span class="math display">\[
\frac{\partial x_k}{\partial z_k}
=
\left(
  1 - \sum_{k' = 1}^{k-1} x_{k'}
   \right)
.
\]</span></p>
<p>This definition is recursive, defining <span class="math inline">\(x_k\)</span> in terms of <span class="math inline">\(x_{1},\ldots,x_{k-1}\)</span>.</p>
<p>Because the Jacobian <span class="math inline">\(J\)</span> of <span class="math inline">\(f^{-1}\)</span> is lower triangular and positive, its absolute determinant reduces to</p>
<p><span class="math display">\[
\left| \, \det J \, \right|
\ = \
\prod_{k=1}^{K-1} J_{k,k}
\ = \
\prod_{k=1}^{K-1}
z_k
\,
(1 - z_k)
\
\left(
1 - \sum_{k'=1}^{k-1} x_{k'}
\right)
.
\]</span></p>
<p>Thus the transformed variable <span class="math inline">\(Y = f(X)\)</span> has a density given by</p>
<p><span class="math display">\[
p_Y(y)
= p_X(f^{-1}(y))
\,
\prod_{k=1}^{K-1}
z_k
\,
(1 - z_k)
\
\left(
1 - \sum_{k'=1}^{k-1} x_{k'}
\right)
.
\]</span></p>
<p>Even though it is expressed in terms of intermediate values <span class="math inline">\(z_k\)</span>, this expression still looks more complex than it is. The exponential function need only be evaluated once for each unconstrained parameter <span class="math inline">\(y_k\)</span>; everything else is just basic arithmetic that can be computed incrementally along with the transform.</p>
</section>
<section id="unit-simplex-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="unit-simplex-transform">Unit simplex transform</h3>
<p>The transform <span class="math inline">\(Y = f(X)\)</span> can be derived by reversing the stages of the inverse transform. Working backwards, given the break proportions <span class="math inline">\(z\)</span>, <span class="math inline">\(y\)</span> is defined elementwise by</p>
<p><span class="math display">\[
y_k
= \mathrm{logit}(z_k)
- \mbox{log}\left(
   \frac{1}{K-k}
   \right)
.
\]</span></p>
<p>The break proportions <span class="math inline">\(z_k\)</span> are defined to be the ratio of <span class="math inline">\(x_k\)</span> to the length of stick left after the first <span class="math inline">\(k-1\)</span> pieces have been broken off,</p>
<p><span class="math display">\[
z_k
= \frac{x_k}
       {1 - \sum_{k' = 1}^{k-1} x_{k'}}
.
\]</span></p>
</section>
</section>
<section id="unit-vector.section" class="level2">
<h2 class="anchored" data-anchor-id="unit-vector.section">Unit vector</h2>
<p>An <span class="math inline">\(n\)</span>-dimensional vector <span class="math inline">\(x \in \mathbb{R}^n\)</span> is said to be a unit vector if it has unit Euclidean length, so that</p>
<p><span class="math display">\[
\Vert x \Vert
\ = \ \sqrt{x^{\top}\,x}
\ = \ \sqrt{x_1^2 + x_2^2 + \cdots + x_n^2}
\ = \ 1\ .
\]</span></p>
<section id="unit-vector-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="unit-vector-inverse-transform">Unit vector inverse transform</h3>
<p>Stan divides an unconstrained vector <span class="math inline">\(y \in \mathbb{R}^{n}\)</span> by its norm, <span class="math inline">\(\Vert y \Vert = \sqrt{y^\top y}\)</span>, to obtain a unit vector <span class="math inline">\(x\)</span>,</p>
<p><span class="math display">\[
x = \frac{y}{\Vert y \Vert}.
\]</span></p>
<p>To generate a unit vector, Stan generates points at random in <span class="math inline">\(\mathbb{R}^n\)</span> with independent unit normal distributions, which are then standardized by dividing by their Euclidean length. <span class="citation" data-cites="Muller:1959">Muller (<a href="#ref-Muller:1959" role="doc-biblioref">1959</a>)</span> showed this generates points uniformly at random on <span class="math inline">\(S^{n-1}\)</span>. That is, if we draw <span class="math inline">\(y_n \sim \mathsf{Normal}(0, 1)\)</span> for <span class="math inline">\(n \in 1{:}n\)</span>, then <span class="math inline">\(x = \frac{y}{\Vert y \Vert}\)</span> has a uniform distribution over <span class="math inline">\(S^{n-1}\)</span>. This allows us to use an <span class="math inline">\(n\)</span>-dimensional basis for <span class="math inline">\(S^{n-1}\)</span> that preserves local neighborhoods in that points that are close to each other in <span class="math inline">\(\mathbb{R}^n\)</span> map to points near each other in <span class="math inline">\(S^{n-1}\)</span>. The mapping is not perfectly distance preserving, because there are points arbitrarily far away from each other in <span class="math inline">\(\mathbb{R}^n\)</span> that map to identical points in <span class="math inline">\(S^{n-1}\)</span>.</p>
<section id="warning-undefined-at-zero" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="warning-undefined-at-zero">Warning: undefined at zero!</h4>
<p>The above mapping from <span class="math inline">\(\mathbb{R}^n\)</span> to <span class="math inline">\(S^n\)</span> is not defined at zero. While this point outcome has measure zero during sampling, and may thus be ignored, it is the default initialization point and thus unit vector parameters cannot be initialized at zero. A simple workaround is to initialize from a very small interval around zero, which is an option built into all of the Stan interfaces.</p>
</section>
</section>
<section id="absolute-jacobian-determinant-of-the-unit-vector-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-the-unit-vector-inverse-transform">Absolute Jacobian determinant of the unit vector inverse transform</h3>
<p>The Jacobian matrix relating the input vector <span class="math inline">\(y\)</span> to the output vector <span class="math inline">\(x\)</span> is singular because <span class="math inline">\(x^\top x = 1\)</span> for any non-zero input vector <span class="math inline">\(y\)</span>. Thus, there technically is no unique transformation from <span class="math inline">\(x\)</span> to <span class="math inline">\(y\)</span>. To circumvent this issue, let <span class="math inline">\(r = \sqrt{y^\top y}\)</span> so that <span class="math inline">\(y = r
x\)</span>. The transformation from <span class="math inline">\(\left(r, x_{-n}\right)\)</span> to <span class="math inline">\(y\)</span> is well-defined but <span class="math inline">\(r\)</span> is arbitrary, so we set <span class="math inline">\(r = 1\)</span>. In this case, the determinant of the Jacobian is proportional to <span class="math inline">\(e^{-\frac{1}{2} y^\top y}\)</span>, which is the kernel of a standard multivariate normal distribution with <span class="math inline">\(n\)</span> independent dimensions.</p>
</section>
</section>
<section id="correlation-matrix-transform.section" class="level2">
<h2 class="anchored" data-anchor-id="correlation-matrix-transform.section">Correlation matrices</h2>
<p>A <span class="math inline">\(K \times K\)</span> correlation matrix <span class="math inline">\(x\)</span> must be symmetric, so that</p>
<p><span class="math display">\[
x_{k,k'} = x_{k',k}
\]</span></p>
<p>for all <span class="math inline">\(k,k' \in \{ 1, \ldots, K \}\)</span>, it must have a unit diagonal, so that</p>
<p><span class="math display">\[
x_{k,k} = 1
\]</span></p>
<p>for all <span class="math inline">\(k \in \{ 1, \ldots, K \}\)</span>, and it must be positive definite, so that for every non-zero <span class="math inline">\(K\)</span>-vector <span class="math inline">\(a\)</span>,</p>
<p><span class="math display">\[
a^{\top} x a &gt; 0.
\]</span></p>
<p>The number of free parameters required to specify a <span class="math inline">\(K \times K\)</span> correlation matrix is <span class="math inline">\(\binom{K}{2}\)</span>.</p>
<p>There is more than one way to map from <span class="math inline">\(\binom{K}{2}\)</span> unconstrained parameters to a <span class="math inline">\(K \times K\)</span> correlation matrix. Stan implements the Lewandowski-Kurowicka-Joe (LKJ) transform <span class="citation" data-cites="LewandowskiKurowickaJoe:2009">Lewandowski, Kurowicka, and Joe (<a href="#ref-LewandowskiKurowickaJoe:2009" role="doc-biblioref">2009</a>)</span>.</p>
<section id="correlation-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="correlation-matrix-inverse-transform">Correlation matrix inverse transform</h3>
<p>It is easiest to specify the inverse, going from its <span class="math inline">\(\binom{K}{2}\)</span> parameter basis to a correlation matrix. The basis will actually be broken down into two steps. To start, suppose <span class="math inline">\(y\)</span> is a vector containing <span class="math inline">\(\binom{K}{2}\)</span> unconstrained values. These are first transformed via the bijective function <span class="math inline">\(\tanh : \mathbb{R} \rightarrow
(-1, 1)\)</span></p>
<p><span class="math display">\[
\tanh y = \frac{\exp(2y) - 1}{\exp(2y) + 1}.
\]</span></p>
<p>Then, define a <span class="math inline">\(K \times K\)</span> matrix <span class="math inline">\(z\)</span>, the upper triangular values of which are filled by row with the transformed values, and the diagonal entries are set to one. For example, in the <span class="math inline">\(4 \times 4\)</span> case, there are <span class="math inline">\(\binom{4}{2}\)</span> values arranged as</p>
<p><span class="math display">\[
z
=
\left[
\begin{array}{cccc}
1 &amp; \tanh y_1 &amp; \tanh y_2 &amp; \tanh y_4
\\
0 &amp; 1 &amp; \tanh y_3 &amp; \tanh y_5
\\
0 &amp; 0 &amp; 1 &amp; \tanh y_6
\\
0 &amp; 0 &amp; 0 &amp; 1
\end{array}
\right]
.
\]</span></p>
<p>Lewandowski, Kurowicka and Joe (LKJ) show how to bijectively map the array <span class="math inline">\(z\)</span> to a correlation matrix <span class="math inline">\(x\)</span>. The entry <span class="math inline">\(z_{i,j}\)</span> for <span class="math inline">\(i &lt;
j\)</span> is interpreted as the canonical partial correlation (CPC) between <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, which is the correlation between <span class="math inline">\(i\)</span>’s residuals and <span class="math inline">\(j\)</span>’s residuals when both <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are regressed on all variables <span class="math inline">\(i'\)</span> such that <span class="math inline">\(i'&lt; i\)</span>. In the case of <span class="math inline">\(i=1\)</span>, there are no earlier variables, so <span class="math inline">\(z_{1,j}\)</span> is just the Pearson correlation between <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>.</p>
<p>In Stan, the LKJ transform is reformulated in terms of a Cholesky factor <span class="math inline">\(w\)</span> of the final correlation matrix, defined for <span class="math inline">\(1 \leq i,j \leq K\)</span> by</p>
<p><span class="math display">\[
w_{i,j} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } i &gt; j,
\\
1 &amp; \mbox{if } 1 = i = j,
\\
\prod_{i'=1}^{i - 1} \left( 1 - z_{i'\!,\,j}^2 \right)^{1/2}
&amp; \mbox{if } 1 &lt; i = j,
\\
z_{i,j} &amp; \mbox{if } 1 = i &lt; j, \mbox{ and}
\\\
z_{i,j} \, \prod_{i'=1}^{i-1} \left( 1 - z_{i'\!,\,j}^2 \right)^{1/2}
&amp; \mbox{ if } 1 &lt; i &lt; j.
\end{array}
\right.
\]</span></p>
<p>This does not require as much computation per matrix entry as it may appear; calculating the rows in terms of earlier rows yields the more manageable expression</p>
<p><span class="math display">\[
w_{i,j} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } i &gt; j,
\\
1 &amp; \mbox{if } 1 = i = j,
\\
z_{i,j} &amp; \mbox{if } 1 = i &lt; j, \mbox{ and}
\\
\frac{z_{i,j}}{z_{i-1,j}} \ w_{i-1,j} \left( 1 - z_{i-1,j}^2 \right)^{1/2}
&amp; \mbox{ if } 1 &lt; i \leq j.
\end{array}
\right.
\]</span></p>
<p>Given the upper-triangular Cholesky factor <span class="math inline">\(w\)</span>, the final correlation matrix is</p>
<p><span class="math display">\[
x = w^{\top} w.
\]</span></p>
<p><span class="citation" data-cites="LewandowskiKurowickaJoe:2009">Lewandowski, Kurowicka, and Joe (<a href="#ref-LewandowskiKurowickaJoe:2009" role="doc-biblioref">2009</a>)</span> show that the determinant of the correlation matrix can be defined in terms of the canonical partial correlations as</p>
<p><span class="math display">\[
\mbox{det} \, x = \prod_{i=1}^{K-1} \ \prod_{j=i+1}^K \ (1 - z_{i,j}^2)
= \prod_{1 \leq i &lt; j \leq K} (1 - z_{i,j}^2),
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-the-correlation-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-the-correlation-matrix-inverse-transform">Absolute Jacobian determinant of the correlation matrix inverse transform</h3>
<p>From the inverse of equation 11 in <span class="citation" data-cites="LewandowskiKurowickaJoe:2009">(<a href="#ref-LewandowskiKurowickaJoe:2009" role="doc-biblioref">Lewandowski, Kurowicka, and Joe 2009</a>)</span>, the absolute Jacobian determinant is</p>
<p><span class="math display">\[
\sqrt{\prod_{i=1}^{K-1}\prod_{j=i+1}^K \left(1-z_{i,j}^2\right)^{K-i-1}} \
\times \prod_{i=1}^{K-1}\prod_{j=i+1}^K
\frac{\partial z_{i,j}}{\partial y_{i,j}}
\]</span></p>
</section>
<section id="correlation-matrix-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="correlation-matrix-transform">Correlation matrix transform</h3>
<p>The correlation transform is defined by reversing the steps of the inverse transform defined in the previous section.</p>
<p>Starting with a correlation matrix <span class="math inline">\(x\)</span>, the first step is to find the unique upper triangular <span class="math inline">\(w\)</span> such that <span class="math inline">\(x = w w^{\top}\)</span>. Because <span class="math inline">\(x\)</span> is positive definite, this can be done by applying the Cholesky decomposition,</p>
<p><span class="math display">\[
w = \mbox{chol}(x).
\]</span></p>
<p>The next step from the Cholesky factor <span class="math inline">\(w\)</span> back to the array <span class="math inline">\(z\)</span> of canonical partial correlations (CPCs) is simplified by the ordering of the elements in the definition of <span class="math inline">\(w\)</span>, which when inverted yields</p>
<p><span class="math display">\[
z_{i,j} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } i \leq j,
\\
w_{i,j} &amp; \mbox{if } 1 = i &lt; j, \mbox{ and}
\\
{w_{i,j}}
\
\prod_{i'=1}^{i-1} \left( 1 - z_{i'\!,j}^2 \right)^{-1/2}
&amp; \mbox{if } 1 &lt; i &lt; j.
\end{array}
\right.
\]</span></p>
<p>The final stage of the transform reverses the hyperbolic tangent transform, which is defined by</p>
<p><span class="math display">\[
y = \tanh^{-1} z = \frac{1}{2} \log \left( \frac{1 + z}{1 - z} \right).
\]</span></p>
<p>The inverse hyperbolic tangent function, <span class="math inline">\(\tanh^{-1}\)</span>, is also called the Fisher transformation.</p>
</section>
</section>
<section id="covariance-matrices" class="level2">
<h2 class="anchored" data-anchor-id="covariance-matrices">Covariance matrices</h2>
<p>A <span class="math inline">\(K \times K\)</span> matrix is a covariance matrix if it is symmetric and positive definite (see the previous section for definitions). It requires <span class="math inline">\(K + \binom{K}{2}\)</span> free parameters to specify a <span class="math inline">\(K \times K\)</span> covariance matrix.</p>
<section id="covariance-matrix-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="covariance-matrix-transform">Covariance matrix transform</h3>
<p>Stan’s covariance transform is based on a Cholesky decomposition composed with a log transform of the positive-constrained diagonal elements.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>If <span class="math inline">\(x\)</span> is a covariance matrix (i.e., a symmetric, positive definite matrix), then there is a unique lower-triangular matrix <span class="math inline">\(z =
\mathrm{chol}(x)\)</span> with positive diagonal entries, called a Cholesky factor, such that</p>
<p><span class="math display">\[
x = z \, z^{\top}.
\]</span></p>
<p>The off-diagonal entries of the Cholesky factor <span class="math inline">\(z\)</span> are unconstrained, but the diagonal entries <span class="math inline">\(z_{k,k}\)</span> must be positive for <span class="math inline">\(1 \leq k
\leq K\)</span>.</p>
<p>To complete the transform, the diagonal is log-transformed to produce a fully unconstrained lower-triangular matrix <span class="math inline">\(y\)</span> defined by</p>
<p><span class="math display">\[
y_{m,n} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } m &lt; n,
\\
\log z_{m,m} &amp; \mbox{if } m = n, \mbox{ and}
\\
z_{m,n} &amp; \mbox{if } m &gt; n.
\end{array}
\right.
\]</span></p>
</section>
<section id="covariance-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="covariance-matrix-inverse-transform">Covariance matrix inverse transform</h3>
<p>The inverse transform reverses the two steps of the transform. Given an unconstrained lower-triangular <span class="math inline">\(K \times K\)</span> matrix <span class="math inline">\(y\)</span>, the first step is to recover the intermediate matrix <span class="math inline">\(z\)</span> by reversing the log transform,</p>
<p><span class="math display">\[
z_{m,n} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } m &lt; n,
\\
\exp(y_{m,m}) &amp; \mbox{if } m = n, \mbox{ and}
\\
y_{m,n} &amp; \mbox{if } m &gt; n.
\end{array}
\right.
\]</span></p>
<p>The covariance matrix <span class="math inline">\(x\)</span> is recovered from its Cholesky factor <span class="math inline">\(z\)</span> by taking</p>
<p><span class="math display">\[
x = z \, z^{\top}.
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-the-covariance-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-the-covariance-matrix-inverse-transform">Absolute Jacobian determinant of the covariance matrix inverse transform</h3>
<p>The Jacobian is the product of the Jacobians of the exponential transform from the unconstrained lower-triangular matrix <span class="math inline">\(y\)</span> to matrix <span class="math inline">\(z\)</span> with positive diagonals and the product transform from the Cholesky factor <span class="math inline">\(z\)</span> to <span class="math inline">\(x\)</span>.</p>
<p>The transform from unconstrained <span class="math inline">\(y\)</span> to Cholesky factor <span class="math inline">\(z\)</span> has a diagonal Jacobian matrix, the absolute determinant of which is thus</p>
<p><span class="math display">\[
\prod_{k=1}^K  \frac{\partial}{\partial_{y_{k,k}}} \, \exp(y_{k,k})
\ = \
\prod_{k=1}^K \exp(y_{k,k})
\ = \
\prod_{k=1}^K z_{k,k}.
\]</span></p>
<p>The Jacobian matrix of the second transform from the Cholesky factor <span class="math inline">\(z\)</span> to the covariance matrix <span class="math inline">\(x\)</span> is also triangular, with diagonal entries corresponding to pairs <span class="math inline">\((m,n)\)</span> with <span class="math inline">\(m \geq n\)</span>, defined by</p>
<p><span class="math display">\[
\frac{\partial}{\partial z_{m,n}}
\left( z \, z^{\top} \right)_{m,n}
\ = \
\frac{\partial}{\partial z_{m,n}}
\left( \sum_{k=1}^K z_{m,k} \, z_{n,k} \right)
\ = \
\left\{
\begin{array}{cl}
2 \, z_{n,n} &amp; \mbox{if } m = n \mbox{ and }
\\
z_{n,n} &amp; \mbox{if } m &gt; n.
\end{array}
\right.
\]</span></p>
<p>The absolute Jacobian determinant of the second transform is thus</p>
<p><span class="math display">\[
2^{K} \ \prod_{m = 1}^{K} \ \prod_{n=1}^{m} z_{n,n}
\ = \
\prod_{n=1}^K \ \prod_{m=n}^K z_{n,n}
\ = \
2^{K} \ \prod_{k=1}^K z_{k,k}^{K - k + 1}.
\]</span></p>
<p>Finally, the full absolute Jacobian determinant of the inverse of the covariance matrix transform from the unconstrained lower-triangular <span class="math inline">\(y\)</span> to a symmetric, positive definite matrix <span class="math inline">\(x\)</span> is the product of the Jacobian determinants of the exponentiation and product transforms,</p>
<p><span class="math display">\[
\left( \prod_{k=1}^K z_{k,k} \right)
\left(
2^{K} \ \prod_{k=1}^K z_{k,k}^{K - k + 1}
\right)
\ = \
2^K
\, \prod_{k=1}^K z_{k,k}^{K-k+2}.
\]</span></p>
<p>Let <span class="math inline">\(f^{-1}\)</span> be the inverse transform from a <span class="math inline">\(K + \binom{K}{2}\)</span>-vector <span class="math inline">\(y\)</span> to the <span class="math inline">\(K \times K\)</span> covariance matrix <span class="math inline">\(x\)</span>. A density function <span class="math inline">\(p_X(x)\)</span> defined on <span class="math inline">\(K \times K\)</span> covariance matrices is transformed to the density <span class="math inline">\(p_Y(y)\)</span> over <span class="math inline">\(K + \binom{K}{2}\)</span> vectors <span class="math inline">\(y\)</span> by</p>
<p><span class="math display">\[
p_Y(y) = p_X(f^{-1}(y)) \ 2^K \ \prod_{k=1}^K z_{k,k}^{K-k+2}.
\]</span></p>
</section>
</section>
<section id="cholesky-factors-of-covariance-matrices" class="level2">
<h2 class="anchored" data-anchor-id="cholesky-factors-of-covariance-matrices">Cholesky factors of covariance matrices</h2>
<p>An <span class="math inline">\(M \times M\)</span> covariance matrix <span class="math inline">\(\Sigma\)</span> can be Cholesky factored to a lower triangular matrix <span class="math inline">\(L\)</span> such that <span class="math inline">\(L\,L^{\top} = \Sigma\)</span>. If <span class="math inline">\(\Sigma\)</span> is positive definite, then <span class="math inline">\(L\)</span> will be <span class="math inline">\(M \times M\)</span>. If <span class="math inline">\(\Sigma\)</span> is only positive semi-definite, then <span class="math inline">\(L\)</span> will be <span class="math inline">\(M \times N\)</span>, with <span class="math inline">\(N &lt; M\)</span>.</p>
<p>A matrix is a Cholesky factor for a covariance matrix if and only if it is lower triangular, the diagonal entries are positive, and <span class="math inline">\(M \geq
N\)</span>. A matrix satisfying these conditions ensures that <span class="math inline">\(L \,
L^{\top}\)</span> is positive semi-definite if <span class="math inline">\(M &gt; N\)</span> and positive definite if <span class="math inline">\(M = N\)</span>.</p>
<p>A Cholesky factor of a covariance matrix requires <span class="math inline">\(N + \binom{N}{2} +
(M - N)N\)</span> unconstrained parameters.</p>
<section id="cholesky-factor-of-covariance-matrix-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="cholesky-factor-of-covariance-matrix-transform">Cholesky factor of covariance matrix transform</h3>
<p>Stan’s Cholesky factor transform only requires the first step of the covariance matrix transform, namely log transforming the positive diagonal elements. Suppose <span class="math inline">\(x\)</span> is an <span class="math inline">\(M \times N\)</span> Cholesky factor. The above-diagonal entries are zero, the diagonal entries are positive, and the below-diagonal entries are unconstrained. The transform required is thus</p>
<p><span class="math display">\[
y_{m,n} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } m &lt; n,
\\
\log x_{m,m} &amp; \mbox{if } m = n, \mbox{ and}
\\
x_{m,n} &amp; \mbox{if } m &gt; n.
\end{array}
\right.
\]</span></p>
</section>
<section id="cholesky-factor-of-covariance-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="cholesky-factor-of-covariance-matrix-inverse-transform">Cholesky factor of covariance matrix inverse transform</h3>
<p>The inverse transform need only invert the logarithm with an exponentiation. If <span class="math inline">\(y\)</span> is the unconstrained matrix representation, then the elements of the constrained matrix <span class="math inline">\(x\)</span> is defined by</p>
<p><span class="math display">\[
x_{m,n} =
\left\{
\begin{array}{cl}
0 &amp; \mbox{if } m &lt; n,
\\
\exp(y_{m,m}) &amp; \mbox{if } m = n, \mbox{ and}
\\
y_{m,n} &amp; \mbox{if } m &gt; n.
\end{array}
\right.
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-cholesky-factor-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-cholesky-factor-inverse-transform">Absolute Jacobian determinant of Cholesky factor inverse transform</h3>
<p>The transform has a diagonal Jacobian matrix, the absolute determinant of which is</p>
<p><span class="math display">\[
\prod_{n=1}^N  \frac{\partial}{\partial_{y_{n,n}}} \, \exp(y_{n,n})
\ = \
\prod_{n=1}^N \exp(y_{n,n})
\ = \
\prod_{n=1}^N x_{n,n}.
\]</span></p>
<p>Let <span class="math inline">\(x = f^{-1}(y)\)</span> be the inverse transform from a <span class="math inline">\(N + \binom{N}{2}
+ (M - N)N\)</span> vector to an <span class="math inline">\(M \times N\)</span> Cholesky factor for a covariance matrix <span class="math inline">\(x\)</span> defined in the previous section. A density function <span class="math inline">\(p_X(x)\)</span> defined on <span class="math inline">\(M \times N\)</span> Cholesky factors of covariance matrices is transformed to the density <span class="math inline">\(p_Y(y)\)</span> over <span class="math inline">\(N + \binom{N}{2}
+ (M - N)N\)</span> vectors <span class="math inline">\(y\)</span> by</p>
<p><span class="math display">\[
p_Y(y) = p_X(f^{-1}(y)) \prod_{N=1}^N x_{n,n}.
\]</span></p>
</section>
</section>
<section id="cholesky-factors-of-correlation-matrices" class="level2">
<h2 class="anchored" data-anchor-id="cholesky-factors-of-correlation-matrices">Cholesky factors of correlation matrices</h2>
<p>A <span class="math inline">\(K \times K\)</span> correlation matrix <span class="math inline">\(\Omega\)</span> is positive definite and has a unit diagonal. Because it is positive definite, it can be Cholesky factored to a <span class="math inline">\(K \times K\)</span> lower-triangular matrix <span class="math inline">\(L\)</span> with positive diagonal elements such that <span class="math inline">\(\Omega = L\,L^{\top}\)</span>. Because the correlation matrix has a unit diagonal,</p>
<p><span class="math display">\[
\Omega_{k,k} = L_k\,L_k^{\top} = 1,
\]</span></p>
<p>each row vector <span class="math inline">\(L_k\)</span> of the Cholesky factor is of unit length. The length and positivity constraint allow the diagonal elements of <span class="math inline">\(L\)</span> to be calculated from the off-diagonal elements, so that a Cholesky factor for a <span class="math inline">\(K \times K\)</span> correlation matrix requires only <span class="math inline">\(\binom{K}{2}\)</span> unconstrained parameters.</p>
<section id="cholesky-factor-of-correlation-matrix-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="cholesky-factor-of-correlation-matrix-inverse-transform">Cholesky factor of correlation matrix inverse transform</h3>
<p>It is easiest to start with the inverse transform from the <span class="math inline">\(\binom{K}{2}\)</span> unconstrained parameters <span class="math inline">\(y\)</span> to the <span class="math inline">\(K \times K\)</span> lower-triangular Cholesky factor <span class="math inline">\(x\)</span>. The inverse transform is based on the hyperbolic tangent function, <span class="math inline">\(\tanh\)</span>, which satisfies <span class="math inline">\(\tanh(x) \in (-1,1)\)</span>. Here it will function like an inverse logit with a sign to pick out the direction of an underlying canonical partial correlation; see the <a href="#correlation-matrix-transform.section">section on correlation matrix transforms</a> for more information on the relation between canonical partial correlations and the Cholesky factors of correlation matrices.</p>
<p>Suppose <span class="math inline">\(y\)</span> is a vector of <span class="math inline">\(\binom{K}{2}\)</span> unconstrained values. Let <span class="math inline">\(z\)</span> be a lower-triangular matrix with zero diagonal and below diagonal entries filled by row. For example, in the <span class="math inline">\(3 \times 3\)</span> case,</p>
<p><span class="math display">\[
z =
\left[
\begin{array}{ccc}
0 &amp; 0 &amp; 0
\\
\tanh y_1 &amp; 0 &amp; 0
\\
\tanh y_2 &amp; \tanh y_3 &amp; 0
\end{array}
\right]
\]</span></p>
<p>The matrix <span class="math inline">\(z\)</span>, with entries in the range <span class="math inline">\((-1, 1)\)</span>, is then transformed to the Cholesky factor <span class="math inline">\(x\)</span>, by taking<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p><span class="math display">\[
x_{i,j}
=
\left\{
\begin{array}{lll}
0 &amp; \mbox{ if } i &lt; j &amp; \mbox{ [above diagonal]}
\\
\sqrt{1 - \sum_{j' &lt; j} x_{i,j'}^2}
  &amp; \mbox{ if } i = j &amp; \mbox{ [on diagonal]}
\\
z_{i,j} \ \sqrt{1 - \sum_{j' &lt; j} x_{i,j'}^2}
  &amp; \mbox{ if } i &gt; j &amp; \mbox{ [below diagonal]}
\end{array}
\right.
\]</span></p>
<p>In the <span class="math inline">\(3 \times 3\)</span> case, this yields</p>
<p><span class="math display">\[
x =
\left[
\begin{array}{ccc}
1 &amp; 0 &amp; 0
\\
z_{2,1} &amp; \sqrt{1 - x_{2,1}^2} &amp; 0
\\
z_{3,1} &amp; z_{3,2} \sqrt{1 - x_{3,1}^2}
        &amp; \sqrt{1 - (x_{3,1}^2 + x_{3,2}^2)}
\end{array}
\right],
\]</span></p>
<p>where the <span class="math inline">\(z_{i,j} \in (-1,1)\)</span> are the <span class="math inline">\(\tanh\)</span>-transformed <span class="math inline">\(y\)</span>.</p>
<p>The approach is a signed stick-breaking process on the quadratic (Euclidean length) scale. Starting from length 1 at <span class="math inline">\(j=1\)</span>, each below-diagonal entry <span class="math inline">\(x_{i,j}\)</span> is determined by the (signed) fraction <span class="math inline">\(z_{i,j}\)</span> of the remaining length for the row that it consumes. The diagonal entries <span class="math inline">\(x_{i,i}\)</span> get any leftover length from earlier entries in their row. The above-diagonal entries are zero.</p>
</section>
<section id="cholesky-factor-of-correlation-matrix-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="cholesky-factor-of-correlation-matrix-transform">Cholesky factor of correlation matrix transform</h3>
<p>Suppose <span class="math inline">\(x\)</span> is a <span class="math inline">\(K \times K\)</span> Cholesky factor for some correlation matrix. The first step of the transform reconstructs the intermediate values <span class="math inline">\(z\)</span> from <span class="math inline">\(x\)</span>,</p>
<p><span class="math display">\[
z_{i,j} = \frac{x_{i,j}}{\sqrt{1 - \sum_{j' &lt; j}x_{i,j'}^2}}.
\]</span></p>
<p>The mapping from the resulting <span class="math inline">\(z\)</span> to <span class="math inline">\(y\)</span> inverts <span class="math inline">\(\tanh\)</span>,</p>
<p><span class="math display">\[
y
\ = \
\tanh^{-1} z
\ = \
\frac{1}{2} \left( \log (1 + z) - \log (1 - z) \right).
\]</span></p>
</section>
<section id="absolute-jacobian-determinant-of-inverse-transform" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="absolute-jacobian-determinant-of-inverse-transform">Absolute Jacobian determinant of inverse transform</h3>
<p>The Jacobian of the full transform is the product of the Jacobians of its component transforms.</p>
<p>First, for the inverse transform <span class="math inline">\(z = \tanh y\)</span>, the derivative is</p>
<p><span class="math display">\[
\frac{d}{dy} \tanh y = \frac{1}{(\cosh y)^2}.
\]</span></p>
<p>Second, for the inverse transform of <span class="math inline">\(z\)</span> to <span class="math inline">\(x\)</span>, the resulting Jacobian matrix <span class="math inline">\(J\)</span> is of dimension <span class="math inline">\(\binom{K}{2} \times
\binom{K}{2}\)</span>, with indexes <span class="math inline">\((i,j)\)</span> for <span class="math inline">\((i &gt; j)\)</span>. The Jacobian matrix is lower triangular, so that its determinant is the product of its diagonal entries, of which there is one for each <span class="math inline">\((i,j)\)</span> pair,</p>
<p><span class="math display">\[
\left| \, \mbox{det} \, J \, \right|
  \ = \ \prod_{i &gt; j} \left| \frac{d}{dz_{i,j}} x_{i,j} \right|,
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\frac{d}{dz_{i,j}} x_{i,j}
= \sqrt{1 - \sum_{j' &lt; j} x^2_{i,j'}}.
\]</span></p>
<p>So the combined density for unconstrained <span class="math inline">\(y\)</span> is</p>
<p><span class="math display">\[
p_Y(y)
= p_X(f^{-1}(y))
  \ \
  \prod_{n &lt; \binom{K}{2}} \frac{1}{(\cosh y)^2}
  \ \
  \prod_{i &gt; j} \left( 1 - \sum_{j' &lt; j} x_{i,j'}^2
  \right)^{1/2},
\]</span></p>
<p>where <span class="math inline">\(x = f^{-1}(y)\)</span> is used for notational convenience. The log Jacobian determinant of the complete inverse transform <span class="math inline">\(x = f^{-1}(y)\)</span> is given by</p>
<p><span class="math display">\[
\log \left| \, \det J \, \right|
=
-2 \sum_{n \leq \binom{K}{2}}
\log \cosh y
\
+
\
\frac{1}{2} \
\sum_{i &gt; j}
\log \left( 1 - \sum_{j' &lt; j} x_{i,j'}^2 \right)
.
\]</span></p>



</section>
</section>
</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Betancourt:2010" class="csl-entry" role="listitem">
Betancourt, Michael. 2010. <span>“Cruising the Simplex: <span>H</span>amiltonian <span>M</span>onte <span>C</span>arlo and the <span>D</span>irichlet Distribution.”</span> <em>arXiv</em> 1010.3436. <a href="http://arxiv.org/abs/1010.3436">http://arxiv.org/abs/1010.3436</a>.
</div>
<div id="ref-LewandowskiKurowickaJoe:2009" class="csl-entry" role="listitem">
Lewandowski, Daniel, Dorota Kurowicka, and Harry Joe. 2009. <span>“Generating Random Correlation Matrices Based on Vines and Extended Onion Method.”</span> <em>Journal of Multivariate Analysis</em> 100: 1989–2001.
</div>
<div id="ref-Muller:1959" class="csl-entry" role="listitem">
Muller, Mervin E. 1959. <span>“A Note on a Method for Generating Points Uniformly on n-Dimensional Spheres.”</span> <em>Commun. ACM</em> 2 (4): 19–20. <a href="https://doi.org/10.1145/377939.377946">https://doi.org/10.1145/377939.377946</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>For an alternative derivation of the same transform using hyperspherical coordinates, see <span class="citation" data-cites="Betancourt:2010">(<a href="#ref-Betancourt:2010" role="doc-biblioref">Betancourt 2010</a>)</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>An alternative to the transform in this section, which can be coded directly in Stan, is to parameterize a covariance matrix as a scaled correlation matrix. An arbitrary <span class="math inline">\(K \times K\)</span> covariance matrix <span class="math inline">\(\Sigma\)</span> can be expressed in terms of a <span class="math inline">\(K\)</span>-vector <span class="math inline">\(\sigma\)</span> and correlation matrix <span class="math inline">\(\Omega\)</span> as <span class="math display">\[\Sigma = \mbox{diag}(\sigma) \times \Omega \times \mbox{diag}(\sigma),\]</span> so that each entry is just a deviation-scaled correlation, <span class="math display">\[\Sigma_{m,n} = \sigma_m \times \sigma_n \times \Omega_{m,n}.\]</span><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>For convenience, a summation with no terms, such as <span class="math inline">\(\sum_{j' &lt; 1} x_{i,j'}\)</span>, is defined to be 0. This implies <span class="math inline">\(x_{1,1} = 1\)</span> and that <span class="math inline">\(x_{i,1} = z_{i,1}\)</span> for <span class="math inline">\(i &gt; 1\)</span>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../reference-manual/user-functions.html" class="pagination-link" aria-label="User-Defined Functions">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">User-Defined Functions</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../reference-manual/syntax.html" class="pagination-link" aria-label="Language Syntax">
        <span class="nav-page-text">Language Syntax</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/transforms.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>