<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statements</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../reference-manual/blocks.html" rel="next">
<link href="../reference-manual/expressions.html" rel="prev">
<link href="../img/logo_tm.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 200,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../quarto_styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/logo_tm.png" alt="Stan logo" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../stan-users-guide/index.html"> 
<span class="menu-text">Stan Users Guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../reference-manual/index.html" aria-current="page"> 
<span class="menu-text">Reference Manual</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../functions-reference/index.html"> 
<span class="menu-text">Functions Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-interfaces" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Interfaces</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-interfaces">    
        <li>
    <a class="dropdown-item" href="../cmdstan-guide/index.html">
 <span class="dropdown-text">CmdStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanpy">
 <span class="dropdown-text">CmdStanPy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/cmdstanr">
 <span class="dropdown-text">CmdStanR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/users/interfaces/pystan.html">
 <span class="dropdown-text">PyStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstan">
 <span class="dropdown-text">RStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="http://stanjulia.github.io/Stan.jl/stable/INTRO/">
 <span class="dropdown-text">Stan.jl</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-other-packages" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Other Packages</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-other-packages">    
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/bayesplot/">
 <span class="dropdown-text">bayesplot</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://roualdes.github.io/bridgestan/latest/">
 <span class="dropdown-text">BridgeStan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://paul-buerkner.github.io/brms/">
 <span class="dropdown-text">brms</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/loo/">
 <span class="dropdown-text">loo</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/posterior">
 <span class="dropdown-text">posterior</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/projpred">
 <span class="dropdown-text">projpred</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstanarm">
 <span class="dropdown-text">rstanarm</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/rstantools">
 <span class="dropdown-text">rstantools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mc-stan.org/shinystan">
 <span class="dropdown-text">shinystan</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/stan-dev" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://discourse.mc-stan.org" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-chat-text-fill"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../reference-manual/encoding.html">Language</a></li><li class="breadcrumb-item"><a href="../reference-manual/statements.html">Statements</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stan Reference Manual</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Version 2.43</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Language</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/encoding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Character Encoding</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/includes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Includes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/comments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/whitespace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Whitespace</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Types and Declarations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/expressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Expressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/statements.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Statements</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/blocks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Blocks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/user-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User-Defined Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Constraint Transforms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/syntax.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Language Syntax</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/execution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Program Execution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/deprecations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deprecated Features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/removals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Removed Features</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Algorithms</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MCMC Sampling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Posterior Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/pathfinder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pathfinder</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/variational.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/laplace.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Laplace Approximation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/diagnostics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagnostic Mode</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Usage</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/reproducibility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducibility</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference-manual/licenses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Licenses and Dependencies</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#statements" id="toc-statements" class="nav-link active" data-scroll-target="#statements">Statements</a>
  <ul class="collapse">
  <li><a href="#statement-block-contexts" id="toc-statement-block-contexts" class="nav-link" data-scroll-target="#statement-block-contexts">Statement block contexts</a></li>
  <li><a href="#assignment-statement.section" id="toc-assignment-statement.section" class="nav-link" data-scroll-target="#assignment-statement.section">Assignment statements</a>
  <ul class="collapse">
  <li><a href="#promotion" id="toc-promotion" class="nav-link" data-scroll-target="#promotion">Promotion</a></li>
  <li><a href="#lvalue-summary" id="toc-lvalue-summary" class="nav-link" data-scroll-target="#lvalue-summary">Lvalue summary</a></li>
  <li><a href="#multiple-indexes" id="toc-multiple-indexes" class="nav-link" data-scroll-target="#multiple-indexes">Multiple indexes</a></li>
  <li><a href="#compound-arithmetic-assignment.section" id="toc-compound-arithmetic-assignment.section" class="nav-link" data-scroll-target="#compound-arithmetic-assignment.section">Compound arithmetic and assignment statement</a></li>
  </ul></li>
  <li><a href="#increment-log-prob.section" id="toc-increment-log-prob.section" class="nav-link" data-scroll-target="#increment-log-prob.section">Increment log density</a>
  <ul class="collapse">
  <li><a href="#accessing-the-log-density" id="toc-accessing-the-log-density" class="nav-link" data-scroll-target="#accessing-the-log-density">Accessing the log density</a></li>
  </ul></li>
  <li><a href="#sampling-statements.section" id="toc-sampling-statements.section" class="nav-link" data-scroll-target="#sampling-statements.section">Sampling statements</a>
  <ul class="collapse">
  <li><a href="#log-probability-increment-vs.-sampling-statement" id="toc-log-probability-increment-vs.-sampling-statement" class="nav-link" data-scroll-target="#log-probability-increment-vs.-sampling-statement">Log probability increment vs.&nbsp;sampling statement</a></li>
  <li><a href="#user-transformed-variables" id="toc-user-transformed-variables" class="nav-link" data-scroll-target="#user-transformed-variables">User-transformed variables</a></li>
  <li><a href="#truncated-distributions" id="toc-truncated-distributions" class="nav-link" data-scroll-target="#truncated-distributions">Truncated distributions</a></li>
  </ul></li>
  <li><a href="#for-loops" id="toc-for-loops" class="nav-link" data-scroll-target="#for-loops">For loops</a>
  <ul class="collapse">
  <li><a href="#loop-variable-typing-and-scope" id="toc-loop-variable-typing-and-scope" class="nav-link" data-scroll-target="#loop-variable-typing-and-scope">Loop variable typing and scope</a></li>
  <li><a href="#order-sensitivity-and-repeated-variables" id="toc-order-sensitivity-and-repeated-variables" class="nav-link" data-scroll-target="#order-sensitivity-and-repeated-variables">Order sensitivity and repeated variables</a></li>
  </ul></li>
  <li><a href="#foreach-loops" id="toc-foreach-loops" class="nav-link" data-scroll-target="#foreach-loops">Foreach loops</a></li>
  <li><a href="#conditional-statements" id="toc-conditional-statements" class="nav-link" data-scroll-target="#conditional-statements">Conditional statements</a></li>
  <li><a href="#while-statements" id="toc-while-statements" class="nav-link" data-scroll-target="#while-statements">While statements</a></li>
  <li><a href="#statement-blocks-and-local-variable-declarations" id="toc-statement-blocks-and-local-variable-declarations" class="nav-link" data-scroll-target="#statement-blocks-and-local-variable-declarations">Statement blocks and local variable declarations</a>
  <ul class="collapse">
  <li><a href="#blocks-in-for-loops" id="toc-blocks-in-for-loops" class="nav-link" data-scroll-target="#blocks-in-for-loops">Blocks in for loops</a></li>
  <li><a href="#local-variable-declarations" id="toc-local-variable-declarations" class="nav-link" data-scroll-target="#local-variable-declarations">Local variable declarations</a></li>
  <li><a href="#no-constraints-on-local-variables" id="toc-no-constraints-on-local-variables" class="nav-link" data-scroll-target="#no-constraints-on-local-variables">No constraints on local variables</a></li>
  <li><a href="#blocks-within-blocks" id="toc-blocks-within-blocks" class="nav-link" data-scroll-target="#blocks-within-blocks">Blocks within blocks</a></li>
  </ul></li>
  <li><a href="#break-continue-statements" id="toc-break-continue-statements" class="nav-link" data-scroll-target="#break-continue-statements">Break and continue statements</a>
  <ul class="collapse">
  <li><a href="#break-statements" id="toc-break-statements" class="nav-link" data-scroll-target="#break-statements">Break statements</a></li>
  <li><a href="#continue-statements" id="toc-continue-statements" class="nav-link" data-scroll-target="#continue-statements">Continue statements</a></li>
  <li><a href="#breaking-and-continuing-nested-loops" id="toc-breaking-and-continuing-nested-loops" class="nav-link" data-scroll-target="#breaking-and-continuing-nested-loops">Breaking and continuing nested loops</a></li>
  </ul></li>
  <li><a href="#print-statements.section" id="toc-print-statements.section" class="nav-link" data-scroll-target="#print-statements.section">Print statements</a>
  <ul class="collapse">
  <li><a href="#print-content" id="toc-print-content" class="nav-link" data-scroll-target="#print-content">Print content</a></li>
  <li><a href="#non-void-input" id="toc-non-void-input" class="nav-link" data-scroll-target="#non-void-input">Non-void input</a></li>
  <li><a href="#print-frequency" id="toc-print-frequency" class="nav-link" data-scroll-target="#print-frequency">Print frequency</a></li>
  <li><a href="#string-literals" id="toc-string-literals" class="nav-link" data-scroll-target="#string-literals">String literals</a></li>
  <li><a href="#debug-by-print" id="toc-debug-by-print" class="nav-link" data-scroll-target="#debug-by-print">Debug by <code>print</code></a></li>
  </ul></li>
  <li><a href="#reject-statements.section" id="toc-reject-statements.section" class="nav-link" data-scroll-target="#reject-statements.section">Reject statements</a>
  <ul class="collapse">
  <li><a href="#behavior-of-reject-statements" id="toc-behavior-of-reject-statements" class="nav-link" data-scroll-target="#behavior-of-reject-statements">Behavior of reject statements</a></li>
  <li><a href="#rejection-is-not-for-constraints" id="toc-rejection-is-not-for-constraints" class="nav-link" data-scroll-target="#rejection-is-not-for-constraints">Rejection is not for constraints</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/statements.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="statements" class="level1">
<h1>Statements</h1>
<p>The blocks of a Stan program are made up of variable declarations and statements; see the <a href="../reference-manual/blocks.html">blocks chapter</a> for details. Unlike programs in BUGS, the declarations and statements making up a Stan program are executed in the order in which they are written. Variables must be defined to have some value (as well as declared to have some type) before they are used — if they do not, the behavior is undefined.</p>
<p>The basis of Stan’s execution is the evaluation of a log probability function (specifically, a probability density function) for a given set of (real-valued) parameters. Log probability function can be constructed by using assignment statements. Statements may be grouped into sequences and into for-each loops. In addition, Stan allows local variables to be declared in blocks and also allows an empty statement consisting only of a semicolon.</p>
<section id="statement-block-contexts" class="level2">
<h2 class="anchored" data-anchor-id="statement-block-contexts">Statement block contexts</h2>
<p>The data and parameters blocks do not allow statements of any kind because these blocks are solely used to declare the data variables for input and the parameter variables for sampling. All other blocks allow statements. In these blocks, both variable declarations and statements are allowed. All top-level variables in a block are considered block variables. See the <a href="../reference-manual/blocks.html">blocks chapter</a> for more information about the block structure of Stan programs.</p>
</section>
<section id="assignment-statement.section" class="level2">
<h2 class="anchored" data-anchor-id="assignment-statement.section">Assignment statements</h2>
<p>An assignment statement consists of a variable (possibly multivariate with indexing information) and an expression. Executing an assignment statement evaluates the expression on the right-hand side and assigns it to the (indexed) variable on the left-hand side. An example of a simple assignment is as follows.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>n = <span class="dv">0</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Executing this statement assigns the value of the expression <code>0</code>, which is the integer zero, to the variable <code>n</code>. For an assignment to be well formed, the type of the expression on the right-hand side should be compatible with the type of the (indexed) variable on the left-hand side. For the above example, because <code>0</code> is an expression of type <code>int</code>, the variable <code>n</code> must be declared as being of type <code>int</code> or of type <code>real</code>. If the variable is of type <code>real</code>, the integer zero is promoted to a floating-point zero and assigned to the variable. After the assignment statement executes, the variable <code>n</code> will have the value zero (either as an integer or a floating-point value, depending on its type).</p>
<p>Syntactically, every assignment statement must be followed by a semicolon. Otherwise, whitespace between the tokens does not matter (the tokens here being the left-hand-side (indexed) variable, the assignment operator, the right-hand-side expression and the semicolon).</p>
<p>Because the right-hand side is evaluated first, it is possible to increment a variable in Stan just as in C++ and other programming languages by writing</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n = n + <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Such self assignments are not allowed in BUGS, because they induce a cycle into the directed graphical model.</p>
<p>The left-hand side of an assignment may contain indices for array, matrix, or vector data structures. For instance, if <code>Sigma</code> is of type <code>matrix</code>, then</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Sigma[<span class="dv">1</span>, <span class="dv">1</span>] = <span class="fl">1.0</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>sets the value in the first column of the first row of <code>Sigma</code> to one.</p>
<p>Assignments to subcomponents of larger multi-variate data structures are supported by Stan. For example, <code>a</code> is an array of type <code>array[,] real</code> and <code>b</code> is an array of type <code>array[] real</code>, then the following two statements are both well-formed.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">3</span>] = b;</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>b = a[<span class="dv">4</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Similarly, if <code>x</code> is a variable declared to have type <code>row_vector</code> and <code>Y</code> is a variable declared as type <code>matrix</code>, then the following sequence of statements to swap the first two rows of <code>Y</code> is well formed.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>x = Y[<span class="dv">1</span>];</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Y[<span class="dv">1</span>] = Y[<span class="dv">2</span>];</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Y[<span class="dv">2</span>] = x;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="promotion" class="level3">
<h3 class="anchored" data-anchor-id="promotion">Promotion</h3>
<p>Stan allows assignment of lower types to higher types, but not vice-versa. That is, we can assign an expression of type <code>int</code> to an lvalue of type <code>real</code>, and we can assign an expression of type <code>real</code> to an lvalue of type <code>complex</code>. Furthermore, promotion is transitive, so that we can assign an expression of type <code>int</code> to an lvalue of type <code>complex</code>.</p>
<p>Promotion extends to containers, so that arrays of <code>int</code> can be promoted to arrays of <code>real</code> during assignment, and arrays of <code>real</code> can be assigned to an lvalue of type array of <code>complex</code>. Similarly, an expression of type <code>vector</code> may be assigned to an lvalue of type <code>complex_vector</code>, and similarly for row vectors and matrices.</p>
</section>
<section id="lvalue-summary" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="lvalue-summary">Lvalue summary</h3>
<p>The expressions that are legal left-hand sides of assignment statements are known as “lvalues.” In Stan, there are only two kinds of legal lvalues,</p>
<ul>
<li>a variable, or</li>
<li>a variable with one or more indices.</li>
</ul>
<p>To be used as an lvalue, an indexed variable must have at least as many dimensions as the number of indices provided. An array of real or integer types has as many dimensions as it is declared for. A matrix has two dimensions and a vector or row vector one dimension; this also holds for the constrained types, covariance and correlation matrices and their Cholesky factors and ordered, positive ordered, and simplex vectors. An array of matrices has two more dimensions than the array and an array of vectors or row vectors has one more dimension than the array. Note that the number of indices can be less than the number of dimensions of the variable, meaning that the right hand side must itself be multidimensional to match the remaining dimensions.</p>
</section>
<section id="multiple-indexes" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="multiple-indexes">Multiple indexes</h3>
<p>Multiple indexes, as described in the <a href="../reference-manual/expressions.html#language-multi-indexing.section">multi-indexing section</a>, are also permitted on the left-hand side of assignments. Indexing on the left side works exactly as it does for expressions, with multiple indexes preserving index positions and single indexes reducing them. The type on the left side must still match the type on the right side.</p>
<section id="aliasing" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="aliasing">Aliasing</h4>
<p>All assignment is carried out as if the right-hand side is copied before the assignment. This resolves any potential aliasing issues arising from he right-hand side changing in the middle of an assignment statement’s execution.</p>
</section>
</section>
<section id="compound-arithmetic-assignment.section" class="level3">
<h3 class="anchored" data-anchor-id="compound-arithmetic-assignment.section">Compound arithmetic and assignment statement</h3>
<p>Stan’s arithmetic operators may be used in compound arithmetic and assignment operations. For example, consider the following example of compound addition and assignment.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> x = <span class="dv">5</span>;</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>x += <span class="dv">7</span>;  <span class="co">// value of x is now 12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The compound arithmetic and assignment statement above is equivalent to the following long form.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x = x + <span class="dv">7</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In general, the compound form</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>x op= y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>will be equivalent to</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>x = x op y;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The compound statement will be legal whenever the long form is legal. This requires that the operation <code>x op y</code> must itself be well formed and that the result of the operation be assignable to <code>x</code>. For the expression <code>x</code> to be assignable, it must be an indexed variable where the variable is defined in the current block. For example, the following compound addition and assignment statement will increment a single element of a vector by two.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[N] x;</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">3</span>] += <span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As a further example, consider</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">matrix</span>[M, M] x;</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[M] y;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> z;</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>x *= x;  <span class="co">// OK, (x * x) is a matrix</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>x *= z;  <span class="co">// OK, (x * z) is a matrix</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>x *= y;  <span class="co">// BAD, (x * y) is a vector</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The supported compound arithmetic and assignment operations are listed in the <a href="#compound-arithmetic-assign-table">compound arithmetic/assignment table</a>; they are also listed in the index prefaced by <code>operator</code>, e.g., <code>operator+=</code>.</p>
<p><strong>Compound Arithmetic/Assignment Table.</strong> <a id="compound-arithmetic-assign-table"></a> <em>Stan allows compound arithmetic and assignment statements of the forms listed in the table. The compound form is legal whenever the corresponding long form would be legal and it has the same effect.</em></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">operation</th>
<th style="text-align: left;">compound</th>
<th style="text-align: left;">unfolded</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">addition</td>
<td style="text-align: left;"><code>x += y</code></td>
<td style="text-align: left;"><code>x = x + y</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">subtraction</td>
<td style="text-align: left;"><code>x -= y</code></td>
<td style="text-align: left;"><code>x = x - y</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">multiplication</td>
<td style="text-align: left;"><code>x *= y</code></td>
<td style="text-align: left;"><code>x = x * y</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">division</td>
<td style="text-align: left;"><code>x /= y</code></td>
<td style="text-align: left;"><code>x = x / y</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">elementwise multiplication</td>
<td style="text-align: left;"><code>x .*= y</code></td>
<td style="text-align: left;"><code>x = x .* y</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">elementwise division</td>
<td style="text-align: left;"><code>x ./= y</code></td>
<td style="text-align: left;"><code>x = x ./ y</code></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="increment-log-prob.section" class="level2">
<h2 class="anchored" data-anchor-id="increment-log-prob.section">Increment log density</h2>
<p>The basis of Stan’s execution is the evaluation of a log probability function (specifically, a probability density function) for a given set of (real-valued) parameters; this function returns the log density of the posterior up to an additive constant. Data and transformed data are fixed before the log density is evaluated. The total log probability is initialized to zero. Next, any log Jacobian adjustments accrued by the variable constraints are added to the log density (the Jacobian adjustment may be skipped for optimization). Sampling and log probability increment statements may add to the log density in the model block. A log probability increment statement directly increments the log density with the value of an expression as follows.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> -<span class="fl">0.5</span> * y * y;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The keyword <code>target</code> here is actually not a variable, and may not be accessed as such (though see below on how to access the value of target through a special function).</p>
<p>In this example, the unnormalized log probability of a unit normal variable <span class="math inline">\(y\)</span> is added to the total log probability. In the general case, the argument can be any expression.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>An entire Stan model can be implemented this way. For instance, the following model will draw a single variable according to a unit normal probability.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> y;</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -<span class="fl">0.5</span> * y * y;</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This model defines a log probability function</p>
<p><span class="math display">\[
\log p(y) = - \, \frac{y^2}{2} - \log Z
\]</span></p>
<p>where <span class="math inline">\(Z\)</span> is a normalizing constant that does not depend on <span class="math inline">\(y\)</span>. The constant <span class="math inline">\(Z\)</span> is conventionally written this way because on the linear scale, <span class="math display">\[
p(y) = \frac{1}{Z} \exp\left(-\frac{y^2}{2}\right).
\]</span> which is typically written without reference to <span class="math inline">\(Z\)</span> as <span class="math display">\[
p(y) \propto \exp\left(-\frac{y^2}{2}\right).
\]</span></p>
<p>Stan only requires models to be defined up to a constant that does not depend on the parameters. This is convenient because often the normalizing constant <span class="math inline">\(Z\)</span> is either time-consuming to compute or intractable to evaluate.</p>
<section id="built-in-distributions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="built-in-distributions">Built in distributions</h4>
<p>The built in distribution functions in Stan are all available in normalized and unnormalized form. The normalized forms include all of the terms in the log density, and the unnormalized forms drop terms which are not directly or indirectly a function of the model parameters.</p>
<p>For instance, the <code>normal_lpdf</code> function returns the log density of a normal distribution:</p>
<p><span class="math display">\[
\textsf{normal\_lpdf}(x | \mu, \sigma) =
-\log \left( \sigma \sqrt{2 \pi} \right)
-\frac{1}{2} \left( \frac{x - \mu}{\sigma} \right)^2
\]</span></p>
<p>The <code>normal_lupdf</code> function returns the log density of an unnormalized distribution. With the unnormalized version of the function, Stan does not define what the normalization constant will be, though usually as many terms as possible are dropped to make the calculation fast. Dropping a constant <code>sigma</code> term, <code>normal_lupdf</code> would be equivalent to:</p>
<p><span class="math display">\[
\textsf{normal\_lupdf}(x | \mu, \sigma) =
-\frac{1}{2} \left( \frac{x - \mu}{\sigma} \right)^2
\]</span></p>
<p>All functions ending in <code>_lpdf</code> have a corresponding <code>_lupdf</code> version which evaluates and returns the unnormalized density. The same is true for <code>_lpmf</code> and <code>_lupmf</code>.</p>
</section>
<section id="relation-to-compound-addition-and-assignment" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="relation-to-compound-addition-and-assignment">Relation to compound addition and assignment</h4>
<p>The increment log density statement looks syntactically like compound addition and assignment (see the <a href="#compound-arithmetic-assignment.section">compound arithmetic/assignment section</a>, it is treated as a primitive statement because <code>target</code> is not itself a variable. So, even though</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> lp;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>is a legal statement, the corresponding long form is not legal.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>target = target + lp;  <span class="co">// BAD, target is not a variable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="vectorization" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="vectorization">Vectorization</h4>
<p>The <code>target += ...</code> statement accepts an argument in place of <code>...</code> for any expression type, including integers, reals, vectors, row vectors, matrices, and arrays of any dimensionality, including arrays of vectors and matrices. For container arguments, their sum will be added to the total log density.</p>
</section>
<section id="accessing-the-log-density" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="accessing-the-log-density">Accessing the log density</h3>
<p>To access accumulated log density up to the current execution point, the function <code>target()</code> may be used.</p>
</section>
</section>
<section id="sampling-statements.section" class="level2">
<h2 class="anchored" data-anchor-id="sampling-statements.section">Sampling statements</h2>
<p>Stan supports writing probability statements also in sampling notation, such as</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(mu, sigma);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The name “sampling statement” is meant to be suggestive, not interpreted literally. Conceptually, the variable <code>y</code>, which may be an unknown parameter or known, modeled data, is being declared to have the distribution indicated by the right-hand side of the sampling statement. The above statement can read as “y is distributed as normal distribution with parameters mu and sigma.”. The symbol <code>~</code> is called tilde.</p>
<p>Executing such a statement does not perform any sampling. In Stan, a sampling statement is merely a notational convenience following the typical notation used to present models in the literature. The above sampling statement could be expressed as a direct increment on the total log probability density as</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> normal_lpdf(y | mu, sigma);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In general, a sampling statement of the form</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>y ~ dist(theta1, ..., thetaN);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>involving subexpressions <code>y</code> and <code>theta1</code> through <code>thetaN</code> (including the case where <code>N</code> is zero) will be well formed if and only if the corresponding assignment statement is well-formed. For densities allowing real <code>y</code> values, the log probability density function is used,</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> dist_lpdf(y | theta1, ..., thetaN);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For those restricted to integer <code>y</code> values, the log probability mass function is used,</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> dist_lpmf(y | theta1, ..., thetaN);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will be well formed if and only if <code>dist_lpdf(y | theta1,   ..., thetaN)</code> or <code>dist_lpmf(y | theta1, ..., thetaN)</code> is a well-formed expression of type <code>real</code>.</p>
<section id="log-probability-increment-vs.-sampling-statement" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="log-probability-increment-vs.-sampling-statement">Log probability increment vs.&nbsp;sampling statement</h3>
<p>Although both lead to the same sampling behavior in Stan, there is one critical difference between using the sampling statement, as in</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(mu, sigma);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and explicitly incrementing the log probability function, as in</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> normal_lpdf(y | mu, sigma);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The sampling statement drops all the terms in the log probability function that are constant, whereas the explicit call to <code>normal_lpdf</code> adds all of the terms in the definition of the log normal probability function, including all of the constant normalizing terms. Therefore, the explicit increment form can be used to recreate the exact log probability values for the model. Otherwise, the sampling statement form will be faster if any of the input expressions, <code>y</code>, <code>mu</code>, or <code>sigma</code>, involve only constants, data variables, and transformed data variables.</p>
</section>
<section id="user-transformed-variables" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="user-transformed-variables">User-transformed variables</h3>
<p>The left-hand side of a sampling statement may be a complex expression. For instance, it is legal syntactically to write</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; beta;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  log(beta) ~ normal(mu, sigma);</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Unfortunately, this is not enough to properly model <code>beta</code> as having a lognormal distribution. Whenever a nonlinear transform is applied to a parameter, such as the logarithm function being applied to <code>beta</code> here, and then used on the left-hand side of a sampling statement or on the left of a vertical bar in a log pdf function, an adjustment must be made to account for the differential change in scale and ensure <code>beta</code> gets the correct distribution. The correction required is to add the log Jacobian of the transform to the target log density; see the <a href="#change-of-variables.section">change of variables section</a> for full definitions. For the case above, the following adjustment will account for the log transform.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> - log(abs(y));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="truncated-distributions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="truncated-distributions">Truncated distributions</h3>
<p>Stan supports truncating distributions with lower bounds, upper bounds, or both.</p>
<section id="truncating-with-lower-and-upper-bounds" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncating-with-lower-and-upper-bounds">Truncating with lower and upper bounds</h4>
<p>A probability density function <span class="math inline">\(p(x)\)</span> for a continuous distribution may be truncated to an interval <span class="math inline">\([a, b]\)</span> to define a new density <span class="math inline">\(p_{[a, b]}(x)\)</span> with support <span class="math inline">\([a, b]\)</span> by setting</p>
<p><span class="math display">\[
p_{[a, b]}(x)
= \frac{p(x)}
       {\int_a^b p(u) \, du}.
\]</span></p>
<p>A probability mass function <span class="math inline">\(p(x)\)</span> for a discrete distribution may be truncated to the closed interval <span class="math inline">\([a, b]\)</span> by</p>
<p><span class="math display">\[
p_{[a, b]}(x) = \frac{p(x)}
                  {\sum_{u = a}^b p(u)}.
\]</span></p>
</section>
<section id="truncating-with-a-lower-bound" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncating-with-a-lower-bound">Truncating with a lower bound</h4>
<p>A probability density function <span class="math inline">\(p(x)\)</span> can be truncated to <span class="math inline">\([a, \infty]\)</span> by defining</p>
<p><span class="math display">\[
p_{[a, \infty]}(x)
= \frac{p(x)}
       {\int_a^{\infty} p(u) \, du}.
\]</span></p>
<p>A probability mass function <span class="math inline">\(p(x)\)</span> is truncated to <span class="math inline">\([a, \infty]\)</span> by defining</p>
<p><span class="math display">\[
p_{[a, \infty]}(x) = \frac{p(x)}
                  {\sum_{a &lt;= u} p(u)}.
\]</span></p>
</section>
<section id="truncating-with-an-upper-bound" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncating-with-an-upper-bound">Truncating with an upper bound</h4>
<p>A probability density function <span class="math inline">\(p(x)\)</span> can be truncated to <span class="math inline">\([-\infty, b]\)</span> by defining</p>
<p><span class="math display">\[
p_{[-\infty, b]}(x)
= \frac{p(x)}
       {\int_{-\infty}^b p(u) \, du}.
\]</span></p>
<p>A probability mass function <span class="math inline">\(p(x)\)</span> is truncated to <span class="math inline">\([-\infty, b]\)</span> by defining</p>
<p><span class="math display">\[
p_{[-\infty,b]}(x) = \frac{p(x)}
                  {\sum_{u &lt;= b} p(u)}.
\]</span></p>
</section>
<section id="cumulative-distribution-functions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="cumulative-distribution-functions">Cumulative distribution functions</h4>
<p>Given a probability function <span class="math inline">\(p_X(x)\)</span> for a random variable <span class="math inline">\(X\)</span>, its cumulative distribution function (cdf) <span class="math inline">\(F_X(x)\)</span> is defined to be the probability that <span class="math inline">\(X \leq x\)</span>,</p>
<p><span class="math display">\[
F_X(x) = \Pr[X \leq x].
\]</span></p>
<p>The upper-case variable <span class="math inline">\(X\)</span> is the random variable whereas the lower-case variable <span class="math inline">\(x\)</span> is just an ordinary bound variable. For continuous random variables, the definition of the cdf works out to</p>
<p><span class="math display">\[
F_X(x) \ = \ \int_{-\infty}^{x} p_X(u) \, du,
\]</span></p>
<p>For discrete variables, the cdf is defined to include the upper bound given by the argument,</p>
<p><span class="math display">\[
F_X(x) = \sum_{u \leq x} p_X(u).
\]</span></p>
</section>
<section id="complementary-cumulative-distribution-functions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="complementary-cumulative-distribution-functions">Complementary cumulative distribution functions</h4>
<p>The complementary cumulative distribution function (ccdf) in both the continuous and discrete cases is given by</p>
<p><span class="math display">\[
F^C_X(x)
\ = \ \Pr[X &gt; x]
\ = \ 1 - F_X(x).
\]</span></p>
<p>Unlike the cdf, the ccdf is exclusive of the bound, hence the event <span class="math inline">\(X &gt; x\)</span> rather than the cdf’s event <span class="math inline">\(X \leq x\)</span>.</p>
<p>For continuous distributions, the ccdf works out to</p>
<p><span class="math display">\[
F^C_X(x)
\ = \ 1 - \int_{-\infty}^x p_X(u) \, du
\ = \ \int_x^{\infty} p_X(u) \, du.
\]</span></p>
<p>The lower boundary can be included in the integration bounds because it is a single point on a line and hence has no probability mass. For the discrete case, the lower bound must be excluded in the summation explicitly by summing over <span class="math inline">\(u &gt; x\)</span>,</p>
<p><span class="math display">\[
F^C_X(x)
\ = \ 1 - \sum_{u \leq x} p_X(u)
\ = \ \sum_{u &gt; x} p_X(u).
\]</span></p>
<p>Cumulative distribution functions provide the necessary integral calculations to define truncated distributions. For truncation with lower and upper bounds, the denominator is defined by <span class="math display">\[
\int_a^b p(u) \, du = F_X(b) - F_X(a).
\]</span> This allows truncated distributions to be defined as <span class="math display">\[
p_{[a,b]}(x) = \frac{p_X(x)}
                  {F_X(b) - F_X(a)}.
\]</span></p>
<p>For discrete distributions, a slightly more complicated form is required to explicitly insert the lower truncation point, which is otherwise excluded from <span class="math inline">\(F_X(b) - F_X(a)\)</span>,</p>
<p><span class="math display">\[
p_{[a,b]}(x) = \frac{p_X(x)}
                  {F_X(b) - F_X(a) + p_X(a)}.
\]</span></p>
</section>
<section id="truncation-with-lower-and-upper-bounds-in-stan" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncation-with-lower-and-upper-bounds-in-stan">Truncation with lower and upper bounds in Stan</h4>
<p>Stan allows probability functions to be truncated. For example, a truncated unit normal distributions restricted to <span class="math inline">\([-0.5, 2.1]\)</span> can be coded with the following sampling statement.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>) <span class="kw">T</span>[-<span class="fl">0.5</span>, <span class="fl">2.1</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Truncated distributions are translated as an additional term in the accumulated log density function plus error checking to make sure the variate in the sampling statement is within the bounds of the truncation.</p>
<p>In general, the truncation bounds and parameters may be parameters or local variables.</p>
<p>Because the example above involves a continuous distribution, it behaves the same way as the following more verbose form.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &lt; -<span class="fl">0.5</span> || y &gt; <span class="fl">2.1</span>) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -log_diff_exp(normal_lcdf(<span class="fl">2.1</span> | <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                          normal_lcdf(-<span class="fl">0.5</span> | <span class="dv">0</span>, <span class="dv">1</span>));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Because a Stan program defines a log density function, all calculations are on the log scale. The function <code>normal_lcdf</code> is the log of the cumulative normal distribution function and the function <code>log_diff_exp(a, b)</code> is a more arithmetically stable form of <code>log(exp(a) - exp(b))</code>.</p>
<p>For a discrete distribution, another term is necessary in the denominator to account for the excluded boundary. The truncated discrete distribution</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>) <span class="kw">T</span>[<span class="dv">2</span>, <span class="dv">10</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>behaves in the same way as the following code.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>);</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &lt; <span class="dv">2</span> || y &gt; <span class="dv">10</span>) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -log_sum_exp(poisson_lpmf(<span class="dv">2</span> | <span class="fl">3.7</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                         log_diff_exp(poisson_lcdf(<span class="dv">10</span> | <span class="fl">3.7</span>),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                                      poisson_lcdf(<span class="dv">2</span> | <span class="fl">3.7</span>)));</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Recall that <code>log_sum_exp(a, b)</code> is just the arithmetically stable form of <code>log(exp(a) + exp(b))</code>.</p>
</section>
<section id="truncation-with-lower-bounds-in-stan" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncation-with-lower-bounds-in-stan">Truncation with lower bounds in Stan</h4>
<p>For truncating with only a lower bound, the upper limit is left blank.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>) <span class="kw">T</span>[-<span class="fl">0.5</span>, ];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This truncated sampling statement has the same behavior as the following code.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &lt; -<span class="fl">0.5</span>) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -normal_lccdf(-<span class="fl">0.5</span> | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>normal_lccdf</code> function is the normal complementary cumulative distribution function.</p>
<p>As with lower and upper truncation, the discrete case requires a more complicated denominator to add back in the probability mass for the lower bound. Thus</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>) <span class="kw">T</span>[<span class="dv">2</span>, ];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>behaves the same way as</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>);</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &lt; <span class="dv">2</span>) {</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -log_sum_exp(poisson_lpmf(<span class="dv">2</span> | <span class="fl">3.7</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                         poisson_lccdf(<span class="dv">2</span> | <span class="fl">3.7</span>));</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="truncation-with-upper-bounds-in-stan" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="truncation-with-upper-bounds-in-stan">Truncation with upper bounds in Stan</h4>
<p>To truncate with only an upper bound, the lower bound is left blank. The upper truncated sampling statement</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>, <span class="dv">1</span>) <span class="kw">T</span>[ , <span class="fl">2.1</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>produces the same result as the following code.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">target +=</span> normal_lpdf(y | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &gt; <span class="fl">2.1</span>) {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -normal_lcdf(<span class="fl">2.1</span> | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With only an upper bound, the discrete case does not need a boundary adjustment. The upper-truncated sampling statement</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>) <span class="kw">T</span>[ , <span class="dv">10</span>];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>behaves the same way as the following code.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>y ~ poisson(<span class="fl">3.7</span>);</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (y &gt; <span class="dv">10</span>) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> negative_infinity();</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> -poisson_lcdf(<span class="dv">10</span> | <span class="fl">3.7</span>);</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cumulative-distributions-must-be-defined" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="cumulative-distributions-must-be-defined">Cumulative distributions must be defined</h4>
<p>In all cases, the truncation is only well formed if the appropriate log density or mass function and necessary log cumulative distribution functions are defined. Not every distribution built into Stan has log cdf and log ccdfs defined, nor will every user-defined distribution. The discrete probability function documentations describes the available discrete and continuous cumulative distribution functions; most univariate distributions have log cdf and log ccdf functions.</p>
</section>
<section id="type-constraints-on-bounds" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="type-constraints-on-bounds">Type constraints on bounds</h4>
<p>For continuous distributions, truncation points must be expressions of type <code>int</code> or <code>real</code>. For discrete distributions, truncation points must be expressions of type <code>int</code>.</p>
</section>
<section id="variates-outside-of-truncation-bounds" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="variates-outside-of-truncation-bounds">Variates outside of truncation bounds</h4>
<p>For a truncated sampling statement, if the value sampled is not within the bounds specified by the truncation expression, the result is zero probability and the entire statement adds <span class="math inline">\(-\infty\)</span> to the total log probability, which in turn results in the sample being rejected.</p>
</section>
<section id="vectorizing-truncated-distributions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="vectorizing-truncated-distributions">Vectorizing truncated distributions</h4>
<p>Vectorization of distribution functions with truncation is available if the underlying distribution, <code>lcdf</code>, and <code>lccdf</code> functions meet the required signatures.</p>
<p>The equivalent code for a vectorized truncation depends on which of the variables are non-scalars (arrays, vectors, etc.):</p>
<ol type="1">
<li><p>If the variate <code>y</code> is the only non-scalar, the result is the same as described in the above sections, but the <code>lcdf</code>/<code>lccdf</code> calculation is multiplied by <code>size(y)</code>.</p></li>
<li><p>If the other arguments to the distribution are non-scalars, then the vectorized version of the <code>lcdf</code>/<code>lccdf</code> is used. These functions return the sum of their terms, so no multiplication by the size is needed.</p></li>
<li><p>The exception to the above is when a non-variate is a vector and both a lower and upper bound are specified in the truncation. In this case, a for loop is generated over the elements of the non-scalar arguments. This is required since the <code>log_diff_exp</code> of two sums is not the same as the sum of the pairwise <code>log_diff_exp</code> operations.</p></li>
</ol>
<p>Note that while a lower-and-upper truncated distribution may generate a for-loop internally as part of translating the truncation statement, this is still preferable to manually constructing a loop, since the distribution function itself can still be evaluated in a vectorized manner.</p>
</section>
</section>
</section>
<section id="for-loops" class="level2">
<h2 class="anchored" data-anchor-id="for-loops">For loops</h2>
<p>Suppose <code>N</code> is a variable of type <code>int</code>, <code>y</code> is a one-dimensional array of type <code>array[] real</code>, and <code>mu</code> and <code>sigma</code> are variables of type <code>real</code>. Furthermore, suppose that <code>n</code> has not been defined as a variable. Then the following is a well-formed for-loop statement.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  y[n] ~ normal(mu, sigma);</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The loop variable is <code>n</code>, the loop bounds are the values in the range <code>1:N</code>, and the body is the statement following the loop bounds.</p>
<section id="loop-variable-typing-and-scope" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="loop-variable-typing-and-scope">Loop variable typing and scope</h3>
<p>The type of the loop variable is <code>int</code>. Unlike in C++ and similarly to R, this variable must not be declared explicitly.</p>
<p>The bounds in a for loop must be integers. Unlike in R, the loop is always interpreted as an upward counting loop. The range <code>L:H</code> will cause the loop to execute the loop with the loop variable taking on all integer values greater than or equal to <code>L</code> and less than or equal to <code>H</code>. For example, the loop <code>for (n in 2:5)</code> will cause the body of the for loop to be executed with <code>n</code> equal to 2, 3, 4, and 5, in order. The variable and bound <code>for (n in   5:2)</code> will not execute anything because there are no integers greater than or equal to 5 and less than or equal to 2.</p>
<p>The scope of the loop variable is limited to the body of the loop.</p>
</section>
<section id="order-sensitivity-and-repeated-variables" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="order-sensitivity-and-repeated-variables">Order sensitivity and repeated variables</h3>
<p>Unlike in BUGS, Stan allows variables to be reassigned. For example, the variable <code>theta</code> in the following program is reassigned in each iteration of the loop.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  theta = inv_logit(alpha + x[n] * beta);</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  y[n] ~ bernoulli(theta);</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Such reassignment is not permitted in BUGS. In BUGS, for loops are declarative, defining plates in directed graphical model notation, which can be thought of as repeated substructures in the graphical model. Therefore, it is illegal in BUGS or JAGS to have a for loop that repeatedly reassigns a value to a variable.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>In Stan, assignments are executed in the order they are encountered. As a consequence, the following Stan program has a very different interpretation than the previous one.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  y[n] ~ bernoulli(theta);</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  theta = inv_logit(alpha + x[n] * beta);</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this program, <code>theta</code> is assigned after it is used in the probability statement. This presupposes it was defined before the first loop iteration (otherwise behavior is undefined), and then each loop uses the assignment from the previous iteration.</p>
<p>Stan loops may be used to accumulate values. Thus it is possible to sum the values of an array directly using code such as the following.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>total = <span class="fl">0.0</span>;</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  total = total + x[n];</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After the for loop is executed, the variable <code>total</code> will hold the sum of the elements in the array <code>x</code>. This example was purely pedagogical; it is easier and more efficient to write</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>total = sum(x);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A variable inside (or outside) a loop may even be reassigned multiple times, as in the following legal code.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:<span class="dv">100</span>) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  y += y * epsilon;</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  epsilon = <span class="fl">0.5</span> * epsilon;</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  y += y * epsilon;</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="foreach-loops" class="level2">
<h2 class="anchored" data-anchor-id="foreach-loops">Foreach loops</h2>
<p>A second form of for loops allows iteration over elements of containers. If <code>ys</code> is an expression denoting a container (vector, row vector, matrix, or array) with elements of type <code>T</code>, then the following is a well-formed foreach statement.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> ys) {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... do something with y ...</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The order in which elements of <code>ys</code> are visited is defined for container types as follows.</p>
<ul>
<li><p><code>vector</code>, <code>row_vector</code>: elements visited in order, <code>y</code> is of type <code>double</code></p></li>
<li><p><code>matrix</code>: elements visited in column-major order, <code>y</code> is of type <code>double</code></p></li>
<li><p><code>array[] T</code>: elements visited in order, <code>y</code> is of type <code>T</code>.</p></li>
</ul>
<p>Consequently, if <code>ys</code> is a two dimensional array <code>array[,] real</code>, <code>y</code> will be a one-dimensional array of real values (type <code>array[] real</code>). If ’ys<code>is a matrix, then</code>y<code>will be a real value (type</code>real`). To loop over all values of a two-dimensional array using foreach statements would require a doubly-nested loop,</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="dt">array</span>[<span class="dv">2</span>, <span class="dv">3</span>] <span class="dt">real</span> yss;</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ys <span class="cf">in</span> yss) {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (y <span class="cf">in</span> ys) {</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... do something with y ...</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>whereas a matrix can be looped over in one foreach statement</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">matrix</span>[<span class="dv">2</span>, <span class="dv">3</span>] yss;</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> yss) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">// ... do something with y...</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In both cases, the loop variable <code>y</code> is of type <code>real.  The elements of the matrix are visited in column-major order (e.g.,</code>y[1, 1]<code>,</code>y[2, 1]<code>,</code>y[1, 2]<code>, ...,</code>y[2, 3]<code>), whereas the elements of the two-dimensional array are visited in row-major order (e.g.,</code>y[1, 1]<code>,</code>y[1, 2]<code>,</code>y[1, 3]<code>,</code>y[2, 1]<code>, ...,</code>y[2, 3]`).</p>
</section>
<section id="conditional-statements" class="level2">
<h2 class="anchored" data-anchor-id="conditional-statements">Conditional statements</h2>
<p>Stan supports full conditional statements using the same if-then-else syntax as C++. The general format is</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition1)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  statement1</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> (condition2)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  statement2</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="cf">if</span> (conditionN<span class="dv">-1</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  statementN<span class="dv">-1</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  statementN</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There must be a single leading <code>if</code> clause, which may be followed by any number of <code>else if</code> clauses, all of which may be optionally followed by an <code>else</code> clause. Each condition must be an integer value, with non-zero values interpreted as true and the zero value as false.</p>
<p>The entire sequence of if-then-else clauses forms a single conditional statement for evaluation. The conditions are evaluated in order until one of the conditions evaluates to a non-zero value, at which point its corresponding statement is executed and the conditional statement finishes execution. If none of the conditions evaluate to a non-zero value and there is a final else clause, its statement is executed.</p>
</section>
<section id="while-statements" class="level2">
<h2 class="anchored" data-anchor-id="while-statements">While statements</h2>
<p>Stan supports standard while loops using the same syntax as C++. The general format is as follows.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (condition)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  body</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The condition must be an integer expression and the body can be any statement (or sequence of statements in curly braces).</p>
<p>Evaluation of a while loop starts by evaluating the condition. If the condition evaluates to a false (zero) value, the execution of the loop terminates and control moves to the position after the loop. If the loop’s condition evaluates to a true (non-zero) value, the body statement is executed, then the whole loop is executed again. Thus the loop is continually executed as long as the condition evaluates to a true value.</p>
<p>The rest of the body of a while loop may be skipped using a <code>continue</code>. The loop will be exited with a <code>break</code> statement. See the <a href="#break-continue-statements">section on continue and break statements</a> for more details.</p>
</section>
<section id="statement-blocks-and-local-variable-declarations" class="level2">
<h2 class="anchored" data-anchor-id="statement-blocks-and-local-variable-declarations">Statement blocks and local variable declarations</h2>
<p>Just as parentheses may be used to group expressions, curly brackets may be used to group a sequence of zero or more statements into a statement block. At the beginning of each block, local variables may be declared that are scoped over the rest of the statements in the block.</p>
<section id="blocks-in-for-loops" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="blocks-in-for-loops">Blocks in for loops</h3>
<p>Blocks are often used to group a sequence of statements together to be used in the body of a for loop. Because the body of a for loop can be any statement, for loops with bodies consisting of a single statement can be written as follows.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  y[n] ~ normal(mu, sigma);</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To put multiple statements inside the body of a for loop, a block is used, as in the following example.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  lambda[n] ~ gamma(alpha, beta);</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  y[n] ~ poisson(lambda[n]);</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The open curly bracket (<code>{</code>) is the first character of the block and the close curly bracket (<code>}</code>) is the last character.</p>
<p>Because whitespace is ignored in Stan, the following program will not compile.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  y[n] ~ normal(mu, sigma);</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  z[n] ~ normal(mu, sigma); <span class="co">// ERROR!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The problem is that the body of the for loop is taken to be the statement directly following it, which is <code>y[n] ~ normal(mu, sigma)</code>. This leaves the probability statement for <code>z[n]</code> hanging, as is clear from the following equivalent program.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  y[n] ~ normal(mu, sigma);</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>z[n] ~ normal(mu, sigma); <span class="co">// ERROR!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Neither of these programs will compile. If the loop variable <code>n</code> was defined before the for loop, the for-loop declaration will raise an error. If the loop variable <code>n</code> was not defined before the for loop, then the use of the expression <code>z[n]</code> will raise an error.</p>
</section>
<section id="local-variable-declarations" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="local-variable-declarations">Local variable declarations</h3>
<p>A for loop has a statement as a body. It is often convenient in writing programs to be able to define a local variable that will be used temporarily and then forgotten. For instance, the for loop example of repeated assignment should use a local variable for maximum clarity and efficiency, as in the following example.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> theta;</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  theta = inv_logit(alpha + x[n] * beta);</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  y[n] ~ bernoulli(theta);</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The local variable <code>theta</code> is declared here inside the for loop. The scope of a local variable is just the block in which it is defined. Thus <code>theta</code> is available for use inside the for loop, but not outside of it. As in other situations, Stan does not allow variable hiding. So it is illegal to declare a local variable <code>theta</code> if the variable theta is already defined in the scope of the for loop. For instance, the following is not legal.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span>:M) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> theta;</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span> theta; <span class="co">// ERROR!</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    theta = inv_logit(alpha + x[m, n] * beta);</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    y[m, n] ~ bernoulli(theta);</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The compiler will flag the second declaration of <code>theta</code> with a message that it is already defined.</p>
</section>
<section id="no-constraints-on-local-variables" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="no-constraints-on-local-variables">No constraints on local variables</h3>
<p>Local variables may not have constraints on their declaration. The only types that may be used are</p>
<pre><code>int, real, vector[K], row_vector[K], matrix[M, N].</code></pre>
</section>
<section id="blocks-within-blocks" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="blocks-within-blocks">Blocks within blocks</h3>
<p>A block is itself a statement, so anywhere a sequence of statements is allowed, one or more of the statements may be a block. For instance, in a for loop, it is legal to have the following</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span>:M) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> n = <span class="dv">2</span> * m;</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>     sum += n;</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    sum += x[m, n];</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The variable declaration <code>int n;</code> is the first element of an embedded block and so has scope within that block. The for loop defines its own local block implicitly over the statement following it in which the loop variable is defined. As far as Stan is concerned, these two uses of <code>n</code> are unrelated.</p>
</section>
</section>
<section id="break-continue-statements" class="level2">
<h2 class="anchored" data-anchor-id="break-continue-statements">Break and continue statements</h2>
<p>The one-token statements <code>continue</code> and <code>break</code> may be used within loops to alter control flow; <code>continue</code> causes the next iteration of the loop to run immediately, whereas <code>break</code> terminates the loop and causes execution to resume after the loop. Both control structures must appear in loops. Both <code>break</code> and <code>continue</code> scope to the most deeply nested loop, but pass through non-loop statements.</p>
<p>Although these control statements may seem undesirable because of their goto-like behavior, their judicious use can greatly improve readability by reducing the level of nesting or eliminating bookkeeping inside loops.</p>
<section id="break-statements" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="break-statements">Break statements</h3>
<p>When a <code>break</code> statement is executed, the most deeply nested loop currently being executed is ended and execution picks up with the next statement after the loop. For example, consider the following program:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="dv">1</span>) {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n &lt; <span class="dv">0</span>) {</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span>;</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  foo(n);</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  n = n - <span class="dv">1</span>;</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>while~(1)</code> loop is a “forever” loop, because <code>1</code> is the true value, so the test always succeeds. Within the loop, if the value of <code>n</code> is less than 0, the loop terminates, otherwise it executes <code>foo(n)</code> and then decrements <code>n</code>. The statement above does exactly the same thing as</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (n &gt;= <span class="dv">0</span>) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  foo(n);</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  n = n - <span class="dv">1</span>;</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This case is simply illustrative of the behavior; it is not a case where a <code>break</code> simplifies the loop.</p>
</section>
<section id="continue-statements" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="continue-statements">Continue statements</h3>
<p>The <code>continue</code> statement ends the current operation of the loop and returns to the condition at the top of the loop. Such loops are typically used to exclude some values from calculations. For example, we could use the following loop to sum the positive values in the array <code>x</code>,</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> sum;</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>sum = <span class="dv">0</span>;</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:size(x)) {</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x[n] &lt;= <span class="dv">0</span>) {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span>;</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  sum += x[n];</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the continue statement is executed, control jumps back to the conditional part of the loop. With while and for loops, this causes control to return to the conditional of the loop. With for loops, this advances the loop variable, so the the above program will not go into an infinite loop when faced with an <code>x[n]</code> less than zero. Thus the above program could be rewritten with deeper nesting by reversing the conditional,</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">real</span> sum;</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>sum = <span class="dv">0</span>;</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:size(x)) {</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x[n] &gt; <span class="dv">0</span>) {</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    sum += x[n];</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>While the latter form may seem more readable in this simple case, the former has the main line of execution nested one level less deep. Instead, the conditional at the top finds cases to exclude and doesn’t require the same level of nesting for code that’s not excluded. When there are several such exclusion conditions, the break or continue versions tend to be much easier to read.</p>
</section>
<section id="breaking-and-continuing-nested-loops" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="breaking-and-continuing-nested-loops">Breaking and continuing nested loops</h3>
<p>If there is a loop nested within a loop, a <code>break</code> or <code>continue</code> statement only breaks out of the inner loop. So</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (cond1) {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (cond2) {</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cond3) {</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// execution continues here after break</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If the break is triggered by <code>cond3</code> being true, execution will continue after the nested loop.</p>
<p>As with break statements, continue statements go back to the top of the most deeply nested loop in which the <code>continue</code> appears.</p>
<p>Although break and continue must appear within loops, they may appear in nested statements within loops, such as within the conditionals shown above or within nested statements. The break and continue statements jump past any control structure other than while-loops and for-loops.</p>
</section>
</section>
<section id="print-statements.section" class="level2">
<h2 class="anchored" data-anchor-id="print-statements.section">Print statements</h2>
<p>Stan provides print statements that can print literal strings and the values of expressions. Print statements accept any number of arguments. Consider the following for-each statement with a print statement in its body.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) { <span class="kw">print</span>(<span class="st">"loop iteration: "</span>, n); ... }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The print statement will execute every time the body of the loop does. Each time the loop body is executed, it will print the string “loop iteration:” (with the trailing space), followed by the value of the expression <code>n</code>, followed by a new line.</p>
<section id="print-content" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="print-content">Print content</h3>
<p>The text printed by a print statement varies based on its content. A literal (i.e., quoted) string in a print statement always prints exactly that string (without the quotes). Expressions in print statements result in the value of the expression being printed. But how the value of the expression is formatted will depend on its type.</p>
<p>Printing a simple <code>real</code> or <code>int</code> typed variable always prints the variable’s value.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>For array, vector, and matrix variables, the print format uses brackets. For example, a 3-vector will print as</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>and a <span class="math inline">\(2 \times 3\)</span>-matrix as</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>[[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Complex numbers print as pairs. For example, the pair of statements</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="dt">complex</span> z = to_complex(<span class="fl">1.2</span>, -<span class="fl">3.5</span>);</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">print</span>(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>will print as <code>(1.2,-3.5)</code>, with no space after the comma or within the parentheses.</p>
<p>Printing a more readable version of arrays or matrices can be done with loops. An example is the print statement in the following transformed data block.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[<span class="dv">2</span>, <span class="dv">2</span>] u;</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  u[<span class="dv">1</span>, <span class="dv">1</span>] = <span class="fl">1.0</span>;   u[<span class="dv">1</span>, <span class="dv">2</span>] = <span class="fl">4.0</span>;</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  u[<span class="dv">2</span>, <span class="dv">1</span>] = <span class="fl">9.0</span>;   u[<span class="dv">2</span>, <span class="dv">2</span>] = <span class="fl">16.0</span>;</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:<span class="dv">2</span>) {</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">print</span>(<span class="st">"u["</span>, n, <span class="st">"] = "</span>, u[n]);</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This print statement executes twice, printing the following two lines of output.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>u[<span class="dv">1</span>] = [<span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>u[<span class="dv">2</span>] = [<span class="dv">9</span>, <span class="dv">16</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="non-void-input" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="non-void-input">Non-void input</h3>
<p>The input type to a print function cannot be void. In particular, it can’t be the result of a user-defined void function. All other types are allowed as arguments to the print function.</p>
</section>
<section id="print-frequency" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="print-frequency">Print frequency</h3>
<p>Printing for a print statement happens every time it is executed. The <code>transformed data</code> block is executed once per chain, the <code>transformed parameter</code> and <code>model</code> blocks once per leapfrog step, and the <code>generated quantities</code> block once per iteration.</p>
</section>
<section id="string-literals" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="string-literals">String literals</h3>
<p>String literals begin and end with a double quote character (<code>"</code>). The characters between the double quote characters may be any byte sequence, with the exception of the double quote character.</p>
<p>The Stan interfaces preserve the byte sequences which they receive. The encoding of these byte sequences as characters and their rendering as glyphs will be handled by whatever display mechanism is being used to monitor Stan’s output (e.g., a terminal, a Jupyter notebook, RStudio, etc.). Stan does not enforce a character encoding for strings, and no attempt is made to validate the bytes as legal ASCII, UTF-8, etc.</p>
</section>
<section id="debug-by-print" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="debug-by-print">Debug by <code>print</code></h3>
<p>Because Stan is an imperative language, print statements can be very useful for debugging. They can be used to display the values of variables or expressions at various points in the execution of a program. They are particularly useful for spotting problematic not-a-number of infinite values, both of which will be printed.</p>
<p>It is particularly useful to print the value of the target log density accumulator (through the <code>target()</code> function), as in the following example.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">vector</span>[<span class="dv">2</span>] y;</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] = <span class="dv">1</span>;</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="kw">print</span>(<span class="st">"log density before ="</span>, target());</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>y ~ normal(<span class="dv">0</span>,<span class="dv">1</span>);  <span class="co">// bug!  y[2] not defined</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="kw">print</span>(<span class="st">"log density after ="</span>, target());</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The example has a bug in that <code>y[2]</code> is not defined before the vector <code>y</code> is used in the sampling statement. By printing the value of the log probability accumulator before and after each sampling statement, it’s possible to isolate where the log probability becomes ill-defined (i.e., becomes not-a-number).</p>
</section>
</section>
<section id="reject-statements.section" class="level2">
<h2 class="anchored" data-anchor-id="reject-statements.section">Reject statements</h2>
<p>The Stan <code>reject</code> statement provides a mechanism to report errors or problematic values encountered during program execution and either halt processing or reject iterations.</p>
<p>Like the <code>print</code> statement, the reject statement accepts any number of quoted string literals or Stan expressions as arguments.</p>
<p>Reject statements are typically embedded in a conditional statement in order to detect variables in illegal states. For example, the following code handles the case where a variable <code>x</code>’s value is negative.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (x &lt; <span class="dv">0</span>) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">reject</span>(<span class="st">"x must not be negative; found x="</span>, x);</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="behavior-of-reject-statements" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="behavior-of-reject-statements">Behavior of reject statements</h3>
<p>Reject statements have the same behavior as exceptions thrown by built-in Stan functions. For example, the <code>normal_lpdf</code> function raises an exception if the input scale is not positive and finite. The effect of a reject statement depends on the program block in which the rejection occurs.</p>
<p>In all cases of rejection, the interface accessing the Stan program should print the arguments to the reject statement.</p>
<section id="rejections-in-functions" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="rejections-in-functions">Rejections in functions</h4>
<p>Rejections in user-defined functions are just passed to the calling function or program block. Reject statements can be used in functions to validate the function arguments, allowing user-defined functions to fully emulate built-in function behavior. It is better to find out earlier rather than later when there is a problem.</p>
</section>
<section id="fatal-exception-contexts" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="fatal-exception-contexts">Fatal exception contexts</h4>
<p>In both the transformed data block and generated quantities block, rejections are fatal. This is because if initialization fails or if generating output fails, there is no way to recover values.</p>
<p>Reject statements placed in the transformed data block can be used to validate both the data and transformed data (if any). This allows more complicated constraints to be enforced that can be specified with Stan’s constrained variable declarations.</p>
</section>
<section id="recoverable-rejection-contexts" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="recoverable-rejection-contexts">Recoverable rejection contexts</h4>
<p>Rejections in the transformed parameters and model blocks are not in and of themselves instantly fatal. The result has the same effect as assigning a <span class="math inline">\(-\infty\)</span> log probability, which causes rejection of the current proposal in MCMC samplers and adjustment of search parameters in optimization.</p>
<p>If the log probability function results in a rejection every time it is called, the containing application (MCMC sampler or optimization) should diagnose this problem and terminate with an appropriate error message. To aid in diagnosing problems, the message for each reject statement will be printed as a result of executing it.</p>
</section>
</section>
<section id="rejection-is-not-for-constraints" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="rejection-is-not-for-constraints">Rejection is not for constraints</h3>
<p>Rejection should be used for error handling, not defining arbitrary constraints. Consider the following errorful Stan program.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> a;</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=a&gt; b;</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=a, <span class="kw">upper</span>=b&gt; theta;</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// **wrong** needs explicit truncation</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  theta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This program is wrong because its truncation bounds on <code>theta</code> depend on parameters, and thus need to be accounted for using an explicit truncation on the distribution. This is the right way to do it.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>  theta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>) <span class="kw">T</span>[a, b];</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The conceptual issue is that the prior does not integrate to one over the admissible parameter space; it integrates to one over all real numbers and integrates to something less than one over <span class="math inline">\([a ,b]\)</span>; in these simple univariate cases, we can overcome that with the <code>T[ , ]</code> notation, which essentially divides by whatever the prior integrates to over <span class="math inline">\([a, b]\)</span>.</p>
<p>This problem is exactly the same problem as you would get using reject statements to enforce complicated inequalities on multivariate functions. In this case, it is wrong to try to deal with truncation through constraints.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (theta &lt; a || theta &gt; b) {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">reject</span>(<span class="st">"theta not in (a, b)"</span>);</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// still **wrong**, needs T[a,b]</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  theta ~ normal(<span class="dv">0</span>, <span class="dv">1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, the prior integrates to something less than one over the region of the parameter space where the complicated inequalities are satisfied. But we don’t generally know what value the prior integrates to, so we can’t increment the log probability function to compensate.</p>
<p>Even if this adjustment to a proper probability model may seem minor in particular models where the amount of truncated posterior density is negligible or constant, we can’t sample from that truncated posterior efficiently. Programs need to use one-to-one mappings that guarantee the constraints are satisfied and only use reject statements to raise errors or help with debugging.</p>


</section>
</section>
</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The current notation replaces two previous versions. Originally, a variable <code>lp__</code> was directly exposed and manipulated; this is no longer allowed. The original statement syntax for <code>target += u</code> was <code>increment_log_prob(u)</code>, but this form was removed in Stan 2.33<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Writing this model with the expression <code>-0.5 * y * y</code> is more efficient than with the equivalent expression <code>y * y / -2</code> because multiplication is more efficient than division; in both cases, the negation is rolled into the numeric literal (<code>-0.5</code> and <code>-2</code>). Writing <code>square(y)</code> instead of <code>y * y</code> would be even more efficient because the derivatives can be precomputed, reducing the memory and number of operations required for automatic differentiation.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Because <span class="math inline">\(\log | \frac{d}{dy} \log y | = \log | 1/y | = - \log |y|\)</span>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>A programming idiom in BUGS code simulates a local variable by replacing <code>theta</code> in the above example with <code>theta[n]</code>, effectively creating <code>N</code> different variables, <code>theta[1]</code>, …, <code>theta[N]</code>. Of course, this is not a hack if the value of <code>theta[n]</code> is required for all <code>n</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The adjoint component is always zero during execution for the algorithmic differentiation variables used to implement parameters, transformed parameters, and local variables in the model.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script type="text/javascript">

// replace cmd keyboard shortcut w/ control on non-Mac platforms
const kPlatformMac = typeof navigator !== 'undefined' ? /Mac/.test(navigator.platform) : false;
if (!kPlatformMac) {
   var kbds = document.querySelectorAll("kbd")
   kbds.forEach(function(kbd) {
      kbd.innerHTML = kbd.innerHTML.replace(/⌘/g, '⌃');
   });
}

// tweak headings in pymd
document.querySelectorAll(".pymd span.co").forEach(el => {
   if (!el.innerText.startsWith("#|")) {
      el.style.fontWeight = 1000;
   }
});

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../reference-manual/expressions.html" class="pagination-link" aria-label="Expressions">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Expressions</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../reference-manual/blocks.html" class="pagination-link" aria-label="Program Blocks">
        <span class="nav-page-text">Program Blocks</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/stan-dev/docs/edit/master/src/reference-manual/statements.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/stan-dev/docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>